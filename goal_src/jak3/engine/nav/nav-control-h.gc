;;-*-Lisp-*-
(in-package goal)

;; name: nav-control-h.gc
;; name in dgo: nav-control-h
;; dgos: GAME

(defenum nav-state-flag
  :type uint32
  :bitfield #t
  (display-marks      0)
  (recovery-mode      1)
  (initialized        2)
  (debug              3)
  (directional-mode   4)
  (trapped-by-sphere  5)
  (target-poly-dirty  6)
  (blocked            7)
  (in-target-poly     8)
  (at-target          9)
  (target-inside     10)
  (in-mesh           11)
  (avoiding-sphere   12)
  (touching-sphere   13)
  (at-gap            14)
  (use-position 15)
  )

(defenum nav-control-flag
  :type uint32
  :bitfield #t
  (display-marks        0) ;; 1
  (debug                1) ;; 2
  (no-redirect-in-clamp 2) ;; 4
  (limit-rotation-rate  3) ;; 8
  (update-heading-from-facing 4) ;; 16
  (use-momentum        5) ;; 32
  (momentum-ignore-heading 6) ;; 64
  (output-sphere-hash  7) ;; 128
  (kernel-run          8) ;; 256
  )

;; DECOMP BEGINS

(deftype check-vector-collision-with-nav-spheres-info (structure)
  ((u          float)
   (intersect  vector  :inline)
   (normal     vector  :inline)
   )
  )


(deftype nav-gap-info (structure)
  ((dest  vector  :inline)
   (poly  nav-poly)
   )
  )


(deftype nav-avoid-spheres-params (structure)
  ((current-pos           vector  :inline)
   (travel                vector  :inline)
   (pref-dir              vector  :inline)
   (out-travel            vector  2 :inline)
   (closest-sphere-dist2  float)
   (avoiding-sphere?      symbol)
   )
  )


(deftype nav-callback-info (structure)
  ((callback-count  int32)
   (callback-array  (function object nav-control none)  10)
   )
  )


(deftype nav-state (structure)
  ((flags                      nav-state-flag)
   (nav                        nav-control)
   (user-poly                  nav-poly)
   (mesh                       nav-mesh)
   (current-poly               nav-poly)
   (virtual-current-poly       nav-poly)
   (next-poly                  nav-poly)
   (target-poly                nav-poly)
   (rotation-rate              float)
   (speed                      meters)
   (prev-speed                 meters)
   (pad0                       uint32  1)
   (travel                     vector  :inline)
   (target-pos                 vector  :inline)
   (current-pos                vector  :inline)
   (current-pos-local          vector  :inline)
   (virtual-current-pos-local  vector  :inline)
   (velocity                   vector  :inline)
   (heading                    vector  :inline)
   (target-dir                 vector  :inline)
   (accel                      vector  :inline :overlay-at target-dir)
   (user-position              vector  :inline :overlay-at virtual-current-pos-local)
   )
  (:methods
    (nav-state-method-9 () none)
    (nav-state-method-10 () none)
    (nav-state-method-11 () none)
    (nav-state-method-12 () none)
    (nav-state-method-13 () none)
    (nav-state-method-14 () none)
    (nav-state-method-15 () none)
    (nav-state-method-16 () none)
    (nav-state-method-17 () none)
    (nav-state-method-18 () none)
    (nav-state-method-19 () none)
    (nav-state-method-20 () none)
    (nav-state-method-21 () none)
    (nav-state-method-22 () none)
    (nav-state-method-23 () none)
    (nav-state-method-24 () none)
    (nav-state-method-25 () none)
    (nav-state-method-26 () none)
    (nav-state-method-27 () none)
    (nav-state-method-28 () none)
    (nav-state-method-29 () none)
    (nav-state-method-30 () none)
    (nav-state-method-31 () none)
    (nav-state-method-32 () none)
    (nav-state-method-33 () none)
    (nav-state-method-34 () none)
    (nav-state-method-35 () none)
    (nav-state-method-36 () none)
    (nav-state-method-37 () none)
    (nav-state-method-38 () none)
    (nav-state-method-39 () none)
    (nav-state-method-40 () none)
    (nav-state-method-41 () none)
    (nav-state-method-42 () none)
    (nav-state-method-43 () none)
    (nav-state-method-44 () none)
    (nav-state-method-45 () none)
    (nav-state-method-46 () none)
    (nav-state-method-47 () none)
    (nav-state-method-48 () none)
    (nav-state-method-49 () none)
    (nav-state-method-50 () none)
    (nav-state-method-51 () none)
    (nav-state-method-52 () none)
    (nav-state-method-53 () none)
    (nav-state-method-54 () none)
    (nav-state-method-55 () none)
    )
  )


(deftype nav-control (structure)
  ((flags                 nav-control-flag)
   (callback-info         nav-callback-info)
   (process               process)
   (pad0                  uint32)
   (shape                 collide-shape)
   (nearest-y-threshold   meters)
   (nav-cull-radius       meters)
   (sec-per-frame         float)
   (target-speed          meters)
   (acceleration          meters)
   (turning-acceleration  meters)
   (max-rotation-rate     float)
   (speed-scale           float)
   (sphere-count          int32)
   (sphere-array          (inline-array sphere))
   (root-sphere-id        uint8)
   (sphere-mask           uint8)
   (pad1                  uint8      2)
   (sphere-id-array       uint8      16)
   (extra-nav-sphere      vector     :inline)
   (root-nav-sphere       vector     :inline)
   (state                 nav-state  :inline)
   (mesh                  basic      :overlay-at (-> state mesh))
   )
  (:methods
    (nav-control-method-9 () none)
    (nav-control-method-10 () none)
    (find-poly-containing-point-1 (_type_ vector) nav-poly)
    (nav-control-method-12 () none)
    (nav-control-method-13 () none)
    (nav-control-method-14 () none)
    (nav-control-method-15 () none)
    (nav-control-method-16 () none)
    (nav-control-method-17 () none)
    (nav-control-method-18 () none)
    (nav-control-method-19 () none)
    (nav-control-method-20 () none)
    (nav-control-method-21 () none)
    (nav-control-method-22 () none)
    (nav-control-method-23 () none)
    (nav-control-method-24 () none)
    (nav-control-method-25 () none)
    (nav-control-method-26 () none)
    (nav-control-method-27 () none)
    (nav-control-method-28 () none)
    (nav-control-method-29 () none)
    (nav-control-method-30 () none)
    (nav-control-method-31 () none)
    (nav-control-method-32 () none)
    (nav-control-method-33 () none)
    (nav-control-method-34 () none)
    (nav-control-method-35 () none)
    (nav-control-method-36 () none)
    (nav-control-method-37 () none)
    (nav-control-method-38 () none)
    (nav-control-method-39 () none)
    (nav-control-method-40 () none)
    (nav-control-method-41 () none)
    (nav-control-method-42 () none)
    (nav-control-method-43 () none)
    (nav-control-method-44 () none)
    (nav-control-method-45 () none)
    (nav-control-method-46 () none)
    )
  )
