;;-*-Lisp-*-
(in-package goal)

;; name: sky-h.gc
;; name in dgo: sky-h
;; dgos: GAME

(define-extern close-sky-buffer (function dma-buffer none))

;; DECOMP BEGINS

(deftype sky-color-hour (structure)
  ((snapshot1    int32)
   (snapshot2    int32)
   (morph-start  float)
   (morph-end    float)
   )
  )


(deftype sky-color-day (structure)
  ((hour  sky-color-hour  24 :inline)
   )
  )


(deftype sky-sun-data (structure)
  ((data            uint128  4)
   (pos             vector   :inline :overlay-at (-> data 0))
   (r-sun           float            :overlay-at (-> data 1))
   (r-halo          float            :offset  20)
   (r-aurora        float            :offset  24)
   (c-sun-start     rgba             :overlay-at (-> data 2))
   (c-sun-end       rgba             :overlay-at (-> data 3))
   (c-halo-start    rgba             :offset  36)
   (c-halo-end      rgba             :offset  52)
   (c-aurora-start  rgba             :offset  40)
   (c-aurora-end    rgba             :offset  56)
   )
  )


(deftype sky-moon-data (structure)
  ((data   uint128  2)
   (pos    vector   :inline :overlay-at (-> data 0))
   (scale  vector   :inline :overlay-at (-> data 1))
   )
  )


(deftype sky-orbit (structure)
  ((high-noon  float)
   (tilt       float)
   (rise       float)
   (dist       float)
   (min-halo   float)
   (max-halo   float)
   )
  :allow-misaligned
  )


(deftype sky-upload-data (structure)
  ((data      uint128        16)
   (sun       sky-sun-data   2 :inline :overlay-at (-> data 0))
   (moon      sky-moon-data  :inline   :overlay-at (-> data 8))
   (day-star  sky-moon-data  :inline   :overlay-at (-> data 12))
   )
  )


(deftype sky-vertex (structure)
  ((pos  vector  :inline)
   (stq  vector  :inline)
   (col  vector  :inline)
   )
  )



(deftype cloud-vertex (structure)
  ((pos   vector  :inline)
   (stq   vector  :inline)
   (col   vector  :inline)
   (nrm   vector  :inline)
   (stq2  vector  :inline)
   (col2  vector  :inline)
   (nrm2  vector  :inline)
   )
  )


(deftype cloud-vert-array (structure)
  ((data  cloud-vertex  100 :inline)
   )
  )


(deftype haze-vertex (structure)
  ((pos  vector  :inline)
   (nrm  vector  :inline)
   (col  vector  :inline)
   )
  )


(deftype haze-vert-array (structure)
  ((data  haze-vertex  36 :inline)
   )
  )


(deftype cloud-lights (structure)
  ((sun0-normal       vector  :inline)
   (sun1-normal       vector  :inline)
   (moon-normal       vector  :inline)
   (ambi-color        vector  :inline)
   (ambi-color-lower  vector  :inline)
   (sun0-color        vector  :inline)
   (sun1-color        vector  :inline)
   (moon-color        vector  :inline)
   (sun0-color-lower  vector  :inline)
   (sun0-scale        float)
   (sun1-scale        float)
   (moon-scale        float)
   )
  )


(deftype haze-lights (structure)
  ((sun0-normal  vector  :inline)
   (sun1-normal  vector  :inline)
   (moon-normal  vector  :inline)
   (ambi-color   vector  :inline)
   (sun0-color   vector  :inline)
   (sun1-color   vector  :inline)
   (moon-color   vector  :inline)
   (sun0-scale   float)
   (sun1-scale   float)
   (moon-scale   float)
   )
  )


(deftype sky-work (structure)
  ((adgif-tmpl        dma-gif-packet   :inline)
   (draw-tmpl         dma-gif-packet   :inline)
   (draw-tmpl2        dma-gif-packet   :inline)
   (fog-tmpl          dma-gif-packet   :inline)
   (blend-tmpl        dma-gif-packet   :inline)
   (sprite-tmpl       dma-gif-packet   :inline)
   (sprite-tmpl2      dma-gif-packet   :inline)
   (sun-coords        vector           2 :inline)
   (green-coords      vector           2 :inline)
   (moon0-coords      vector           2 :inline)
   (moon1-coords      vector           2 :inline)
   (moon2-coords      vector           2 :inline)
   (day-star-coords   vector           2 :inline)
   (star-coords       vector           2 :inline)
   (sun-colors        vector4w         2 :inline)
   (green-colors      vector4w         2 :inline)
   (moon-colors       vector4w         3 :inline)
   (day-star-colors   vector4w         3 :inline)
   (star-colors       vector4w         16 :inline)
   (st-coords         vector           2 :inline)
   (random            vector4w         8 :inline)
   (giftag-base       dma-gif          :inline)
   (giftag-haze       dma-gif          :inline)
   (giftag-roof       dma-gif          :inline)
   (giftag-ocean      dma-gif          :inline)
   (fog               vector           :inline)
   (sky               float            8)
   (time              float)
   (off-s             uint16)
   (off-t             uint16)
   (orbit             sky-orbit        3 :inline)
   (upload-data       sky-upload-data  :inline)
   (ambi-color        vector           :inline)
   (ambi-color-lower  vector           :inline)
   (sun0-color        vector           :inline)
   (sun1-color        vector           :inline)
   (moon-color        vector           :inline)
   (sun0-color-lower  vector           :inline)
   (cam-mat           matrix           :inline)
   (star-mat          matrix           :inline)
   (vec0              vector4w         :inline)
   (vec1              vector4w         :inline)
   (cloud-lights      cloud-lights     :inline)
   (haze-lights       haze-lights      :inline)
   (buf               dma-buffer)
   (draw-vortex       basic)
   (day-star-scale    float)
   (stars             vector           512 :inline)
   (disable-day-star  basic)
   )
  (:methods
    (sky-work-method-9 () none)
    (sky-work-method-10 () none)
    (sky-work-method-11 () none)
    (sky-work-method-12 () none)
    (sky-work-method-13 () none)
    (sky-work-method-14 () none)
    (sky-work-method-15 () none)
    (sky-work-method-16 () none)
    (sky-work-method-17 () none)
    (sky-work-method-18 () none)
    (sky-work-method-19 () none)
    (sky-work-method-20 () none)
    (sky-work-method-21 () none)
    (sky-work-method-22 () none)
    (sky-work-method-23 () none)
    (sky-work-method-24 () none)
    (sky-work-method-25 () none)
    (sky-work-method-26 () none)
    (sky-work-method-27 () none)
    (sky-work-method-28 () none)
    (sky-work-method-29 () none)
    (sky-work-method-30 () none)
    (sky-work-method-31 () none)
    (sky-work-method-32 () none)
    (sky-work-method-33 () none)
    (sky-work-method-34 () none)
    (sky-work-method-35 () none)
    (sky-work-method-36 () none)
    (sky-work-method-37 () none)
    (sky-work-method-38 () none)
    )
  )

(define-extern *sky-work* sky-work)
