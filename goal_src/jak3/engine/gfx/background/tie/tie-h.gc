;;-*-Lisp-*-
(in-package goal)

;; name: tie-h.gc
;; name in dgo: tie-h
;; dgos: GAME

(declare-type prototype-tie-work structure)
(declare-type instance-tie-work structure)
(declare-type drawable-tree-instance-tie structure)
(define-extern *prototype-tie-work* prototype-tie-work)
(define-extern *instance-tie-work* instance-tie-work)
(define-extern tie-scissor-make-perspective-matrix (function matrix matrix none))
(define-extern draw-drawable-tree-instance-tie (function drawable-tree-instance-tie level none))

;; DECOMP BEGINS

(deftype tie-fragment-debug (structure)
  "Optional debug information about a tie-fragment."
  ((num-tris     uint16)
   (num-dverts   uint16)
   (debug-lines  (array vector-array))
   )
  )


(deftype tie-fragment (drawable)
  "A mesh fragment of a TIE. This is a chunk of mesh that is rendered by VU1, stored as DMA chains."
  ((gif-ref        (inline-array adgif-shader)  :overlay-at id)
   (point-ref      uint32                       :offset   8)
   (color-index    uint16                       :offset  12)
   (base-colors    uint8                        :offset  14)
   (tex-count      uint16                       :offset  32)
   (gif-count      uint16                       :offset  34)
   (vertex-count   uint16                       :offset  36)
   (color-count    uint16)
   (dp-ref         uint32)
   (dp-qwc         uint32)
   (generic-ref    uint32)
   (generic-count  uint16)
   (normal-count   uint16)
   (normal-ref     uint32)
   (debug          tie-fragment-debug)
   )
  )


(deftype instance-tie (instance)
  "A TIE model instance."
  ((color-indices  uint32                :offset   8)
   (bucket-ptr     prototype-bucket-tie  :offset  12)
   (max-scale      uint16                :overlay-at (-> origin data 3))
   (rmin-scale     uint16                :overlay-at (-> origin data 11))
   )
  )


(deftype drawable-inline-array-instance-tie (drawable-inline-array)
  "Array of tie instances stored in the level."
  ((data  instance-tie  1 :inline)
   (pad   uint32)
   )
  )

(deftype drawable-tree-instance-tie (drawable-tree)
  "Top-level drawable-tree for TIEs"
  ((prototypes  proxy-prototype-array-tie  :offset   8)
   )
  )


(deftype prototype-tie (drawable-inline-array)
  "Prototype for a TIE: just an array of fragments."
  ((data  tie-fragment  1 :inline)
   (pad   uint32)
   )
  )

(deftype tie-matrix (structure)
  "Per-instance matrix for TIE VU1 rendering."
  ((mat           matrix  :inline)
   (morph         qword   :inline)
   (fog           qword   :inline)
   (envmap-flag   uint32  :overlay-at (-> fog data 0))
   (guard-flag    uint32  :overlay-at (-> fog data 1))
   (vertex-alpha  float   :overlay-at (-> fog data 2))
   (fog-value     float   :overlay-at (-> fog data 3))
   (fixed-alpha   float   :overlay-at (-> morph data 1))
   )
  )


(deftype instance-tie-work (structure)
  "workspace for TIE instance DMA generation"
  ((wind-const                      vector      :inline)
   (hmge-d                          vector      :inline)
   (hvdf-offset                     vector      :inline)
   (wind-force                      vector      :inline)
   (constant                        vector      :inline)
   (far-morph                       vector      :inline)
   (dist-test                       vector      :inline)
   (min-dist                        vector      :inline)
   (guard-plane                     plane       4 :inline)
   (upload-color-0                  dma-packet  :inline)
   (upload-color-1                  dma-packet  :inline)
   (upload-color-2                  dma-packet  :inline)
   (upload-color-ret                dma-packet  :inline)
   (upload-color-temp               dma-packet  :inline)
   (generic-color-0                 dma-packet  :inline)
   (generic-color-1                 dma-packet  :inline)
   (generic-color-end               dma-packet  :inline)
   (envmap-color-0                  dma-packet  :inline)
   (envmap-color-1                  dma-packet  :inline)
   (tie-scissor-perspective-matrix  matrix      :inline)
   (tod-env-color                   vector      :inline)
   (morph-temp                      vector      :inline)
   (fog-temp                        vector      :inline)
   (fade-temp                       float)
   (wind-vectors                    uint32)
   (test-id                         uint32)
   (test-id2                        uint32)
   (dma-buffer                      basic)
   (to-spr                          uint32)
   (from-spr                        uint32)
   (wind-work                       uint32)
   (cur-vis-bits                    uint32)
   (end-vis-bits                    uint32)
   (refl-fade-fac                   float)
   (refl-fade-end                   float)
   (flags                           uint32)
   (vanish-flag                     uint32)
   (translucent-flag                uint32)
   (wait-from-spr                   uint32)
   (wait-to-spr                     uint32)
   (use-etie                        symbol)
   (buffer-start                    uint32)
   (buffer-end                      uint32)
   (tfrag-dists                     uint32)
   (alpha-dists                     uint32)
   (water-dists                     uint32)
   )
  )


(deftype instance-tie-dma (structure)
  "Scratchpad memory layout for TIE instance DMA generation."
  ((banka  instance-tie       32 :inline)
   (bankb  instance-tie       32 :inline)
   (outa   uint128            256)
   (outb   uint128            256)
   (work   instance-tie-work  :dynamic)
   )
  )


(deftype prototype-tie-work (structure)
  "workspace for TIE protype DMA generation."
  ((upload-flushe               dma-packet  :inline)
   (upload-palette              dma-packet  :inline)
   (upload-model-0              dma-packet  :inline)
   (upload-model-1              dma-packet  :inline)
   (upload-model-2              dma-packet  :inline)
   (upload-model-3              dma-packet  :inline)
   (upload-model-near-0         dma-packet  :inline)
   (upload-model-near-1         dma-packet  :inline)
   (upload-model-near-2         dma-packet  :inline)
   (upload-model-near-3         dma-packet  :inline)
   (upload-model-near-4         dma-packet  :inline)
   (envmap-palette              dma-packet  :inline)
   (envmap-shader               dma-packet  :inline)
   (upload-envmap-0             dma-packet  :inline)
   (upload-envmap-1             dma-packet  :inline)
   (upload-envmap-2             dma-packet  :inline)
   (upload-envmap-3             dma-packet  :inline)
   (upload-envmap-4             dma-packet  :inline)
   (upload-envmap-scissor-4     dma-packet  :inline)
   (generic-palette             dma-packet  :inline)
   (generic-model-0             dma-packet  :inline)
   (generic-model-1             dma-packet  :inline)
   (generic-model-2             dma-packet  :inline)
   (model-next                  dma-packet  :inline)
   (clamp                       uint64)
   (prototype-array             basic)
   (wait-from-spr               uint32)
   (wait-to-spr                 uint32)
   (mood                        mood-context)
   (last                        uint32      16 :offset 416)
   (next                        uint32      16)
   (count                       uint16      16)
   (tie-last                    uint32         :overlay-at (-> last 0))
   (tie-next                    uint32         :overlay-at (-> next 0))
   (tie-count                   uint16         :overlay-at (-> count 0))
   (trans-last                  uint32         :overlay-at (-> last 1))
   (trans-next                  uint32         :overlay-at (-> next 1))
   (trans-count                 uint16         :overlay-at (-> count 1))
   (water-last                  uint32         :overlay-at (-> last 2))
   (water-next                  uint32         :overlay-at (-> next 2))
   (water-count                 uint16         :overlay-at (-> count 2))
   (scissor-last                uint32         :overlay-at (-> last 3))
   (scissor-next                uint32         :overlay-at (-> next 3))
   (scissor-count               uint16         :overlay-at (-> count 3))
   (scissor-trans-last          uint32         :overlay-at (-> last 4))
   (scissor-trans-next          uint32         :overlay-at (-> next 4))
   (scissor-trans-count         uint16         :overlay-at (-> count 4))
   (scissor-water-last          uint32         :overlay-at (-> last 5))
   (scissor-water-next          uint32         :overlay-at (-> next 5))
   (scissor-water-count         uint16         :overlay-at (-> count 5))
   (envmap-last                 uint32         :overlay-at (-> last 6))
   (envmap-next                 uint32         :overlay-at (-> next 6))
   (envmap-count                uint16         :overlay-at (-> count 6))
   (envmap-trans-last           uint32         :overlay-at (-> last 7))
   (envmap-trans-next           uint32         :overlay-at (-> next 7))
   (envmap-trans-count          uint16         :overlay-at (-> count 7))
   (envmap-water-last           uint32         :overlay-at (-> last 8))
   (envmap-water-next           uint32         :overlay-at (-> next 8))
   (envmap-water-count          uint16         :overlay-at (-> count 8))
   (envmap-scissor-last         uint32         :overlay-at (-> last 9))
   (envmap-scissor-next         uint32         :overlay-at (-> next 9))
   (envmap-scissor-count        uint16         :overlay-at (-> count 9))
   (envmap-scissor-trans-last   uint32         :overlay-at (-> last 10))
   (envmap-scissor-trans-next   uint32         :overlay-at (-> next 10))
   (envmap-scissor-trans-count  uint16         :overlay-at (-> count 10))
   (envmap-scissor-water-last   uint32         :overlay-at (-> last 11))
   (envmap-scissor-water-next   uint32         :overlay-at (-> next 11))
   (envmap-scissor-water-count  uint16         :overlay-at (-> count 11))
   (generic-last                uint32         :overlay-at (-> last 12))
   (generic-next                uint32         :overlay-at (-> next 12))
   (generic-count               uint16         :overlay-at (-> count 12))
   (generic-trans-last          uint32         :overlay-at (-> last 13))
   (generic-trans-next          uint32         :overlay-at (-> next 13))
   (generic-trans-count         uint16         :overlay-at (-> count 13))
   (generic-water-last          uint32         :overlay-at (-> last 14))
   (generic-water-next          uint32         :overlay-at (-> next 14))
   (generic-water-count         uint16         :overlay-at (-> count 14))
   (vanish-last                 uint32         :overlay-at (-> last 15))
   (vanish-next                 uint32         :overlay-at (-> next 15))
   (vanish-count                uint16         :overlay-at (-> count 15))
   )
  )


(deftype prototype-tie-dma (structure)
  ((colora                rgba     256)
   (colorb                rgba     256)
   (outa                  uint128  256)
   (outb                  uint128  256)
   (geometry              uint32   4)
   (next                  uint32   12)
   (count                 uint16   12)
   (counts                uint32   4)
   (palette-ptr           uint32     :overlay-at (-> counts 2))
   (model-ptr             uint32     :overlay-at (-> counts 3))
   (ret-ptr               uint32)
   (length                uint32)
   (flags                 uint32)
   (dma-buffer            basic)
   (this-frag-count       uint32)
   (frag-count            uint8    4)
   (from-spr              uint32)
   (to-spr                uint32)
   (spr-out               uint32)
   (this-count            uint32)
   (scissor-geometry      uint32     :overlay-at (-> geometry 0))
   (near-geometry         uint32     :overlay-at (-> geometry 1))
   (mid-geometry          uint32     :overlay-at (-> geometry 2))
   (far-geometry          uint32     :overlay-at (-> geometry 3))
   (scissor-frag-count    uint8      :overlay-at (-> frag-count 0))
   (near-frag-count       uint8      :overlay-at (-> frag-count 1))
   (mid-frag-count        uint8      :overlay-at (-> frag-count 2))
   (far-frag-count        uint8      :overlay-at (-> frag-count 3))
   (tie-scissor-next      uint32     :overlay-at (-> next 0))
   (tie-near-next         uint32     :overlay-at (-> next 1))
   (tie-mid-next          uint32     :overlay-at (-> next 2))
   (tie-far-next          uint32     :overlay-at (-> next 3))
   (trans-scissor-next    uint32   4 :overlay-at (-> next 0))
   (trans-near-next       uint32     :overlay-at (-> next 1))
   (trans-mid-next        uint32     :overlay-at (-> next 2))
   (trans-far-next        uint32     :overlay-at (-> next 3))
   (water-scissor-next    uint32   4 :overlay-at (-> next 0))
   (water-near-next       uint32     :overlay-at (-> next 1))
   (water-mid-next        uint32     :overlay-at (-> next 2))
   (water-far-next        uint32     :overlay-at (-> next 3))
   (envmap-scissor-next   uint32   4 :overlay-at (-> next 4))
   (envmap-near-next      uint32     :overlay-at (-> next 5))
   (envmap-mid-next       uint32     :overlay-at (-> next 6))
   (envmap-far-next       uint32     :overlay-at (-> next 7))
   (generic-near-next     uint32     :overlay-at (-> next 8))
   (generic-mid-next      uint32     :overlay-at (-> next 9))
   (generic-far-next      uint32     :overlay-at (-> next 10))
   (vanish-next           uint32     :overlay-at (-> next 11))
   (tie-count             uint16     :overlay-at (-> count 0))
   (tie-scissor-count     uint16     :overlay-at (-> count 0))
   (tie-near-count        uint16     :overlay-at (-> count 1))
   (tie-mid-count         uint16     :overlay-at (-> count 2))
   (tie-far-count         uint16     :overlay-at (-> count 3))
   (trans-count           uint16     :overlay-at (-> count 0))
   (trans-scissor-count   uint16     :overlay-at (-> count 0))
   (trans-near-count      uint16     :overlay-at (-> count 1))
   (trans-mid-count       uint16     :overlay-at (-> count 2))
   (trans-far-count       uint16     :overlay-at (-> count 3))
   (water-count           uint16     :overlay-at (-> count 0))
   (water-scissor-count   uint16     :overlay-at (-> count 0))
   (water-near-count      uint16     :overlay-at (-> count 1))
   (water-mid-count       uint16     :overlay-at (-> count 2))
   (water-far-count       uint16     :overlay-at (-> count 3))
   (envmap-count          uint16     :overlay-at (-> count 4))
   (envmap-scissor-count  uint16     :overlay-at (-> count 4))
   (envmap-near-count     uint16     :overlay-at (-> count 5))
   (envmap-mid-count      uint16     :overlay-at (-> count 6))
   (envmap-far-count      uint16     :overlay-at (-> count 7))
   (generic-count         uint16     :overlay-at (-> count 8))
   (generic-near-count    uint16     :overlay-at (-> count 8))
   (generic-mid-count     uint16     :overlay-at (-> count 9))
   (generic-far-count     uint16     :overlay-at (-> count 10))
   (vanish-count          uint16     :overlay-at (-> count 11))
   (next-clear            uint32   3 :overlay-at (-> next 0))
   (count-clear           uint16   3 :overlay-at (-> count 0))
   )
  )


(define *instance-tie-work-copy* (the-as instance-tie-work #f))
