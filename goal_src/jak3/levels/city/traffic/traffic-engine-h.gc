;;-*-Lisp-*-
(in-package goal)

;; name: traffic-engine-h.gc
;; name in dgo: traffic-engine-h
;; dgos: DESRESC, HGA, WWD, CWI, LFACTORY

(declare-type squad-control basic)
(declare-type traffic-find-segment-struct structure)

;; +++vis-cell-flag
(defenum vis-cell-flag
  :type uint8
  :bitfield #t
  (active-vehicle 0)
  (active-pedestrian 1)
  (suppress 2)
  )
;; ---vis-cell-flag


;; +++traffic-suppression-box-flag
(defenum traffic-suppression-box-flag
  :type uint8
  :bitfield #t
  (in-use 0)
  (tfsb1 1)
  (tfsb2 2)
  (tfsb3 3)
  (tfsb4 4)
  (tfsb5 5)
  (tfsb6 6)
  (tfsb7 7)
  )
;; ---traffic-suppression-box-flag


;; +++traffic-suppressor-flag
(defenum traffic-suppressor-flag
  :type uint8
  :bitfield #t
  (tfs0 0)
  (needs-update 1)
  (tfs2 2)
  (tfs3 3)
  (tfs4 4)
  (tfs5 5)
  (tfs6 6)
  (tfs7 7)
  )
;; ---traffic-suppressor-flag


;; DECOMP BEGINS

(deftype nav-segment (structure)
  ((vertex         vector  2 :inline)
   (length         float   :overlay-at (-> vertex 0 data 3))
   (spawn-spacing  float   :offset  28)
   (branch         nav-branch)
   (nav-mesh-id    uint32)
   (id             uint16)
   (cell-id        uint16)
   (from-cell-id   uint16)
   (tracker-id     int8)
   (pad0           int8)
   )
  )


(deftype vis-cell (structure)
  ((sphere                  sphere  :inline)
   (segment-array           (inline-array nav-segment))
   (vis-id                  uint16)
   (id                      uint16)
   (incoming-segment-count  int8)
   (segment-count           int8)
   (flags                   vis-cell-flag)
   (prev-flags              vis-cell-flag)
   (alloc-segment-count     int8    :overlay-at flags)
   (nav-territories         uint32)
   )
  (:methods
    (vis-cell-method-9 () none)
    (vis-cell-method-10 () none)
    )
  )


(deftype vis-grid-pos (structure)
  ((data  int8  3)
   (x     int8  :overlay-at (-> data 0))
   (y     int8  :overlay-at (-> data 1))
   (z     int8  :overlay-at (-> data 2))
   )
  :pack-me
  )


(deftype vis-grid-box (structure)
  ((min  vis-grid-pos  :inline)
   (max  vis-grid-pos  :inline)
   )
  )


(deftype vis-ray (structure)
  ((pos       vector        :inline)
   (dir       vector        :inline)
   (dest-pos  vector        :inline)
   (plane     plane         :inline)
   (grid-pos  vis-grid-pos  :inline)
   (len       float)
   (cell      vis-cell)
   )
  )


(deftype grid-info (structure)
  ((axis-scale       float         3)
   (dimension-array  int8          3)
   (pad0             uint8         1)
   (box              bounding-box  :inline)
   (cell-size        vector        :inline)
   )
  (:methods
    (grid-info-method-9 () none)
    (grid-info-method-10 () none)
    (grid-info-method-11 () none)
    (debug-draw-grid (_type_ rgba) none)
    (debug-draw-cell (_type_ vis-grid-pos rgba) none)
    )
  )


(deftype city-level-info (structure)
  ((grid-info       grid-info  :inline)
   (cell-array      (inline-array vis-cell))
   (segment-count   int16)
   (cell-count      uint16)
   (segment-array   (inline-array nav-segment))
   (nav-graph       nav-graph)
   (camera-ceiling  meters)
   (pad-array       int8       56)
   )
  (:methods
    (city-level-info-method-9 () none)
    (city-level-info-method-10 () none)
    (city-level-info-method-11 () none)
    (city-level-info-method-12 () none)
    (city-level-info-method-13 () none)
    (city-level-info-method-14 () none)
    (city-level-info-method-15 () none)
    (city-level-info-method-16 () none)
    (city-level-info-method-17 () none)
    (city-level-info-method-18 () none)
    )
  )


(deftype traffic-level-data (structure)
  ((city-info                city-level-info)
   (active-cell-count        uint8)
   (newly-active-cell-count  uint8)
   (active-cell-list         vis-cell      255)
   (newly-active-cell-list   vis-cell      255)
   (active-cell-box          bounding-box  :inline)
   )
  (:methods
    (traffic-level-data-method-9 () none)
    (traffic-level-data-method-10 () none)
    (traffic-level-data-method-11 () none)
    (traffic-level-data-method-12 () none)
    (traffic-level-data-method-13 () none)
    (traffic-level-data-method-14 () none)
    )
  )


(deftype traffic-suppression-box (structure)
  ((data      uint8                         32)
   (bbox      bounding-box                  :inline :overlay-at (-> data 0))
   (flags     traffic-suppression-box-flag          :overlay-at (-> data 12))
   (duration  uint32                                :overlay-at (-> data 28))
   )
  )


(deftype traffic-object-type-info (structure)
  ((flags                 uint8)
   (active-count          int8)
   (inactive-count        int8)
   (reserve-count         uint16)
   (killed-count          uint16)
   (want-count            int8)
   (tracker-index         uint8)
   (parking-spot-prob     uint8)
   (guard-type            uint8)
   (array                 (pointer handle))
   (level                 symbol)
   (target-counts         int8  3)
   (target-count          int8  :overlay-at (-> target-counts 0))
   (target-count-war      int8  :overlay-at (-> target-counts 1))
   (target-count-mission  int8  :overlay-at (-> target-counts 2))
   )
  )


(deftype traffic-suppressor (structure)
  ((flags  traffic-suppressor-flag)
   (bbox   bounding-box             :inline)
   (array  traffic-suppression-box  16 :inline)
   )
  (:methods
    (traffic-suppressor-method-9 () none)
    (traffic-suppressor-method-10 () none)
    (traffic-suppressor-method-11 () none)
    (traffic-suppressor-method-12 () none)
    (traffic-suppressor-method-13 () none)
    )
  )


(deftype traffic-tracker (structure)
  ((traffic                  traffic-engine)
   (object-hash              spatial-hash)
   (rand                     float)
   (id                       uint8)
   (active-object-count      uint8)
   (inactive-object-count    int8)
   (active-object-list       handle        126)
   (active-object-type-list  traffic-type  126)
   )
  (:methods
    (traffic-tracker-method-9 () none)
    (traffic-tracker-method-10 () none)
    (traffic-tracker-method-11 () none)
    (traffic-tracker-method-12 () none)
    (traffic-tracker-method-13 () none)
    (traffic-tracker-method-14 () none)
    (get-from-inactive-by-type (_type_ traffic-type) handle)
    (traffic-tracker-method-16 () none)
    (traffic-tracker-method-17 () none)
    (traffic-tracker-method-18 () none)
    (traffic-tracker-method-19 () none)
    (traffic-tracker-method-20 () none)
    (traffic-tracker-method-21 () none)
    (traffic-tracker-method-22 () none)
    (traffic-tracker-method-23 () none)
    (traffic-tracker-method-24 () none)
    (traffic-tracker-method-25 () none)
    (traffic-tracker-method-26 () none)
    )
  )


(deftype traffic-engine (basic)
  ((object-hash             spatial-hash)
   (manager                 handle)
   (inv-density-factor      float)
   (sync-clock              uint8)
   (sync-mask-8             uint8)
   (sync-mask-16            uint16)
   (sync-mask-32            uint32)
   (sync-array              uint8                     4)
   (flags                   uint8)
   (squad-control-array     squad-control             4)
   (level-data-array        traffic-level-data        2 :inline)
   (object-type-info-array  traffic-object-type-info  29 :inline)
   (tracker-array           traffic-tracker           2 :inline)
   (inactive-object-array   handle                    580 :offset 7456)
   (suppressor              traffic-suppressor        :inline)
   (danger-sphere-count     int8                          :offset 12656)
   (danger-sphere-array     traffic-danger-info       4 :inline)
   (allow-spawning?         symbol                        :offset 12928)
   )
  (:methods
    (new (symbol type) _type_)
    (traffic-engine-method-9 () none)
    (reset-and-init-from-manager (_type_ process) none)
    (traffic-engine-method-11 () none)
    (traffic-engine-method-12 () none)
    (traffic-engine-method-13 () none)
    (traffic-engine-method-14 () none)
    (traffic-engine-method-15 () none)
    (traffic-engine-method-16 () none)
    (traffic-engine-method-17 () none)
    (traffic-engine-method-18 () none)
    (traffic-engine-method-19 () none)
    (find-best-segment (_type_ vector vector int) nav-segment)
    (callback-on-nav-segments-in-sphere (_type_ vector int traffic-find-segment-struct (function traffic-find-segment-struct nav-segment none)) none)
    (add-danger (_type_ traffic-danger-info) none)
    (traffic-engine-method-23 () none)
    (traffic-engine-method-24 () none)
    (traffic-engine-method-25 () none)
    (traffic-engine-method-26 () none)
    (traffic-engine-method-27 () none)
    (traffic-engine-method-28 () none)
    (traffic-engine-method-29 () none)
    (traffic-engine-method-30 () none)
    (traffic-engine-method-31 () none)
    (traffic-engine-method-32 () none)
    (traffic-engine-method-33 () none)
    (traffic-engine-method-34 () none)
    (traffic-engine-method-35 () none)
    (traffic-engine-method-36 () none)
    (traffic-engine-method-37 () none)
    (traffic-engine-method-38 () none)
    (traffic-engine-method-39 () none)
    (traffic-engine-method-40 () none)
    (traffic-engine-method-41 () none)
    (traffic-engine-method-42 () none)
    (traffic-engine-method-43 () none)
    (traffic-engine-method-44 () none)
    (traffic-engine-method-45 () none)
    (traffic-engine-method-46 () none)
    (traffic-engine-method-47 () none)
    (traffic-engine-method-48 () none)
    (traffic-engine-method-49 () none)
    (traffic-engine-method-50 () none)
    (traffic-engine-method-51 () none)
    (traffic-engine-method-52 () none)
    (traffic-engine-method-53 () none)
    (traffic-engine-method-54 () none)
    (traffic-engine-method-55 () none)
    (traffic-engine-method-56 () none)
    (traffic-engine-method-57 () none)
    )
  )
