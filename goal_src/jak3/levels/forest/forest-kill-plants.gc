;;-*-Lisp-*-
(in-package goal)

;; name: forest-kill-plants.gc
;; name in dgo: forest-kill-plants
;; dgos: FRSTA

(define-extern *eco-width-curve* curve2d-fast)
(define-extern *eco-alpha-curve* curve2d-fast)
(define-extern *eco-color-curve-green* curve-color-fast)
(define-extern *eco-green-trail* light-trail-composition)

;; DECOMP BEGINS

(deftype hud-forest-plants (hud)
  ()
  )


(defmethod draw ((this hud-forest-plants))
  (set-hud-piece-position! (-> this sprites 2) (the int (+ 422.0 (* 130.0 (-> this offset)))) 160)
  (set! (-> this sprites 0 angle)
        (* 182.04445
           (the float
                (- 270
                   (/ (* 90 (the int (* 100.0 (/ (the float (-> this values 0 current)) (the float (-> this values 1 current))))))
                      100
                      )
                   )
                )
           )
        )
  (set-as-offset-from! (the-as hud-sprite (-> this sprites)) (the-as vector4w (-> this sprites 2)) 40 16)
  (set-as-offset-from! (-> this sprites 1) (the-as vector4w (-> this sprites 2)) 1 16)
  (set-as-offset-from! (-> this sprites 3) (the-as vector4w (-> this sprites 2)) 8 2)
  (let ((f30-1
          (the float
               (+ (the int (* 127.0 (sin (* 182.04445 (the float (* (-> *display* game-clock frame-counter) 2)))))) 127)
               )
          )
        )
    (set! (-> this sprites 1 color x) (the int (lerp-scale 96.0 128.0 f30-1 0.0 255.0)))
    (set! (-> this sprites 1 color y) (the int (lerp-scale 128.0 128.0 f30-1 0.0 255.0)))
    (set! (-> this sprites 1 color z) (the int (lerp-scale 128.0 128.0 f30-1 0.0 255.0)))
    )
  (when (>= 10 (-> this values 0 current))
    (format (clear (-> this strings 0 text)) "~D" (-> this values 0 current))
    (set-as-offset-from! (the-as hud-sprite (-> this strings 0 pos)) (the-as vector4w (-> this sprites 3)) 20 62)
    )
  ((method-of-type hud draw) this)
  0
  (none)
  )

(defmethod update-values! ((this hud-forest-plants))
  (set! (-> this values 0 target) (the int (-> *game-info* counter)))
  (set! (-> this values 1 target) (the int (-> *game-info* goal)))
  ((method-of-type hud update-values!) this)
  0
  (none)
  )

(defmethod init-callback ((this hud-forest-plants))
  (set! (-> this gui-id)
        (add-process *gui-control* this (gui-channel hud-upper-left) (gui-action hidden) (-> this name) 81920.0 0)
        )
  (logior! (-> this flags) (hud-flags show))
  (set! (-> this sprites 0 tid) (the-as texture-id (get-texture hud-transparent-01 level-default-minimap)))
  (set! (-> this sprites 0 scale-x) 12.0)
  (set! (-> this sprites 0 scale-y) 11.2)
  (set! (-> this sprites 0 pos z) #xfffff2)
  (set! (-> this sprites 1 tid) (the-as texture-id (get-texture hud-purple-bar-01 foresta-minimap)))
  (set! (-> this sprites 1 pos z) #xfffff0)
  (set! (-> this sprites 2 tid) (the-as texture-id (get-texture hud-npcring-01 level-default-minimap)))
  (set! (-> this sprites 2 pos z) #xffffff)
  (set! (-> this sprites 3 tid) (the-as texture-id (get-texture hud-dark-eco-plant foresta-minimap)))
  (set! (-> this sprites 3 scale-x) 1.0)
  (set! (-> this sprites 3 scale-y) 1.4)
  (set! (-> this sprites 3 pos z) #xffffff)
  (alloc-string-if-needed this 0)
  (set! (-> this strings 0 scale) 1.0)
  (set! (-> this strings 0 flags) (font-flags kerning middle large))
  0
  (none)
  )

(deftype hud-green-eco-gauge (hud)
  ()
  )


(defmethod draw ((this hud-green-eco-gauge))
  (set-hud-piece-position! (-> this sprites 1) 256 (- 40 (the int (* 50.0 (-> this offset)))))
  (set-as-offset-from! (the-as hud-sprite (-> this sprites)) (the-as vector4w (-> this sprites 1)) -55 -5)
  (set! (-> this sprites 0 pos z) #xfffff1)
  (set! (-> this sprites 1 pos z) #xfffff2)
  (let ((f0-5 (if *target*
                  (/ (-> *target* fact eco-green) (-> *target* fact eco-green-max))
                  0.0
                  )
              )
        )
    (set! (-> this sprites 0 color x) 0)
    (set! (-> this sprites 0 color y) (the int (+ 170.0 (* 85.0 f0-5))))
    (set! (-> this sprites 0 color z) 0)
    (set! (-> this sprites 0 color w) 48)
    (set! (-> this sprites 0 scale-x) (* 28.0 f0-5))
    )
  ((method-of-type hud draw) this)
  0
  (none)
  )

(defmethod update-values! ((this hud-green-eco-gauge))
  (logclear! (-> this flags) (hud-flags disable))
  ((method-of-type hud update-values!) this)
  0
  (none)
  )

(defmethod init-callback ((this hud-green-eco-gauge))
  (set! (-> this level) (level-get *level* 'wasall))
  (set! (-> this gui-id)
        (add-process *gui-control* this (gui-channel hud-upper-center-2) (gui-action hidden) (-> this name) 81920.0 0)
        )
  (logior! (-> this flags) (hud-flags show))
  (set! (-> this sprites 0 tid) (the-as texture-id (get-texture common-white common)))
  (set! (-> this sprites 0 flags) (hud-sprite-flags))
  (set! (-> this sprites 0 scale-x) 0.0)
  (set! (-> this sprites 0 scale-y) 2.75)
  (set! (-> this sprites 1 tid)
        (the-as texture-id (lookup-texture-by-id (new 'static 'texture-id :index #x1 :page #x962)))
        )
  (set! (-> this sprites 1 flags) (hud-sprite-flags hsf3))
  (set! (-> this sprites 1 scale-x) 1.0)
  (set! (-> this sprites 1 scale-y) 1.0)
  0
  (none)
  )

(if #t
    (set! *eco-width-curve* (new 'static 'curve2d-fast
                              :xs (new 'static 'vector :y -0.45 :z -0.65 :w -1.0)
                              :ys (new 'static 'vector :x 0.25 :y 1.0 :z 1.35 :w 0.75)
                              :one-over-x-deltas (new 'static 'vector :x 1.6666667 :y 1.7500002 :z -1.7142856 :w 1.0)
                              )
          )
    )

(if #t
    (set! *eco-alpha-curve* (new 'static 'curve2d-fast
                              :xs (new 'static 'vector :y -0.85 :z -1.0 :w -2.0)
                              :ys (new 'static 'vector :x 1.0 :w 1.0)
                              :one-over-x-deltas (new 'static 'vector :x -1.1764705 :z 1.0 :w 1.0)
                              )
          )
    )

(if #t
    (set! *eco-color-curve-green* (new 'static 'curve-color-fast
                                    :xs (new 'static 'vector :y -1.0 :z -2.0 :w -3.0)
                                    :ys (new 'static 'inline-array vector 4
                                      (new 'static 'vector :y 1.0 :w 128.0)
                                      (new 'static 'vector :y 1.0 :w 128.0)
                                      (new 'static 'vector :y 1.0 :w 128.0)
                                      (new 'static 'vector :y 1.0 :w 128.0)
                                      )
                                    :one-over-x-deltas (new 'static 'vector :x 1.0 :y 1.0 :z 1.0 :w 1.0)
                                    )
          )
    )

(if (or (zero? *eco-green-trail*) (!= loading-level global))
    (set! *eco-green-trail* (new 'loading-level 'light-trail-composition))
    )

(set! (-> *eco-green-trail* color-mode) (the-as uint 0))

(set! (-> *eco-green-trail* color-repeat-dist) 4096.0)

(set! (-> *eco-green-trail* alpha-1-mode) (the-as uint 0))

(set! (-> *eco-green-trail* alpha-2-mode) (the-as uint 1))

(set! (-> *eco-green-trail* base-alpha) 1.0)

(set! (-> *eco-green-trail* alpha-repeat-dist) 32768.0)

(set! (-> *eco-green-trail* width-mode) (the-as uint 0))

(set! (-> *eco-green-trail* base-width) 14336.0)

(set! (-> *eco-green-trail* width-repeat-dist) 4096.0)

(set! (-> *eco-green-trail* uv-mode) (the-as uint 3))

(set! (-> *eco-green-trail* uv-repeat-dist) 102399.99)

(set! (-> *eco-green-trail* lie-mode) (lie-mode use-two-strips))

(set! (-> *eco-green-trail* max-age) (seconds 2))

(if #f
    (set! (-> *eco-green-trail* tex-id) (lookup-texture-id-by-name (the-as string #f) (the-as string #f)))
    (set! (-> *eco-green-trail* tex-id) (new 'static 'texture-id :index #x8 :page #x5))
    )

(set! (-> *eco-green-trail* width-curve) (the-as curve2d-piecewise *eco-width-curve*))

(set! (-> *eco-green-trail* color-curve) (the-as curve-color-piecewise *eco-color-curve-green*))

(set! (-> *eco-green-trail* alpha-curve-1) (the-as curve2d-piecewise *eco-alpha-curve*))

(set! (-> *eco-green-trail* alpha-curve-2) (the-as curve2d-piecewise *curve-linear-up*))

(set! (-> *eco-green-trail* zbuffer?) #f)

(set! (-> *eco-green-trail* lie-vector quad) (-> *up-vector* quad))

(set! (-> *eco-green-trail* use-tape-mode?) #f)

(set! (-> *eco-green-trail* blend-mode) (the-as uint 1))

(set! (-> *eco-green-trail* frame-stagger) (the-as uint 1))

(deftype eco-green-trail-tracker (light-trail-tracker)
  ()
  )


;; WARN: Return type mismatch object vs symbol.
(defmethod should-track? ((this eco-green-trail-tracker) (arg0 process-focusable))
  (the-as symbol (and *target* (focus-test? *target* board) (< 0.0 (-> *target* fact eco-green))))
  )

(defmethod get-tracked-object-pos ((this eco-green-trail-tracker) (arg0 process-focusable) (arg1 vector))
  (if *target*
      (vector<-cspace! arg1 (-> *target* node-list data 37))
      )
  arg1
  )

(deftype task-manager-forest-plants (task-manager)
  ((plant-manager-entity  entity)
   (actor-group           (pointer actor-group))
   (actor-group-count     int32)
   (plants                (array entity-actor))
   (check-timer           time-frame)
   (displayed-hint?       symbol)
   (trail-handle          handle)
   (hud-green-eco         handle  :overlay-at (-> hud 2))
   (updated-minimap?      symbol)
   (cam-setting-timer     time-frame)
   )
  (:methods
    (init-actor-group! (_type_) none)
    )
  )


(defmethod taskman-event-handler ((this task-manager-forest-plants) (arg0 process) (arg1 int) (arg2 symbol) (arg3 event-message-block))
  (local-vars (v0-0 object))
  (case arg2
    (('displayed-hint?)
     (if (-> arg3 param 0)
         (set! (-> this displayed-hint?) #t)
         )
     (-> this displayed-hint?)
     )
    (('string-max-height)
     (set-setting! 'string-max-height 'abs (-> arg3 param 0) 0)
     (set-setting! 'string-min-height 'abs (-> arg3 param 0) 0)
     (set! v0-0 (current-time))
     (set! (-> this cam-setting-timer) (the-as time-frame v0-0))
     v0-0
     )
    (('string-max-length)
     (set-setting! 'string-max-length 'abs (-> arg3 param 0) 0)
     (set-setting! 'string-min-length 'abs (-> arg3 param 0) 0)
     (set! v0-0 (current-time))
     (set! (-> this cam-setting-timer) (the-as time-frame v0-0))
     v0-0
     )
    (('mh-plant-death)
     (when (< 1.0 (-> *game-info* counter))
       (let ((a0-10 (handle->process (-> this arrow))))
         (when a0-10
           (send-event a0-10 'die)
           (set! (-> this arrow) (the-as handle #f))
           #f
           )
         )
       )
     )
    (else
      ((method-of-type task-manager taskman-event-handler) this arg0 arg1 arg2 arg3)
      )
    )
  )

(defmethod task-manager-method-26 ((this task-manager-forest-plants))
  (let ((t9-0 (method-of-type task-manager task-manager-method-26)))
    (t9-0 this)
    )
  (when (and (nonzero? (-> this cam-setting-timer)) (time-elapsed? (-> this cam-setting-timer) (seconds 1)))
    (set-setting! 'string-min-length 'abs (meters 8) 0)
    (set-setting! 'string-max-length 'abs (meters 14) 0)
    (set-setting! 'string-min-height 'abs (meters 4) 0)
    (set-setting! 'string-max-height 'abs (meters 8) 0)
    (set! (-> this cam-setting-timer) 0)
    0
    )
  (when (time-elapsed? (-> this check-timer) (seconds 0.1))
    (if (not (-> this plant-manager-entity))
        (init-actor-group! this)
        )
    (let ((a0-9 *target*))
      (when a0-9
        (cond
          ((focus-test? a0-9 board)
           (let* ((s4-0 (handle->process (-> this hud-green-eco)))
                  (s5-0 (if (type? s4-0 hud)
                            s4-0
                            )
                        )
                  )
             (if (and s5-0 (hidden? (the-as hud s5-0)))
                 (send-event s5-0 'force-show)
                 )
             )
           )
          (else
            (let* ((s4-1 (handle->process (-> this hud-green-eco)))
                   (s5-1 (if (type? s4-1 hud)
                             s4-1
                             )
                         )
                   )
              (if (and s5-1 (not (hidden? (the-as hud s5-1))))
                  (send-event s5-1 'force-hide)
                  )
              )
            )
          )
        )
      )
    (when (not (handle->process (-> this trail-handle)))
      (cond
        (*target*
          (let ((s5-2 (new 'stack-no-clear 'light-trail-tracker-spawn-params)))
            (set! (-> s5-2 tracked-obj) (process->handle *target*))
            (set! (-> s5-2 appearance) *eco-green-trail*)
            (set! (-> s5-2 max-num-crumbs) (the int (* 0.5 (the float (-> s5-2 appearance max-age)))))
            (set! (-> s5-2 track-immediately?) #t)
            (let* ((v1-62
                     (estimate-light-trail-mem-usage
                       (the-as uint (-> s5-2 max-num-crumbs))
                       (the-as uint (= (-> s5-2 appearance lie-mode) (lie-mode use-two-strips)))
                       )
                     )
                   (s4-2 (get-process *default-dead-pool* eco-green-trail-tracker (+ v1-62 8192) 1))
                   )
              (set! (-> this trail-handle)
                    (process->handle (-> (when s4-2
                                           (let ((t9-14 (method-of-type process activate)))
                                             (t9-14 s4-2 this "light-trail" (the-as pointer #x70004000))
                                             )
                                           (run-now-in-process s4-2 light-trail-tracker-init-by-other s5-2)
                                           (-> s4-2 ppointer)
                                           )
                                         0
                                         )
                                     )
                    )
              )
            )
          )
        (else
          (set! (-> this trail-handle) (the-as handle #f))
          )
        )
      )
    (let ((s5-3 0))
      0
      (let* ((s4-3 (length (-> this plants)))
             (s3-0 (/ s4-3 32))
             (s2-0 #f)
             )
        (when (-> this plants)
          (dotimes (s1-0 s4-3)
            (cond
              ((not (logtest? (-> this plants s1-0 extra perm status) (entity-perm-status subtask-complete)))
               (+! s5-3 1)
               )
              (else
                (if (-> *setting-control* user-current airlock)
                    (set-setting! 'airlock #f 0.0 0)
                    )
                (if (and (not s2-0) *minimap* (or (-> this updated-minimap?) (zero? (mod s1-0 s3-0))))
                    (kill-matching
                      (-> *minimap* engine)
                      (lambda ((arg0 engine-pers) (arg1 connection-pers) (arg2 object) (arg3 object))
                        (and (= (-> arg1 update-time) arg2)
                             (= (-> arg1 param 3) (-> *minimap-class-list* 131))
                             (= (-> (the-as connection-minimap arg1) node) arg3)
                             #t
                             )
                        )
                      (process->handle this)
                      s1-0
                      )
                    )
                )
              )
            )
          )
        )
      (set! (-> *game-info* counter) (the float s5-3))
      )
    (when (= (-> *game-info* counter) 1.0)
      )
    (set-time! (-> this check-timer))
    )
  0
  (none)
  )

(defstate active (task-manager-forest-plants)
  :virtual #t
  :code (behavior ()
    (when (not (task-node-closed? (game-task-node forest-kill-plants-armor)))
      (let ((gp-0 (current-time)))
        (until (time-elapsed? gp-0 (seconds 2))
          (suspend)
          )
        )
      (when (not (task-node-closed? (game-task-node forest-kill-plants-pillars)))
        (dotimes (gp-1 (length (-> self actor-group 1)))
          (let ((v1-10 (-> self actor-group 1 data gp-1 actor)))
            (add-icon! *minimap* self (the-as uint 124) (the-as int #f) (-> v1-10 extra trans) 0)
            )
          )
        (talker-spawn-func (-> *talker-speech* 103) *entity-pool* (target-pos 0) (the-as region #f))
        (talker-spawn-func (-> *talker-speech* 54) *entity-pool* (target-pos 0) (the-as region #f))
        (suspend)
        (let* ((gp-4 (length (-> self plants)))
               (s5-2 (/ gp-4 32))
               )
          (when (-> self plants)
            (dotimes (s4-2 gp-4)
              (let ((v1-25 (-> self plants s4-2)))
                (if (zero? (mod s4-2 s5-2))
                    (add-icon! *minimap* self (the-as uint 131) (the-as int #f) (-> v1-25 extra trans) s4-2)
                    )
                )
              )
            )
          )
        (when (not (handle->process (-> self arrow)))
          (let ((gp-5 (new 'stack-no-clear 'vector)))
            (set! (-> gp-5 quad) (-> (entity-by-name "ecovent-20") extra trans quad))
            (let ((s5-3 (new 'stack-no-clear 'task-arrow-params)))
              (set! (-> s5-3 pos quad) (-> gp-5 quad))
              (quaternion-identity! (-> s5-3 quat))
              (set! (-> s5-3 flags) (task-arrow-flags))
              (set! (-> s5-3 map-icon) (the-as uint 13))
              (set! (-> self arrow) (process->handle (task-arrow-spawn s5-3 self)))
              )
            (while (let ((f0-0 (vector-vector-distance-squared gp-5 (target-pos 0)))
                         (f1-0 24576.0)
                         )
                     (and (>= f0-0 (* f1-0 f1-0)) (handle->process (-> self arrow)))
                     )
              (suspend)
              )
            )
          (let ((a0-35 (handle->process (-> self arrow))))
            (when a0-35
              (send-event a0-35 'die)
              (set! (-> self arrow) (the-as handle #f))
              )
            )
          )
        (set-setting! 'string-min-length 'abs (meters 8) 0)
        (set-setting! 'string-max-length 'abs (meters 14) 0)
        (set-setting! 'string-min-height 'abs (meters 4) 0)
        (set-setting! 'string-max-height 'abs (meters 8) 0)
        (set-setting! 'music 'ctysprit 0.0 0)
        (while (!= (-> *game-info* counter) 0.0)
          (suspend)
          (when (and (>= 32.0 (-> *game-info* counter)) (not (-> self updated-minimap?)))
            (kill-matching
              (-> *minimap* engine)
              (lambda ((arg0 engine-pers) (arg1 connection-pers) (arg2 object) (arg3 object))
                (and (= (-> arg1 update-time) arg2) (= (-> arg1 param 3) (-> *minimap-class-list* 131)))
                )
              (process->handle self)
              0
              )
            (let ((gp-6 (length (-> self plants))))
              (when (-> self plants)
                (dotimes (s5-5 gp-6)
                  (let ((v1-82 (-> self plants s5-5)))
                    (if (not (logtest? (-> v1-82 extra perm status) (entity-perm-status subtask-complete)))
                        (add-icon! *minimap* self (the-as uint 131) (the-as int #f) (-> v1-82 extra trans) s5-5)
                        )
                    )
                  )
                )
              )
            (set! (-> self updated-minimap?) #t)
            )
          )
        (remove-setting! 'music)
        )
      (let ((a0-54 (handle->process (-> self arrow))))
        (when a0-54
          (send-event a0-54 'die)
          (set! (-> self arrow) (the-as handle #f))
          )
        )
      (send-event (handle->process (-> self hud-counter)) 'hide-and-die)
      (when (not (task-node-closed? (game-task-node forest-kill-plants-pillars)))
        (when (and *target* (not (logtest? (-> *target* focus-status) (focus-status grabbed))))
          (while (not (process-grab? *target* #f))
            (suspend)
            )
          )
        )
      (when (-> self actor-group)
        (let ((gp-7 (new 'stack-no-clear 'vector)))
          (set! (-> gp-7 quad)
                (-> self actor-group 0 data (+ (length (-> self actor-group 0)) -1) actor extra trans quad)
                )
          (let ((s5-7 (new 'stack-no-clear 'vector)))
            (set! (-> s5-7 quad) (-> gp-7 quad))
            (+! (-> gp-7 y) 65536.0)
            (+! (-> s5-7 y) 73728.0)
            (let ((s4-4 (-> self actor-group 1)))
              (dotimes (s3-0 (-> s4-4 length))
                (let ((a1-25 (new 'stack-no-clear 'event-message-block)))
                  (set! (-> a1-25 from) (process->ppointer self))
                  (set! (-> a1-25 num-params) 0)
                  (set! (-> a1-25 message) 'hide)
                  (let ((t9-30 send-event-function)
                        (v1-133 (-> s4-4 data s3-0 actor))
                        )
                    (t9-30
                      (if v1-133
                          (-> v1-133 extra process)
                          )
                      a1-25
                      )
                    )
                  )
                )
              )
            (if (not (task-node-closed? (game-task-node forest-kill-plants-pillars)))
                (set-setting! 'entity-name "camera-325" 0.0 0)
                )
            (dotimes (s4-5 (length (-> self actor-group 0)))
              (let ((a1-27 (new 'stack-no-clear 'event-message-block)))
                (set! (-> a1-27 from) (process->ppointer self))
                (set! (-> a1-27 num-params) 0)
                (set! (-> a1-27 message) 'above-water)
                (let ((t9-33 send-event-function)
                      (v1-147 (-> self actor-group 0 data s4-5 actor))
                      )
                  (t9-33
                    (if v1-147
                        (-> v1-147 extra process)
                        )
                    a1-27
                    )
                  )
                )
              (let ((s3-1 (current-time)))
                (until (time-elapsed? s3-1 (seconds 0.5))
                  (suspend)
                  )
                )
              )
            (when (not (handle->process (-> self arrow)))
              (let ((s4-6 (new 'stack-no-clear 'task-arrow-params)))
                (set! (-> s4-6 pos quad) (-> gp-7 quad))
                (quaternion-identity! (-> s4-6 quat))
                (set! (-> s4-6 flags) (task-arrow-flags))
                (set! (-> s4-6 map-icon) (the-as uint 13))
                (set! (-> self arrow) (process->handle (task-arrow-spawn s4-6 self)))
                )
              )
            (let* ((s4-7 (get-process *default-dead-pool* shoulder-plates #x4000 1))
                   (hand (ppointer->handle
                           (when s4-7
                             (let ((t9-38 (method-of-type process activate)))
                               (t9-38 s4-7 self "shoulder-plates" (the-as pointer #x70004000))
                               )
                             (run-now-in-process s4-7 shoulder-plates-init-by-other s5-7 (-> self entity) (-> self level))
                             (-> s4-7 ppointer)
                             )
                           )
                         )
                   )
              (let ((s4-9 (talker-spawn-func (-> *talker-speech* 104) *entity-pool* (target-pos 0) (the-as region #f))))
                (when (not (task-node-closed? (game-task-node forest-kill-plants-pillars)))
                  (let ((s3-3 (current-time)))
                    (until (time-elapsed? s3-3 (seconds 2))
                      (suspend)
                      )
                    )
                  (set-setting! 'interp-time 'abs 0.0 0)
                  (remove-setting! 'entity-name)
                  (when (and *target* (focus-test? *target* grabbed))
                    (while (not (process-release? *target*))
                      (suspend)
                      )
                    )
                  (task-node-close! (game-task-node forest-kill-plants-pillars) 'event)
                  )
                (while (let ((f0-7 (vector-vector-distance-squared gp-7 (target-pos 0)))
                             (f1-7 49152.0)
                             )
                         (>= f0-7 (* f1-7 f1-7))
                         )
                  (suspend)
                  )
                (let ((v1-194 (get-status *gui-control* s4-9)))
                  (while (not (or (= v1-194 (gui-status stop)) (= v1-194 (gui-status unknown))))
                    (when (and *target* (not (logtest? (-> *target* focus-status) (focus-status grabbed))))
                      (while (not (process-grab? *target* #f))
                        (suspend)
                        )
                      )
                    (suspend)
                    (set! v1-194 (get-status *gui-control* s4-9))
                    )
                  )
                )
              (when (and *target* (focus-test? *target* grabbed))
                (while (not (process-release? *target*))
                  (suspend)
                  )
                )
              (while (let ((f0-8 (vector-vector-distance-squared gp-7 (target-pos 0)))
                           (f1-10 24576.0)
                           )
                       (>= f0-8 (* f1-10 f1-10))
                       )
                (suspend)
                )
              (send-event (handle->process (-> self arrow)) 'die)
              ;; og:preserve-this
              (deactivate (handle->process hand))
              )
            )
          )
        (process-spawn scene-player :init scene-player-init "forest-res-b" #t #f :name "scene-player")
        (while *scene-player*
          (suspend)
          )
        (talker-spawn-func (-> *talker-speech* 113) *entity-pool* (target-pos 0) (the-as region #f))
        )
      )
    (when (-> self actor-group)
      (let ((gp-11 (-> self actor-group 0 data (+ (length (-> self actor-group 0)) -1) actor)))
        (let ((s5-10 (new 'stack-no-clear 'vector)))
          (set! (-> s5-10 quad) (-> gp-11 extra trans quad))
          (+! (-> s5-10 y) 65536.0)
          (while (let ((f0-11 102400.0))
                   (>= (* f0-11 f0-11) (vector-vector-distance-squared s5-10 (target-pos 0)))
                   )
            (suspend)
            )
          )
        (when (and *target* (not (logtest? (-> *target* focus-status) (focus-status grabbed))))
          (while (not (process-grab? *target* #f))
            (suspend)
            )
          )
        (set-setting! 'entity-name "camera-325" 0.0 0)
        (send-event
          (if gp-11
              (-> gp-11 extra process)
              )
          'trigger
          )
        )
      (let ((gp-12 (current-time)))
        (until (time-elapsed? gp-12 (seconds 5))
          (suspend)
          )
        )
      (set-setting! 'interp-time 'abs 0.0 0)
      (remove-setting! 'entity-name)
      (when (and *target* (focus-test? *target* grabbed))
        (while (not (process-release? *target*))
          (suspend)
          )
        )
      )
    (send-event self 'complete)
    (sleep-code)
    )
  )

;; WARN: Return type mismatch task-manager vs task-manager-forest-plants.
(defmethod relocate ((this task-manager-forest-plants) (offset int))
  (if (nonzero? (-> this plants))
      (&+! (-> this plants) offset)
      )
  (the-as task-manager-forest-plants ((method-of-type task-manager relocate) this offset))
  )

;; WARN: Return type mismatch symbol vs none.
(defmethod init! ((this task-manager-forest-plants))
  (let ((t9-0 (method-of-type task-manager init!)))
    (t9-0 this)
    )
  (set! (-> this plants) #f)
  (let ((s4-0 0)
        (s5-0 (level-get *level* 'lforplnt))
        )
    (when s5-0
      (let ((s3-0 (-> s5-0 bsp actors)))
        (when (nonzero? s3-0)
          (dotimes (s2-0 (-> s3-0 length))
            (let* ((a0-3 (-> s3-0 data s2-0 actor))
                   (a1-2 ((method-of-type res-lump get-property-struct)
                          a0-3
                          'name
                          'interp
                          -1000000000.0
                          ""
                          (the-as (pointer res-tag) #f)
                          *res-static-buf*
                          )
                         )
                   )
              (if (string-prefix= "mh-plant" (the-as string a1-2))
                  (+! s4-0 1)
                  )
              )
            )
          )
        )
      (set! (-> *game-info* counter) (the float s4-0))
      (set! (-> *game-info* goal) (the float s4-0))
      (set! (-> this plants) (new 'process 'boxed-array entity-actor s4-0))
      (set! (-> this plants length) 0)
      (let ((s5-1 (-> s5-0 bsp actors)))
        (when (nonzero? s5-1)
          (dotimes (s4-1 (-> s5-1 length))
            (let* ((s3-1 (-> s5-1 data s4-1 actor))
                   (a1-5 ((method-of-type res-lump get-property-struct)
                          s3-1
                          'name
                          'interp
                          -1000000000.0
                          ""
                          (the-as (pointer res-tag) #f)
                          *res-static-buf*
                          )
                         )
                   )
              (when (string-prefix= "mh-plant" (the-as string a1-5))
                (set! (-> this plants (-> this plants length)) s3-1)
                (+! (-> this plants length) 1)
                )
              )
            )
          )
        )
      )
    )
  (none)
  )

(defmethod init-actor-group! ((this task-manager-forest-plants))
  (local-vars (sv-16 res-tag))
  (let ((a0-2 (entity-by-name "for-plant-manager-1")))
    (when a0-2
      (set! (-> this plant-manager-entity) a0-2)
      (set! sv-16 (new 'static 'res-tag))
      (let ((v1-1 (res-lump-data a0-2 'actor-groups pointer :tag-ptr (& sv-16))))
        (cond
          ((and v1-1 (>= (-> sv-16 elt-count) (the-as uint 2)))
           (set! (-> this actor-group-count) (the-as int (-> sv-16 elt-count)))
           (set! (-> this actor-group) (the-as (pointer actor-group) v1-1))
           )
          (else
            (format 0 "ERROR: ~s: entity missing actor-group!~%" (game-task->string (-> this node-info task)))
            )
          )
        )
      (when (not (task-node-closed? (game-task-node forest-kill-plants-pillars)))
        (set! (-> this hud-counter)
              (ppointer->handle
                (process-spawn hud-forest-plants :init hud-init-by-other :name "hud-forest-plants" :to this)
                )
              )
        (set! (-> this hud-green-eco)
              (ppointer->handle
                (process-spawn hud-green-eco-gauge :init hud-init-by-other :name "hud-green-eco-gauge" :to this)
                )
              )
        )
      )
    )
  (none)
  )

;; WARN: Return type mismatch symbol vs none.
(defmethod set-time-limit ((this task-manager-forest-plants))
  (let ((t9-0 (method-of-type task-manager set-time-limit)))
    (t9-0 this)
    )
  (set-setting! 'board-trail #t 0.0 0)
  (set! (-> this plant-manager-entity) #f)
  (set! (-> this actor-group) (the-as (pointer actor-group) #f))
  (set! (-> this actor-group-count) 0)
  (set! (-> this displayed-hint?) #f)
  (set! (-> this trail-handle) (the-as handle #f))
  (set! (-> this updated-minimap?) #f)
  (none)
  )
