;;-*-Lisp-*-
(in-package goal)

;; name: tie-h.gc
;; name in dgo: tie-h
;; dgos: ENGINE, GAME

;; NOTE - for cam-update
(declare-type instance-tie-work structure)
(declare-type prototype-tie-work structure)
(define-extern *instance-tie-work* instance-tie-work)
(define-extern *prototype-tie-work* prototype-tie-work)

(define-extern tie-scissor-make-perspective-matrix (function matrix matrix none))

;; DECOMP BEGINS

(deftype tie-fragment-debug (structure)
  ((num-tris    uint16                :offset-assert   0)
   (num-dverts  uint16                :offset-assert   2)
   (debug-lines (array vector-array)  :offset-assert   4)
   )
  :method-count-assert 9
  :size-assert         #x8
  :flag-assert         #x900000008
  )

(deftype tie-fragment (drawable)
  ((gif-ref       (inline-array adgif-shader)  :offset   4)
   (point-ref     uint32                       :offset   8)
   (color-index   uint16                       :offset  12)
   (base-colors   uint8                        :offset  14)
   (tex-count     uint16                       :offset  32)
   (gif-count     uint16                       :offset  34)
   (vertex-count  uint16                       :offset  36)
   (color-count   uint16                       :offset  38)
   (dp-ref        uint32                       :offset  40)
   (dp-qwc        uint32                       :offset  44)
   (generic-ref   uint32                       :offset  48)
   (generic-count uint16                       :offset  52)
   (normal-count  uint16                       :offset  54)
   (normal-ref    uint32                       :offset  56)
   (debug         tie-fragment-debug           :offset  60)
   )
  :method-count-assert 17
  :size-assert         #x40
  :flag-assert         #x1100000040
  )

(deftype instance-tie (instance)
  ((color-indices uint32                :offset   8)
   (bucket-ptr    prototype-bucket-tie  :offset  12)
   (max-scale     uint16                :offset  38)
   (rmin-scale    uint16                :offset  54)
   )
  :method-count-assert 17
  :size-assert         #x40
  :flag-assert         #x1100000040
  )

(deftype drawable-inline-array-instance-tie (drawable-inline-array)
  ((data instance-tie 1 :inline :offset-assert  32)
   (pad  uint32                 :offset-assert  96)
   )
  :method-count-assert 17
  :size-assert         #x64
  :flag-assert         #x1100000064
  )

(deftype drawable-tree-instance-tie (drawable-tree)
  ((prototypes proxy-prototype-array-tie  :offset   8)
   )
  :method-count-assert 17
  :size-assert         #x20
  :flag-assert         #x1100000020
  )

(deftype prototype-tie (drawable-inline-array)
  ((data tie-fragment 1 :inline :offset-assert  32)
   (pad  uint32                 :offset-assert  96)
   )
  :method-count-assert 17
  :size-assert         #x64
  :flag-assert         #x1100000064
  )

(deftype tie-matrix (structure)
  ((mat          matrix :inline :offset-assert   0)
   (morph        qword  :inline :offset-assert  64)
   (fog          qword  :inline :offset-assert  80)
   (envmap-flag  uint32         :offset         80)
   (guard-flag   uint32         :offset         84)
   (vertex-alpha float          :offset         88)
   (fog-value    float          :offset         92)
   (fixed-alpha  float          :offset         68)
   )
  :method-count-assert 9
  :size-assert         #x60
  :flag-assert         #x900000060
  )

(deftype instance-tie-work (structure)
  ((wind-const                     vector     :inline   :offset-assert   0)
   (hmge-d                         vector     :inline   :offset-assert  16)
   (hvdf-offset                    vector     :inline   :offset-assert  32)
   (wind-force                     vector     :inline   :offset-assert  48)
   (constant                       vector     :inline   :offset-assert  64)
   (far-morph                      vector     :inline   :offset-assert  80)
   (dist-test                      vector     :inline   :offset-assert  96)
   (min-dist                       vector     :inline   :offset-assert 112)
   (guard-plane                    plane      4 :inline :offset-assert 128)
   (upload-color-0                 dma-packet :inline   :offset-assert 192)
   (upload-color-1                 dma-packet :inline   :offset-assert 208)
   (upload-color-2                 dma-packet :inline   :offset-assert 224)
   (upload-color-ret               dma-packet :inline   :offset-assert 240)
   (upload-color-temp              dma-packet :inline   :offset-assert 256)
   (generic-color-0                dma-packet :inline   :offset-assert 272)
   (generic-color-1                dma-packet :inline   :offset-assert 288)
   (generic-color-end              dma-packet :inline   :offset-assert 304)
   (envmap-color-0                 dma-packet :inline   :offset-assert 320)
   (envmap-color-1                 dma-packet :inline   :offset-assert 336)
   (tie-scissor-perspective-matrix matrix     :inline   :offset-assert 352)
   (tod-env-color                  vector     :inline   :offset-assert 416)
   (morph-temp                     vector     :inline   :offset-assert 432)
   (fog-temp                       vector     :inline   :offset-assert 448)
   (fade-temp                      float                :offset-assert 464)
   (wind-vectors                   uint32               :offset-assert 468)
   (test-id                        uint32               :offset-assert 472)
   (test-id2                       uint32               :offset-assert 476)
   (dma-buffer                     basic                :offset-assert 480)
   (to-spr                         uint32               :offset-assert 484)
   (from-spr                       uint32               :offset-assert 488)
   (wind-work                      uint32               :offset-assert 492)
   (cur-vis-bits                   uint32               :offset-assert 496)
   (end-vis-bits                   uint32               :offset-assert 500)
   (refl-fade-fac                  float                :offset-assert 504)
   (refl-fade-end                  float                :offset-assert 508)
   (flags                          uint32               :offset-assert 512)
   (vanish-flag                    uint32               :offset-assert 516)
   (translucent-flag               uint32               :offset-assert 520)
   (wait-from-spr                  uint32               :offset-assert 524)
   (wait-to-spr                    uint32               :offset-assert 528)
   (use-etie                       symbol               :offset-assert 532)
   (buffer-start                   uint32               :offset-assert 536)
   (buffer-end                     uint32               :offset-assert 540)
   (tfrag-dists                    uint32               :offset-assert 544)
   (alpha-dists                    uint32               :offset-assert 548)
   (water-dists                    uint32               :offset-assert 552)
   )
  :method-count-assert 9
  :size-assert         #x22c
  :flag-assert         #x90000022c
  )

(deftype instance-tie-dma (structure)
  ((banka instance-tie      32 :inline :offset-assert   0)
   (bankb instance-tie      32 :inline :offset-assert 2048)
   (outa  uint128           256        :offset-assert 4096)
   (outb  uint128           256        :offset-assert 8192)
   (work  instance-tie-work :dynamic   :offset-assert 12288)
   )
  :method-count-assert 9
  :size-assert         #x3000
  :flag-assert         #x900003000
  )

(deftype prototype-tie-work (structure)
  ((upload-flushe              dma-packet   :inline :offset-assert   0)
   (upload-palette             dma-packet   :inline :offset-assert  16)
   (upload-model-0             dma-packet   :inline :offset-assert  32)
   (upload-model-1             dma-packet   :inline :offset-assert  48)
   (upload-model-2             dma-packet   :inline :offset-assert  64)
   (upload-model-3             dma-packet   :inline :offset-assert  80)
   (upload-model-near-0        dma-packet   :inline :offset-assert  96)
   (upload-model-near-1        dma-packet   :inline :offset-assert 112)
   (upload-model-near-2        dma-packet   :inline :offset-assert 128)
   (upload-model-near-3        dma-packet   :inline :offset-assert 144)
   (upload-model-near-4        dma-packet   :inline :offset-assert 160)
   (envmap-palette             dma-packet   :inline :offset-assert 176)
   (envmap-shader              dma-packet   :inline :offset-assert 192)
   (upload-envmap-0            dma-packet   :inline :offset-assert 208)
   (upload-envmap-1            dma-packet   :inline :offset-assert 224)
   (upload-envmap-2            dma-packet   :inline :offset-assert 240)
   (upload-envmap-3            dma-packet   :inline :offset-assert 256)
   (upload-envmap-4            dma-packet   :inline :offset-assert 272)
   (upload-envmap-scissor-4    dma-packet   :inline :offset-assert 288)
   (generic-palette            dma-packet   :inline :offset-assert 304)
   (generic-model-0            dma-packet   :inline :offset-assert 320)
   (generic-model-1            dma-packet   :inline :offset-assert 336)
   (generic-model-2            dma-packet   :inline :offset-assert 352)
   (model-next                 dma-packet   :inline :offset-assert 368)
   (clamp                      uint64               :offset-assert 384)
   (prototype-array            basic                :offset-assert 392)
   (wait-from-spr              uint32               :offset-assert 396)
   (wait-to-spr                uint32               :offset-assert 400)
   (mood                       mood-context         :offset-assert 404)
   (last                       uint32       16      :offset        416)
   (next                       uint32       16      :offset-assert 480)
   (count                      uint16       16      :offset-assert 544)
   (tie-last                   uint32               :offset        416)
   (tie-next                   uint32               :offset        480)
   (tie-count                  uint16               :offset        544)
   (trans-last                 uint32               :offset        420)
   (trans-next                 uint32               :offset        484)
   (trans-count                uint16               :offset        546)
   (water-last                 uint32               :offset        424)
   (water-next                 uint32               :offset        488)
   (water-count                uint16               :offset        548)
   (scissor-last               uint32               :offset        428)
   (scissor-next               uint32               :offset        492)
   (scissor-count              uint16               :offset        550)
   (scissor-trans-last         uint32               :offset        432)
   (scissor-trans-next         uint32               :offset        496)
   (scissor-trans-count        uint16               :offset        552)
   (scissor-water-last         uint32               :offset        436)
   (scissor-water-next         uint32               :offset        500)
   (scissor-water-count        uint16               :offset        554)
   (envmap-last                uint32               :offset        440)
   (envmap-next                uint32               :offset        504)
   (envmap-count               uint16               :offset        556)
   (envmap-trans-last          uint32               :offset        444)
   (envmap-trans-next          uint32               :offset        508)
   (envmap-trans-count         uint16               :offset        558)
   (envmap-water-last          uint32               :offset        448)
   (envmap-water-next          uint32               :offset        512)
   (envmap-water-count         uint16               :offset        560)
   (envmap-scissor-last        uint32               :offset        452)
   (envmap-scissor-next        uint32               :offset        516)
   (envmap-scissor-count       uint16               :offset        562)
   (envmap-scissor-trans-last  uint32               :offset        456)
   (envmap-scissor-trans-next  uint32               :offset        520)
   (envmap-scissor-trans-count uint16               :offset        564)
   (envmap-scissor-water-last  uint32               :offset        460)
   (envmap-scissor-water-next  uint32               :offset        524)
   (envmap-scissor-water-count uint16               :offset        566)
   (generic-last               uint32               :offset        464)
   (generic-next               uint32               :offset        528)
   (generic-count              uint16               :offset        568)
   (generic-trans-last         uint32               :offset        468)
   (generic-trans-next         uint32               :offset        532)
   (generic-trans-count        uint16               :offset        570)
   (generic-water-last         uint32               :offset        472)
   (generic-water-next         uint32               :offset        536)
   (generic-water-count        uint16               :offset        572)
   (vanish-last                uint32               :offset        476)
   (vanish-next                uint32               :offset        540)
   (vanish-count               uint16               :offset        574)
   )
  :method-count-assert 9
  :size-assert         #x240
  :flag-assert         #x900000240
  )

(deftype prototype-tie-dma (structure)
  ((colora               rgba    256 :offset-assert   0)
   (colorb               rgba    256 :offset-assert 1024)
   (outa                 uint128 256 :offset-assert 2048)
   (outb                 uint128 256 :offset-assert 6144)
   (geometry             uint32  4   :offset-assert 10240)
   (next                 uint32  12  :offset        10256)
   (count                uint16  12  :offset        10304)
   (counts               uint32  4   :offset        10328)
   (palette-ptr          uint32      :offset        10336)
   (model-ptr            uint32      :offset        10340)
   (ret-ptr              uint32      :offset        10344)
   (length               uint32      :offset        10348)
   (flags                uint32      :offset        10352)
   (dma-buffer           basic       :offset        10356)
   (this-frag-count      uint32      :offset        10360)
   (frag-count           uint8   4   :offset        10364)
   (from-spr             uint32      :offset        10368)
   (to-spr               uint32      :offset        10372)
   (spr-out              uint32      :offset        10376)
   (this-count           uint32      :offset        10380)
   (scissor-geometry     uint32      :offset        10240)
   (near-geometry        uint32      :offset        10244)
   (mid-geometry         uint32      :offset        10248)
   (far-geometry         uint32      :offset        10252)
   (scissor-frag-count   uint8       :offset        10364)
   (near-frag-count      uint8       :offset        10365)
   (mid-frag-count       uint8       :offset        10366)
   (far-frag-count       uint8       :offset        10367)
   (tie-scissor-next     uint32      :offset        10256)
   (tie-near-next        uint32      :offset        10260)
   (tie-mid-next         uint32      :offset        10264)
   (tie-far-next         uint32      :offset        10268)
   (trans-scissor-next   uint32  4   :offset        10256)
   (trans-near-next      uint32      :offset        10260)
   (trans-mid-next       uint32      :offset        10264)
   (trans-far-next       uint32      :offset        10268)
   (water-scissor-next   uint32  4   :offset        10256)
   (water-near-next      uint32      :offset        10260)
   (water-mid-next       uint32      :offset        10264)
   (water-far-next       uint32      :offset        10268)
   (envmap-scissor-next  uint32  4   :offset        10272)
   (envmap-near-next     uint32      :offset        10276)
   (envmap-mid-next      uint32      :offset        10280)
   (envmap-far-next      uint32      :offset        10284)
   (generic-near-next    uint32      :offset        10288)
   (generic-mid-next     uint32      :offset        10292)
   (generic-far-next     uint32      :offset        10296)
   (vanish-next          uint32      :offset        10300)
   (tie-count            uint16      :offset        10304)
   (tie-scissor-count    uint16      :offset        10304)
   (tie-near-count       uint16      :offset        10306)
   (tie-mid-count        uint16      :offset        10308)
   (tie-far-count        uint16      :offset        10310)
   (trans-count          uint16      :offset        10304)
   (trans-scissor-count  uint16      :offset        10304)
   (trans-near-count     uint16      :offset        10306)
   (trans-mid-count      uint16      :offset        10308)
   (trans-far-count      uint16      :offset        10310)
   (water-count          uint16      :offset        10304)
   (water-scissor-count  uint16      :offset        10304)
   (water-near-count     uint16      :offset        10306)
   (water-mid-count      uint16      :offset        10308)
   (water-far-count      uint16      :offset        10310)
   (envmap-count         uint16      :offset        10312)
   (envmap-scissor-count uint16      :offset        10312)
   (envmap-near-count    uint16      :offset        10314)
   (envmap-mid-count     uint16      :offset        10316)
   (envmap-far-count     uint16      :offset        10318)
   (generic-count        uint16      :offset        10320)
   (generic-near-count   uint16      :offset        10320)
   (generic-mid-count    uint16      :offset        10322)
   (generic-far-count    uint16      :offset        10324)
   (vanish-count         uint16      :offset        10326)
   (next-clear           uint32  3   :offset        10256)
   (count-clear          uint16  3   :offset        10304)
   )
  :method-count-assert 9
  :size-assert         #x2890
  :flag-assert         #x900002890
  )


(define *instance-tie-work-copy* (the-as instance-tie-work #f))

(define-extern draw-drawable-tree-instance-tie (function drawable-tree-instance-tie level none))
