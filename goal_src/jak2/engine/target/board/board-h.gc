;;-*-Lisp-*-
(in-package goal)

;; name: board-h.gc
;; name in dgo: board-h
;; dgos: ENGINE, GAME

(defenum board-tricks ;; (method 9 board-info)
  :type uint32
  :bitfield #f
  (none 0)
  (board-spin 1)
  (board-boost 2)
  (board-flip 3)
  (board-rail 4)
  (board-rail-jump 5)
  (board-nosegrab 6)
  (board-method 7)
  (board-board-spin 8)
  (board-board-flip 9)
  (board-noseflip 10)
  (board-kickflip 11)
  (board-jump 12)
  (board-duck-jump 13)
  (board-quick-jump 14)
  (darkjak 15)
  (darkjak-bomb0 16)
  (darkjak-bomb1 17)
  (darkjak-giant 18)
  )

(#when PC_PORT

(deftype board-trick-tracker (structure)
  ((tricks-in-combo       board-tricks 16)
   (num-tricks-in-combo   uint32)
   (points-in-combo       float)
   (combo-in-progress?    symbol))
  (:methods
    (reset-combo! (_type_) none 9)
    (add-trick-to-combo! (_type_ board-tricks float) none 10)
    (render-combo (_type_) none 11)
    (end-combo! (_type_) none 12)))

(define-extern *board-trick-tracker* board-trick-tracker)

)

;; DECOMP BEGINS

(deftype board (process-drawable)
  ((control       control-info  :offset 128)
   (shadow-backup shadow-geo    :offset 208)
   (main          joint-mod     :offset 212)
   )
  :heap-base #x60
  :method-count-assert 23
  :size-assert         #xd8
  :flag-assert         #x17006000d8
  (:methods
    (idle (symbol) _type_ :state 20)
    (use () _type_ :state 21)
    (hidden () _type_ :state 22)
    )
  )


(deftype board-info (basic)
  ((board                  (pointer board)                      :offset-assert   4)
   (camera-interp          float                                :offset-assert   8)
   (process                (pointer target)                     :offset-assert  12)
   (board-trans            vector                   :inline     :offset-assert  16)
   (board-quat             vector                   :inline     :offset-assert  32)
   (board-scale            vector                   :inline     :offset-assert  48)
   (main                   joint-mod                            :offset-assert  64)
   (upper-body             joint-mod                            :offset-assert  68)
   (sound-bank-knob        float                                :offset-assert  72)
   (sound-air-knob         float                                :offset-assert  76)
   (wind-sound-id          uint32                               :offset-assert  80)
   (wind-sound-pitch       float                                :offset-assert  84)
   (wind-sound-volume      float                                :offset-assert  88)
   (engine-sound-id        uint32                               :offset-assert  92)
   (engine-sound-pitch     float                                :offset-assert  96)
   (engine-sound-volume    float                                :offset-assert 100)
   (bank-sound-id          uint32                               :offset-assert 104)
   (bank-sound-pitch       float                                :offset-assert 108)
   (bank-sound-volume      float                                :offset-assert 112)
   (ride-sound-id          uint32                               :offset-assert 116)
   (spin-sound-id          uint32                               :offset-assert 120)
   (spin-sound-volume      float                                :offset-assert 124)
   (spin-sound-pitch       float                                :offset-assert 128)
   (unknown-sound-id00     sound-id                             :offset-assert 132)
   (unknown-sound-id01     sound-id                             :offset-assert 136)
   (unknown-sound-id02     sound-id                             :offset-assert 140)
   (up-vector              vector                   2 :inline   :offset-assert 144)
   (slow-transv            vector                   :inline     :offset-assert 176)
   (board-time             time-frame                           :offset-assert 192)
   (board-get-on-time      time-frame                           :offset-assert 200)
   (in-air-time            time-frame                           :offset-assert 208)
   (unknown-time-frame00   time-frame                           :offset-assert 216)
   (unknown-time-frame01   time-frame                           :offset        224)
   (unknown-time-frame02   time-frame                           :offset        232)
   (stick-lock             symbol                               :offset        240)
   (stick-off              symbol                               :offset-assert 244)
   (stance-info            ground-tween-info        :inline     :offset-assert 248)
   (mods-backup            basic                                :offset-assert 284)
   (attack-id              uint32                               :offset-assert 288)
   (latch?                 symbol                               :offset-assert 292)
   (unknown-vector00       vector                   :inline     :offset        304)
   (unknown-vector01       vector                   :inline     :offset        320)
   (unknown-int00          uint32                               :offset        336)
   (unknown-symbol00       symbol                               :offset        340)
   (unstuck-time           time-frame                           :offset        344)
   (stuck-count            int32                                :offset-assert 352)
   (thrust-scale           float                                :offset-assert 356)
   (flip-time              time-frame                           :offset-assert 360)
   (transv-max             meters                               :offset-assert 368)
   (turn-anim-tilt?        symbol                               :offset-assert 372)
   (turn-anim-mag          float                                :offset-assert 376)
   (turn-anim-targ         float                                :offset-assert 380)
   (turn-anim-frame        float                                :offset-assert 384)
   (turn-anim-vel          float                                :offset-assert 388)
   (turn-anim-duck         float                                :offset-assert 392)
   (turn-anim-duck-vel     float                                :offset-assert 396)
   (tilt-anim-frame        vector                   :inline     :offset-assert 400)
   (tilt-anim-target       vector                   :inline     :offset-assert 416)
   (smack-surface-time     time-frame                           :offset-assert 432)
   (smack-speed            meters                               :offset-assert 440)
   (smack-normal           vector                   :inline     :offset-assert 448)
   (glance-time            time-frame                           :offset-assert 464)
   (glance-speed           meters                               :offset-assert 472)
   (glance-in-transv       vector                   :inline     :offset-assert 480)
   (glance-out-transv      vector                   :inline     :offset-assert 496)
   (glance-normal          vector                   :inline     :offset-assert 512)
   (on-flat-time           time-frame                           :offset-assert 528)
   (jump-land-time         time-frame                           :offset-assert 536)
   (slip-factor            float                                :offset-assert 544)
   (ground-on-dir          vector                   :inline     :offset-assert 560)
   (ride-time              time-frame                           :offset-assert 576)
   (ride-start-time        time-frame                           :offset-assert 584)
   (ride-button-time       time-frame                           :offset-assert 592)
   (ride-lean-targ         float                                :offset-assert 600)
   (ride-lean              float                                :offset-assert 604)
   (ride-leanv             float                                :offset-assert 608)
   (ride-lean-mag          float                                :offset-assert 612)
   (ride-tilt-targ         float                                :offset-assert 616)
   (ride-tilt              float                                :offset-assert 620)
   (ride-tiltv             float                                :offset-assert 624)
   (ride-tilt-mag          float                                :offset-assert 628)
   (ride-lock              symbol                               :offset-assert 632)
   (ride-lock-on           symbol                               :offset-assert 636)
   (ride-speed             meters                               :offset-assert 640)
   (ride-mode              uint32                               :offset-assert 644)
   (ride-rot               degrees                              :offset-assert 648)
   (ride-rot-old           degrees                              :offset-assert 652)
   (ride-rot-abs           degrees                  2           :offset-assert 656)
   (ride-rtv-abs           degrees                              :offset-assert 664)
   (ride-touch-segment     vector                   2 :inline   :offset-assert 672)
   (ride-dir               vector                   :inline     :offset-assert 704)
   (ride-vertex-length     int16                                :offset-assert 720)
   (ride-vertex-length-old int16                                :offset-assert 722)
   (ride-vertex-base       int16                                :offset-assert 724)
   (ride-vertex-base2      int16                                :offset-assert 726)
   (ride-vertex-index      float                                :offset-assert 728)
   (ride-vertex-index2     float                                :offset-assert 732)
   (ride-vertex-index-old  float                                :offset-assert 736)
   (ride-vertex            vector                   3 :inline   :offset-assert 752)
   (ride-segment           vector                   :inline     :offset-assert 800)
   (ride-dir-lean          vector                   :inline     :offset-assert 816)
   (ride-pad-vector        vector                   1 :inline   :offset-assert 832)
   (ride-vertex-old        vector                   3 :inline   :offset-assert 848)
   (ride-segment-old       vector                   :inline     :offset-assert 896)
   (ride-vertex-trail      vector                   128 :inline :offset-assert 912)
   (halfpipe-side-time     time-frame                           :offset-assert 2960)
   (halfpipe-jump-time     time-frame                           :offset-assert 2968)
   (halfpipe-lip-time      time-frame                           :offset-assert 2976)
   (halfpipe-time          time-frame                           :offset-assert 2984)
   (halfpipe-gspot-time    time-frame                           :offset-assert 2992)
   (halfpipe-lip-event     symbol                               :offset-assert 3000)
   (spin-check-time        time-frame                           :offset-assert 3008)
   (spin-time              time-frame                           :offset-assert 3016)
   (spin-start-time        time-frame                           :offset-assert 3024)
   (spin-start-dir         vector                   :inline     :offset-assert 3040)
   (spin-control           float                                :offset-assert 3056)
   (spin-ground-start-time time-frame                           :offset-assert 3064)
   (spin-ground-time       time-frame                           :offset-assert 3072)
   (spin-ground-press-time time-frame                           :offset-assert 3080)
   (flip-control           float                                :offset-assert 3088)
   (flip-count             int32                                :offset-assert 3092)
   (unknown-time-frame03   time-frame                           :offset        3104)
   (unknown-time-frame04   time-frame                           :offset        3112)
   (unknown-time-frame05   time-frame                           :offset        3120)
   (unknown-time-frame06   time-frame                           :offset        3128)
   (unknown-float00        float                                :offset        3136)
   (unknown-float01        float                                :offset        3140)
   (trickx-count           int32                                :offset        3144)
   (trotyv-max             degrees                              :offset-assert 3148)
   (trotyv                 degrees                              :offset-assert 3152)
   (troty                  degrees                              :offset-assert 3156)
   (troty-cum              degrees                              :offset-assert 3160)
   (unknown-deg00          degrees                              :offset        3164)
   (upper-body-rotyv-max   degrees                              :offset        3168)
   (upper-body-rotyv       degrees                              :offset-assert 3172)
   (upper-body-roty        degrees                              :offset-assert 3176)
   (cushion-base           meters                               :offset-assert 3180)
   (cushion-offset         meters                               :offset-assert 3184)
   (shock-offset           meters                               :offset-assert 3188)
   (shock-offsetv          meters                               :offset-assert 3192)
   (shock-rotx             meters                               :offset-assert 3196)
   (part-control           sparticle-launch-control             :offset-assert 3200)
   (trick-count            int32                                :offset-assert 3204)
   (trick-array            board-tricks             16          :offset-assert 3208)
   (trick-points-array     float                    16          :offset        3272)
   (trick-list             board-tricks             16          :offset        3336)
   (pad                    uint8                                :offset        3399)
   )
  :method-count-assert 11
  :size-assert         #xd48
  :flag-assert         #xb00000d48
  (:methods
    (add-to-trick-list (_type_ board-tricks float) none 9)
    (flush-trick-list (_type_) none 10)
    )
  )


(deftype target-board-bank (basic)
  ((jump-height-min        meters   :offset-assert   4)
   (jump-height-max        meters   :offset-assert   8)
   (duck-jump-height-min   meters   :offset-assert  12)
   (duck-jump-height-max   meters   :offset-assert  16)
   (turn-frames            float    :offset-assert  20)
   (wall-kick-window       seconds  :offset-assert  24)
   (cushion                meters   :offset-assert  32)
   (trickx-jump-height-min meters   :offset-assert  36)
   (trickx-jump-height-max meters   :offset-assert  40)
   (tricky-jump-height-min meters   :offset-assert  44)
   (tricky-jump-height-max meters   :offset-assert  48)
   )
  :method-count-assert 9
  :size-assert         #x34
  :flag-assert         #x900000034
  )


(define *TARGET_BOARD-bank* (new 'static 'target-board-bank
                              :jump-height-min (meters 1.01)
                              :jump-height-max (meters 3.5)
                              :duck-jump-height-min (meters 2.5)
                              :duck-jump-height-max (meters 5)
                              :turn-frames 10.0
                              :wall-kick-window (seconds 0.05)
                              :cushion (meters 1)
                              :trickx-jump-height-min (meters 0.9)
                              :trickx-jump-height-max (meters 1.2)
                              :tricky-jump-height-min (meters 0.9)
                              :tricky-jump-height-max (meters 1.2)
                              )
        )

(defbehavior want-to-board? target ()
  (and (logtest? (-> self game features) (game-feature board))
       (or (and (cpad-pressed? (-> self control cpad number) r2)
                (or (!= *cheat-mode* 'debug)
                    (zero? (logand (-> *cpad-list* cpads (-> self control cpad number) button0-abs 0) (pad-buttons l2)))
                    )
                (not *pause-lock*)
                (>= (- (-> self clock frame-counter) (-> self control time-of-last-debug-heal)) (seconds 0.1))
                (>= (-> self control last-time-on-surface) (-> self control time-of-last-debug-float))
                )
           (-> self board latch?)
           )
       (not (logtest? (focus-status dead hit grabbed in-head edge-grab pole board pilot mech dark) (-> self focus-status))
            )
       (or (zero? (-> self board)) (>= (- (-> self clock frame-counter) (-> self board board-time)) (seconds 0.5)))
       (not (logtest? (state-flags prevent-board) (-> self state-flags)))
       (< (-> self board board-time) (-> self control list-time-on-ground))
       (not (logtest? (surface-flag no-board) (-> self control current-surface flags)))
       (or (not (logtest? (-> self control current-surface flags) (surface-flag duck))) (can-exit-duck? self))
       (not (and (logtest? (-> self water flags) (water-flags under-water))
                 (zero? (logand (-> self water flags) (water-flags swim-ground)))
                 )
            )
       (not *artist-fix-visible*)
       (let ((gp-0 (new 'stack-no-clear 'collide-query)))
         (let ((s5-0 (new 'stack-no-clear 'inline-array 'sphere 3)))
           (dotimes (s4-0 3)
             ((method-of-type sphere new) (the-as symbol (-> s5-0 s4-0)) sphere)
             )
           (let ((v1-51 (new 'stack-no-clear 'vector)))
             (set! (-> v1-51 quad) (-> self control trans quad))
             (if (logtest? (-> self focus-status) (focus-status on-water))
                 (set! (-> v1-51 y) (-> self water height))
                 )
             (set! (-> s5-0 0 quad) (-> v1-51 quad))
             (set! (-> s5-0 0 y) (+ 8192.0 (-> s5-0 0 y)))
             (set! (-> s5-0 0 r) 2867.2)
             (set! (-> s5-0 1 quad) (-> v1-51 quad))
             (set! (-> s5-0 1 y) (+ 12288.0 (-> s5-0 1 y)))
             (set! (-> s5-0 1 r) 2867.2)
             (set! (-> s5-0 2 quad) (-> v1-51 quad))
             )
           (set! (-> s5-0 2 y) (+ 16384.0 (-> s5-0 2 y)))
           (set! (-> s5-0 2 r) 2867.2)
           (let ((v1-55 gp-0))
             (set! (-> v1-55 best-dist) (the-as float s5-0))
             (set! (-> v1-55 num-spheres) (the-as uint 3))
             (set! (-> v1-55 collide-with) (logclear
                                             (-> self control root-prim prim-core collide-with)
                                             (collide-spec civilian enemy vehicle-sphere projectile)
                                             )
                   )
             (set! (-> v1-55 ignore-process0) #f)
             (set! (-> v1-55 ignore-process1) #f)
             (set! (-> v1-55 ignore-pat) (new 'static 'pat-surface :noentity #x1 :nojak #x1 :probe #x1 :noendlessfall #x1))
             (set! (-> v1-55 best-my-prim) (the-as collide-shape-prim #t))
             (set! (-> v1-55 action-mask) (collide-action solid))
             )
           )
         (and (if (fill-and-probe-using-spheres *collide-cache* gp-0)
                  #f
                  #t
                  )
              (begin
                (set! (-> self board latch?) #t)
                (>= (- (-> self clock frame-counter) (-> self gun gun-time)) (seconds 0.4))
                )
              )
         )
       )
  )

(defskelgroup skel-board board board-lod0-jg board-board-idle-ja
              ((board-lod0-mg (meters 999999)))
              :bounds (static-spherem 0 0 0 3.5)
              :shadow board-shadow-mg
              :sort 1
              :origin-joint-index 3
              )

(define *board-shadow-control*
  (new 'static 'shadow-control :settings (new 'static 'shadow-settings
                                           :flags (shadow-flags disable-fade shdf03)
                                           :shadow-dir (new 'static 'vector :y -1.0 :w 614400.0)
                                           :bot-plane (new 'static 'plane :y 1.0 :w 81920.0)
                                           :top-plane (new 'static 'plane :y 1.0 :w 2048.0)
                                           )
                               )
  )
