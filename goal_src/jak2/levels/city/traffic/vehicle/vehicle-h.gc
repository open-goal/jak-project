;;-*-Lisp-*-
(in-package goal)

;; name: vehicle-h.gc
;; name in dgo: vehicle-h
;; dgos: CWI

;; +++vehicle-controller-flag
(defenum vehicle-controller-flag
  :type uint32
  :bitfield #t
  (debug)
  (draw-marks)
  (left-turn)
  (on-straightaway)
  (do-turn)
  (blocking-dest-node)
  (attached)
  (off-path)
  (ignore-others)
  (direct-mode)
  (recovery-mode)
  (no-slowing-for-turns))
;; ---vehicle-controller-flag

(declare-type vehicle rigid-body-object)
(declare-type vehicle-physics-work structure)

(deftype mystery-vehicle-type (structure)
  "TODO - What are you! Custom added for decomp"
  ((matrices matrix 3 :inline :offset-assert 0)
   (vectors vector 2 :inline :offset-assert 192)
   (handles handle 2 :offset-assert 224)
   (cquery collide-query :inline :offset-assert 240)
   (floats float 5 :offset-assert 780))
  :method-count-assert 9
  :size-assert         #x320
  :flag-assert         #x900000320)

;; +++vehicle-type
(defenum vehicle-type
  :type int32
  (bikea 0)
  (bikeb 1)
  (bikec 2)
  (cara  3)
  (carb  4)
  (carc  5)
  (guard-bike 6)
  (hellcat 7)
  (evan-test-bike 8)
  (test-bike 9)
  (test-car 10)
  )
;; ---vehicle-type


;; DECOMP BEGINS

(deftype vehicle-lookup-info (structure)
  ((turn-radius        meters)
   (throttle-turning   float)
   (throttle-straight  float)
   )
  )


(deftype vehicle-control-point (structure)
  ((local-pos  vector  :inline)
   (normal     vector  :inline)
   )
  )


(deftype vehicle-section-info (structure)
  ((damage-seg-array  uint64  3)
   (damage-seg-count  int8)
   )
  )


(deftype vehicle-seat-info (structure)
  ((data      uint8   16)
   (position  vector  :inline :overlay-at (-> data 0))
   (pos-x     float           :overlay-at (-> data 0))
   (pos-y     float           :overlay-at (-> data 4))
   (pos-z     float           :overlay-at (-> data 8))
   (angle     int16           :overlay-at (-> data 12))
   (flags     uint8           :overlay-at (-> data 14))
   )
  )


(deftype vehicle-explosion-info (joint-exploder-static-params)
  ((skel       skeleton-group)
   (skel-name  string)
   (anim       int32)
   )
  )


(deftype vehicle-grab-rail-info (structure)
  ((local-pos  vector  2 :inline)
   (normal     vector  :inline)
   )
  )


(deftype rigid-body-vehicle-constants (rigid-body-object-constants)
  ((flags                              uint32)
   (object-type                        uint8)
   (guard-type                         uint8)
   (max-engine-thrust                  meters)
   (inv-max-engine-thrust              float)
   (engine-response-rate               float)
   (engine-intake-factor               float)
   (brake-factor                       float)
   (turbo-boost-factor                 float)
   (max-xz-speed                       meters)
   (ground-probe-distance              meters)
   (ground-probe-offset                meters)
   (cos-ground-effect-angle            float)
   (spring-lift-factor                 float)
   (air-steering-factor                float)
   (air-drag-factor                    float)
   (steering-fin-angle                 float)
   (steering-thruster-factor           float)
   (steering-thruster-max-gain         float)
   (steering-thruster-half-gain-speed  meters)
   (tire-steering-angle                float)
   (tire-friction-factor               float)
   (tire-static-friction               float)
   (tire-static-friction-speed         meters)
   (tire-dynamic-friction              float)
   (tire-dynamic-friction-speed        meters)
   (tire-inv-max-friction-speed        float)
   (airfoil-factor                     float)
   (drag-force-factor                  float)
   (speed-scrubbing-drag               float)
   (speed-limiting-drag                float)
   (pitch-control-factor               float)
   (roll-control-factor                float)
   (roll-angle                         float)
   (jump-thrust-factor                 float)
   (buoyancy-factor                    float)
   (player-weight                      float)
   (player-shift-x                     meters)
   (player-shift-z                     meters)
   (target-speed-offset                meters)
   (turning-accel                      meters)
   (toughness-factor                   float)
   (damage-factor                      float)
   (camera-string-min-height           meters)
   (camera-string-max-height           meters)
   (camera-string-min-length           meters)
   (camera-string-max-length           meters)
   (camera-min-fov                     float)
   (camera-max-fov                     float)
   (camera-head-offset                 float)
   (camera-foot-offset                 float)
   (camera-normal-max-angle-offset     float)
   (camera-air-max-angle-offset        float)
   (camera-max-lookaround-speed        float)
   (seat-count                         int8)
   (section-count                      int8)
   (rider-stance                       uint8)
   (grab-rail-count                    int8)
   (grab-rail-array                    (inline-array vehicle-grab-rail-info))
   (seat-array                         vehicle-seat-info      4 :inline)
   (rider-hand-offset                  vector                 2 :inline)
   (section-array                      vehicle-section-info   4 :inline)
   (section-bike-front                 vehicle-section-info   :inline :overlay-at (-> section-array 0))
   (section-bike-rear                  vehicle-section-info   :inline :offset 560)
   (section-car-front-left             vehicle-section-info   :inline :overlay-at (-> section-array 0))
   (section-car-rear-left              vehicle-section-info   :inline :overlay-at section-bike-rear)
   (section-car-front-right            vehicle-section-info   :inline :offset 592)
   (section-car-rear-right             vehicle-section-info   :inline :offset 624)
   (explosion                          vehicle-explosion-info)
   (engine-pitch-scale                 float)
   (engine-pitch-offset                float)
   (engine-pitch-mod-amp               float)
   (engine-sound-select                int8)
   (engine-sound                       sound-name)
   (thrust-sound                       sound-name)
   (scrape-sound                       sound-name)
   (glance-sound                       sound-name)
   (impact-sound                       sound-name)
   (extra-sound                        sound-name)
   (explosion-part                     int32)
   (headlight-count                    int8)
   (taillight-count                    int8)
   (thruster-flame-width               meters)
   (thruster-flame-length              meters)
   (thruster-local-pos                 vector                 2 :inline)
   (exhaust-local-pos                  vector                 2 :inline)
   (exhaust-local-dir                  vector                 2 :inline)
   (smoke-local-pos                    vector                 2 :inline)
   (smoke-local-vel                    vector                 2 :inline)
   (headlight-local-pos                vector                 3 :inline)
   (taillight-local-pos                vector                 2 :inline)
   (lift-thruster-count                int8)
   (roll-thruster-count                int8)
   (steering-thruster-count            int8)
   (stabilizer-count                   int8)
   (inv-lift-thruster-count            float)
   (pad                                int8                   8)
   (lift-thruster-array                vehicle-control-point  2 :inline)
   (roll-thruster-array                vehicle-control-point  2 :inline)
   (steering-thruster-array            vehicle-control-point  2 :inline)
   (stabilizer-array                   vehicle-control-point  6 :inline)
   (engine-thrust-local-pos            vector                 :inline)
   (brake-local-pos                    vector                 :inline)
   (particle-system-2d                 basic)
   (particle-system-3d                 basic)
   (part-thruster                      basic)
   (part-thruster-scale-x              sp-field-init-spec)
   (part-thruster-scale-y              sp-field-init-spec)
   (part-quat                          quaternion)
   (part-vel                           vector)
   (color-option-count                 int8)
   (color-option-select                int8)
   (color-option-array                 (inline-array vector))
   (sample-dir                         vector                 :inline)
   (sample-time                        time-frame)
   (sample-index                       int32)
   )
  (:methods
    (rigid-body-vehicle-constants-method-9 (_type_) none)
    (rigid-body-vehicle-constants-method-10 (_type_) none)
    )
  )


(deftype vehicle-controller (structure)
  ((flags                   vehicle-controller-flag)
   (traffic                 traffic-engine)
   (branch                  nav-branch)
   (target-speed-offset     meters)
   (target-speed            meters)
   (choose-branch-callback  (function vehicle-controller vehicle nav-branch))
   (turn-accel              meters)
   (max-turn-speed          meters)
   (path-prev-point         vector  :inline)
   (turn-enter-point        vector  :inline)
   (turn-exit-point         vector  :inline)
   (path-dest-point         vector  :inline :overlay-at turn-exit-point)
   (turn-enter-dir          vector  :inline)
   (turn-exit-dir           vector  :inline)
   (dest-circle             vector  :inline)
   (target-point            vector  :inline)
   )
  (:methods
    (vehicle-controller-method-9 (_type_) none)
    (vehicle-controller-method-10 (_type_ traffic-tracker) none)
    (vehicle-controller-method-11 (_type_) none)
    (vehicle-controller-method-12 (_type_ rigid-body-vehicle-constants vector float int float) none :behavior vehicle)
    (vehicle-controller-method-13 (_type_ nav-branch vector) none)
    (vehicle-controller-method-14 (_type_ vehicle) nav-branch)
    (vehicle-controller-method-15 (_type_) nav-branch)
    (vehicle-controller-method-16 (_type_ vector vector) none)
    (draw-debug-info (_type_) none)
    (vehicle-controller-method-18 (_type_ vector vector vehicle float) none)
    (vehicle-controller-method-19 (_type_ vector object vector vector) none)
    (vehicle-controller-method-20 (_type_ object float) none)
    (vehicle-controller-method-21 (_type_) none)
    )
  )


(deftype vehicle-section (structure)
  ((damage  float)
   )
  )


(deftype vehicle (rigid-body-object)
  ((self                      vehicle                      :override)
   (info                      rigid-body-vehicle-constants :override)
   (pad                       uint32                        2)
   (vehicle-jkhn1b23jn1       int64)
   (controls                  vehicle-controls              :inline)
   (prev-controls             vehicle-controls              :inline)
   (up-dir                    vector                        :inline)
   (jump-time                 float)
   (jump-thrust               float)
   (engine-thrust             float)
   (engine-power-factor       float)
   (force-scale               float)
   (target-distance2          meters)
   (pad0                      uint32)
   (target-acceleration       vector                        :inline)
   (impact-pos                vector                        :inline)
   (lin-acceleration          vector                        :inline)
   (hit-points                float)
   (damage-factor             float)
   (crash-level               int8)
   (force-level               int8)
   (traffic-hash-id           int8)
   (traffic-priority-id       int8)
   (power-fluctuation-factor  float)
   (power-level               float)
   (flight-level-index        int8)
   (flight-level-index-prev   int8)
   (overlap-player-counter    uint8)
   (physics-counter           uint8)
   (flight-level              float)
   (brake-factor              float)
   (cam-speed-interp          float)
   (camera-dist2              float)
   (player-dist2              float)
   (bound-radius              float)
   (rider-array               handle                        4)
   (lift-thrust               float                         2)
   (roll-thrust               float                         2)
   (sent-attack-time          time-frame)
   (air-time                  time-frame)
   (turn-time                 time-frame)
   (crash-time                time-frame)
   (transition-time           time-frame)
   (transition-end-time       time-frame)
   (turbo-boost-time          time-frame)
   (crash-duration            uint16)
   (turbo-boost-duration      uint16)
   (turbo-boost-factor        float)
   (crash-impulse             float)
   (water-height              float)
   (lights-factor             float)
   (outgoing-attack-id        uint32)
   (scrape-sound-id           sound-id)
   (engine-sound-id           sound-id)
   (thrust-sound-id           sound-id)
   (roll-sound-id             sound-id)
   (damage-pop-sound-id       sound-id)
   (damage-zap-sound-id       sound-id)
   (extra-sound-id            sound-id)
   (fog-fade                  float)
   (scrape-sound-envelope     float)
   (engine-sound-envelope     float)
   (engine-sound-factor       float)
   (sputter-sound-envelope    float)
   (rudder-sound-envelope     float)
   (fins-sound-envelope       float)
   (exhaust-part-accum        basic                         2)
   (smoke-part-accum          basic                         2)
   (controller                vehicle-controller            :inline)
   (section-array             vehicle-section               4 :inline)
   )
  (:state-methods
    inactive
    waiting
    vehicle-state-55
    vehicle-state-56
    player-control
    crash
    explode
    die
    measure-control-parameters
    )
  (:methods
    (alloc-and-init-rigid-body-control (_type_ rigid-body-vehicle-constants) none :replace)
    (vehicle-method-62 (_type_ float) none)
    (vehicle-method-63 (_type_ float) none)
    (vehicle-method-64 () none)
    (start-jump (_type_) none)
    (vehicle-method-66 (_type_) none)
    (get-seat-count (_type_) int)
    (compute-seat-position (_type_ vector int) none)
    (get-rider-in-seat (_type_ int) process)
    (vehicle-method-70 (_type_) process)
    (put-rider-in-seat (_type_ int process-focusable) none)
    (vehicle-method-72 (_type_) uint)
    (get-best-seat-for-vehicle (_type_ vector int int) int)
    (remove-rider (_type_ process) none)
    (vehicle-method-75 (_type_) float)
    (vehicle-method-76 (_type_ int uint) none)
    (vehicle-method-77 (_type_) none)
    (vehicle-method-78 (_type_ int) none)
    (vehicle-method-79 (_type_) none)
    (vehicle-method-80 (_type_) none)
    (vehicle-method-81 (_type_) none)
    (vehicle-method-82 (_type_) none)
    (vehicle-method-83 (_type_) none)
    (draw-thruster (_type_ vector vector float float) none)
    (draw-thrusters (_type_) none)
    (update-joint-mods (_type_) none)
    (vehicle-method-87 (_type_) none)
    (vehicle-method-88 (_type_) none)
    (vehicle-method-89 (_type_) none)
    (vehicle-method-90 (_type_) none)
    (vehicle-method-91 (_type_) none)
    (vehicle-method-92 (_type_) none)
    (vehicle-method-93 (_type_) none)
    (vehicle-method-94 (_type_) none)
    (vehicle-method-95 (_type_ vector) none)
    (vehicle-method-96 (_type_) none)
    (vehicle-method-97 (_type_) none)
    (vehicle-method-98 (_type_ float) none)
    (vehicle-method-99 (_type_ float) none)
    (vehicle-method-100 (_type_ float vehicle-physics-work) none)
    (vehicle-method-101 (_type_) none)
    (vehicle-method-102 (_type_) none)
    (vehicle-method-103 (_type_) none)
    (vehicle-method-104 (_type_) none)
    (vehicle-method-105 (_type_) symbol)
    (vehicle-method-106 (_type_) none)
    (vehicle-method-107 (_type_) none)
    (vehicle-method-108 (_type_) none)
    (vehicle-method-109 (_type_) none)
    (vehicle-method-110 (_type_) none)
    (vehicle-method-111 (_type_ object target) none)
    (decrease-traffic-alert-level (_type_ int) int)
    (vehicle-method-113 (_type_) none)
    (vehicle-method-114 (_type_) none)
    (vehicle-method-115 (_type_ vector) none)
    (vehicle-method-116 (_type_ (pointer vehicle-controls)) none)
    (vehicle-method-117 (_type_ vector int int) none)
    (vehicle-method-118 (_type_ int) none)
    (vehicle-method-119 (_type_) none)
    (vehicle-method-120 (_type_) none)
    (vehicle-method-121 (_type_) none)
    (vehicle-method-122 (_type_) none)
    (vehicle-method-123 (_type_) none)
    (vehicle-method-124 (_type_) none)
    (vehicle-method-125 (_type_ float) none)
    (vehicle-method-126 (_type_ float) none)
    (vehicle-method-127 (_type_) none)
    (vehicle-method-128 (_type_) none)
    (vehicle-method-129 (_type_) none)
    (vehicle-method-130 (_type_ traffic-object-spawn-params) none)
    (vehicle-method-131 (_type_) none)
    (vehicle-method-132 (_type_) none)
    (check-player-get-on (_type_) none)
    (vehicle-method-134 (_type_ process) none)
    (vehicle-method-135 (_type_ traffic-object-spawn-params) none)
    (vehicle-method-136 (_type_ traffic-object-spawn-params) none)
    (vehicle-method-137 (_type_ traffic-object-spawn-params) none)
    (vehicle-method-138 (_type_) none)
    (vehicle-method-139 (_type_) none)
    (vehicle-method-140 (_type_) none)
    (vehicle-method-141 (_type_) none)
    (vehicle-method-142 (_type_) none)
    (vehicle-method-143 (_type_) none)
    )
  )
