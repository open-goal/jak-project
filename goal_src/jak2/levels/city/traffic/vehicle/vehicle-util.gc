;;-*-Lisp-*-
(in-package goal)

;; name: vehicle-util.gc
;; name in dgo: vehicle-util
;; dgos: CWI

;; DECOMP BEGINS

(defmethod rigid-body-vehicle-constants-method-9 ((this rigid-body-vehicle-constants))
  (set! (-> this particle-system-2d) *sp-particle-system-2d*)
  (set! (-> this particle-system-3d) *sp-particle-system-3d*)
  (set! (-> this part-quat) *particle-quat*)
  (set! (-> this part-vel) *particle-vel*)
  (set! (-> this part-thruster) (-> *part-id-table* 775))
  (set! (-> this part-thruster-scale-x) (-> *part-id-table* 775 init-specs 3))
  (set! (-> this part-thruster-scale-y) (-> *part-id-table* 775 init-specs 4))
  0
  (none)
  )

(defmethod rigid-body-vehicle-constants-method-10 ((this rigid-body-vehicle-constants))
  0
  (none)
  )

(deftype vehicle-hud-request (structure)
  ((handle            handle)
   (hack-handle-init  basic  :overlay-at handle)
   (priority          float)
   )
  :pack-me
  )


(deftype vehicle-hud-requests (structure)
  ((time      time-frame)
   (requests  vehicle-hud-request  4 :inline)
   )
  :pack-me
  (:methods
    (vehicle-hud-requests-method-9 (_type_) none)
    (vehicle-hud-requests-method-10 (_type_) vehicle-hud-request)
    (vehicle-hud-requests-method-11 (_type_) vehicle-hud-request)
    )
  )


(defmethod vehicle-hud-requests-method-9 ((this vehicle-hud-requests))
  (dotimes (v1-0 4)
    (let ((a1-2 (-> this requests v1-0)))
      (set! (-> a1-2 handle) (the-as handle #f))
      (set! (-> a1-2 priority) 0.0)
      )
    )
  0
  (none)
  )

(defmethod vehicle-hud-requests-method-10 ((this vehicle-hud-requests))
  (let ((v1-0 0))
    (let ((f0-0 0.0))
      (countdown (a1-0 4)
        (let ((a2-2 (-> this requests a1-0)))
          (when (and (handle->process (-> a2-2 handle)) (< f0-0 (-> a2-2 priority)))
            (set! v1-0 a1-0)
            (set! f0-0 (-> a2-2 priority))
            )
          )
        )
      )
    (-> this requests v1-0)
    )
  )

(defmethod vehicle-hud-requests-method-11 ((this vehicle-hud-requests))
  (let ((v1-0 0))
    (let ((f0-0 (the-as float #x7f800000))
          (a1-1 4)
          )
      (b! #t cfg-10 :delay (nop!))
      (label cfg-1)
      (+! a1-1 -1)
      (let ((a2-2 (-> this requests a1-1)))
        (b! (handle->process (-> a2-2 handle)) cfg-8 :delay (empty-form))
        (set! v1-0 a1-1)
        (set! (-> a2-2 priority) 0.0)
        (b! #t cfg-12 :delay (nop!))
        (label cfg-8)
        (when (< (-> a2-2 priority) f0-0)
          (set! v1-0 a1-1)
          (set! f0-0 (-> a2-2 priority))
          )
        )
      (label cfg-10)
      (b! (nonzero? a1-1) cfg-1 :delay (nop!))
      )
    (label cfg-12)
    (-> this requests v1-0)
    )
  )

(deftype vehicle-hud-chooser (structure)
  ((cur   vehicle-hud-requests  :inline)
   (last  vehicle-hud-requests  :inline)
   )
  (:methods
    (vehicle-hud-chooser-method-9 (_type_ handle float) symbol)
    )
  )


(defmethod vehicle-hud-chooser-method-9 ((this vehicle-hud-chooser) (arg0 handle) (arg1 float))
  (let ((s3-0 (current-time)))
    (when (!= s3-0 (-> this cur time))
      (if (zero? (-> this cur time))
          (vehicle-hud-requests-method-9 (-> this cur))
          )
      (mem-copy! (the-as pointer (-> this last)) (the-as pointer (-> this cur)) 72)
      (set! (-> this cur time) s3-0)
      (vehicle-hud-requests-method-9 (-> this cur))
      )
    )
  (let ((v1-10 (vehicle-hud-requests-method-11 (-> this cur))))
    (when (< (-> v1-10 priority) arg1)
      (set! (-> v1-10 handle) arg0)
      (set! (-> v1-10 priority) arg1)
      )
    )
  (let ((s4-1 #f))
    (let ((v1-12 (vehicle-hud-requests-method-10 (-> this last))))
      (if (and (handle->process arg0) (= (-> v1-12 handle) arg0))
          (set! s4-1 #t)
          )
      )
    s4-1
    )
  )

(define *vehicle-hud-chooser* (new 'static 'vehicle-hud-chooser))

(define *pilot-edge-grab-info* (new 'static 'pilot-edge-grab-info))

(defmethod deactivate ((this vehicle))
  (vehicle-method-110 this)
  (call-parent-method this)
  (none)
  )

;; WARN: Return type mismatch entity-perm-status vs none.
(defmethod init-from-entity! ((this vehicle) (arg0 entity-actor))
  "Typically the method that does the initial setup on the process, potentially using the [[entity-actor]] provided as part of that.
This commonly includes things such as:
- stack size
- collision information
- loading the skeleton group / bones
- sounds"
  (process-entity-status! this (entity-perm-status dead) #t)
  (none)
  )

(defmethod rigid-body-object-method-35 ((this vehicle))
  (let ((t9-0 (method-of-type rigid-body-object rigid-body-object-method-35)))
    (t9-0 this)
    )
  (cond
    ((logtest? (-> this info flags) 2048)
     (set! (-> this rbody state force-callback) (method-of-object this vehicle-method-125))
     )
    ((logtest? (-> this info flags) 4096)
     (set! (-> this rbody state force-callback) (method-of-object this vehicle-method-126))
     )
    )
  (rigid-body-vehicle-constants-method-9 (-> this info))
  (none)
  )

(defmethod check-player-get-on ((this vehicle))
  (with-pp
    (let ((f0-0 (-> this player-dist2))
          (f1-0 102400.0)
          )
      (when (< f0-0 (* f1-0 f1-0))
        (let ((s5-0 (new 'stack-no-clear 'mystery-vehicle-type)))
          (set! (-> s5-0 floats 4) (+ 8192.0 (-> this root root-prim local-sphere w)))
          (if (logtest? (rigid-body-object-flag ai-driving) (-> this flags))
              (set! (-> s5-0 floats 4) (* 1.5 (-> s5-0 floats 4)))
              )
          (set! (-> s5-0 matrices 0 vector 1 quad) (-> (target-pos 0) quad))
          (+! (-> s5-0 matrices 0 vector 1 y) 8192.0)
          (let* ((v1-14 (-> s5-0 matrices 1))
                 (a3-0 (-> this node-list data 0 bone transform))
                 (a0-5 (-> a3-0 quad 0))
                 (a1-0 (-> a3-0 quad 1))
                 (a2-0 (-> a3-0 quad 2))
                 (a3-1 (-> a3-0 trans quad))
                 )
            (set! (-> v1-14 quad 0) a0-5)
            (set! (-> v1-14 quad 1) a1-0)
            (set! (-> v1-14 quad 2) a2-0)
            (set! (-> v1-14 trans quad) a3-1)
            )
          (set! (-> s5-0 matrices 0 vector 2 quad) (-> s5-0 matrices 1 trans quad))
          (set! (-> s5-0 floats 2) (- (-> s5-0 matrices 0 vector 1 y) (-> s5-0 matrices 0 vector 2 y)))
          (let ((f0-9 (vector-vector-xz-distance-squared (-> s5-0 matrices 0 vector 1) (-> s5-0 matrices 0 vector 2)))
                (f1-7 (-> s5-0 floats 4))
                )
            (when (and (< f0-9 (* f1-7 f1-7))
                       (< -81920.0 (-> s5-0 floats 2))
                       (< (-> s5-0 floats 2) 20480.0)
                       *target*
                       (not (focus-test? *target* dead grabbed in-head under-water pole flut tube pilot dark))
                       (or (not (focus-test? *target* edge-grab))
                           (logtest? (-> this flags) (rigid-body-object-flag player-edge-grabbing))
                           )
                       (-> *setting-control* user-current pilot)
                       (let ((a1-2 (new 'stack-no-clear 'event-message-block)))
                         (set! (-> a1-2 from) (process->ppointer pp))
                         (set! (-> a1-2 num-params) 1)
                         (set! (-> a1-2 message) 'query)
                         (set! (-> a1-2 param 0) (the-as uint 'mode))
                         (let ((v1-37 (send-event-function *target* a1-2)))
                           (and (or (= v1-37 #f) (= v1-37 'board))
                                (or (logtest? (-> this flags) (rigid-body-object-flag waiting-for-player))
                                    (-> *setting-control* user-current vehicle-hijacking)
                                    )
                                )
                           )
                         )
                       )
              (let ((s2-0 #f)
                    (s4-1 #f)
                    (s3-0 #f)
                    )
                (let ((a2-2 (get-best-seat-for-vehicle this (-> s5-0 matrices 0 vector 1) 1 0)))
                  (when (!= a2-2 -1)
                    (compute-seat-position this (-> s5-0 matrices 0 vector 2) a2-2)
                    (vector+float*!
                      (-> s5-0 matrices 0 vector 2)
                      (-> s5-0 matrices 0 vector 2)
                      (-> s5-0 matrices 1 vector 1)
                      4096.0
                      )
                    )
                  )
                (set! (-> s5-0 floats 1)
                      (vector-vector-distance-squared (-> s5-0 matrices 0 vector 2) (-> s5-0 matrices 0 vector 1))
                      )
                (let ((f0-14 (-> s5-0 floats 1))
                      (f1-12 81920.0)
                      )
                  (when (< f0-14 (* f1-12 f1-12))
                    (set! (-> s5-0 cquery start-pos quad) (-> s5-0 matrices 0 vector 1 quad))
                    (vector-! (-> s5-0 cquery move-dist) (-> s5-0 matrices 0 vector 2) (-> s5-0 matrices 0 vector 1))
                    (let ((v1-54 (-> s5-0 cquery)))
                      (set! (-> v1-54 radius) 4096.0)
                      (set! (-> v1-54 collide-with) (collide-spec
                                                      backgnd
                                                      crate
                                                      civilian
                                                      enemy
                                                      obstacle
                                                      hit-by-player-list
                                                      hit-by-others-list
                                                      player-list
                                                      collectable
                                                      blocking-plane
                                                      tobot
                                                      pusher
                                                      vehicle-mesh
                                                      obstacle-for-jak
                                                      )
                            )
                      (set! (-> v1-54 ignore-process0) this)
                      (set! (-> v1-54 ignore-process1) #f)
                      (set! (-> v1-54 ignore-pat) (new 'static 'pat-surface :noentity #x1 :nojak #x1 :probe #x1 :noendlessfall #x1))
                      (set! (-> v1-54 action-mask) (collide-action solid))
                      )
                    (set! s2-0 (< (fill-and-probe-using-line-sphere *collide-cache* (-> s5-0 cquery)) 0.0))
                    0
                    )
                  )
                (when s2-0
                  (when (and (or (< -14336.0 (-> s5-0 floats 2)) (logtest? (-> this flags) (rigid-body-object-flag player-edge-grabbing)))
                             (not (logtest? (rigid-body-object-flag no-hijack) (-> this flags)))
                             )
                    (set! s4-1 #t)
                    (set! (-> s5-0 floats 3) (* (-> this hit-points) (/ 40960.0 (sqrtf (-> s5-0 floats 1)))))
                    )
                  (when (and (not s4-1)
                             (and (< (-> s5-0 floats 2) -8192.0) (not (logtest? (-> *target* focus-status) (focus-status edge-grab))))
                             )
                    (matrix-4x4-inverse! (-> s5-0 matrices 2) (-> s5-0 matrices 1))
                    (vector-matrix*! (the-as vector (-> s5-0 matrices)) (-> s5-0 matrices 0 vector 1) (-> s5-0 matrices 2))
                    (set! (-> s5-0 floats 0) 81920.0)
                    (dotimes (s2-1 (-> this info grab-rail-count))
                      (let ((s1-0 (-> this info grab-rail-array s2-1)))
                        (vector-! (-> s5-0 matrices 0 trans) (the-as vector (-> s5-0 matrices)) (the-as vector (-> s1-0 local-pos)))
                        (when #t
                          (let ((f30-0 (vector-segment-distance-point!
                                         (the-as vector (-> s5-0 matrices))
                                         (the-as vector (-> s1-0 local-pos))
                                         (-> s1-0 local-pos 1)
                                         (-> s5-0 matrices 0 trans)
                                         )
                                       )
                                )
                            (when (< f30-0 (-> s5-0 floats 0))
                              (set! (-> s5-0 floats 0) f30-0)
                              (set! (-> s5-0 vectors 0 quad) (-> s5-0 matrices 0 trans quad))
                              (vector-! (-> s5-0 vectors 1) (-> s1-0 local-pos 1) (the-as vector (-> s1-0 local-pos)))
                              (vector-normalize! (-> s5-0 vectors 1) 1.0)
                              (set! s3-0 #t)
                              (set! (-> s5-0 floats 3) (* (-> this hit-points) (/ 40960.0 f30-0)))
                              )
                            )
                          )
                        )
                      0
                      )
                    )
                  (set! s3-0 (or s4-1 s3-0))
                  (when (and s3-0 (and (vehicle-hud-chooser-method-9 *vehicle-hud-chooser* (process->handle this) (-> s5-0 floats 3))
                                       (can-display-query? this (the-as string #f) (/ 1.0 (-> s5-0 floats 3)))
                                       )
                             )
                    (let ((s3-1
                            (new 'stack 'font-context *font-default-matrix* 32 320 0.0 (font-color default) (font-flags shadow kerning))
                            )
                          )
                      (let ((v1-97 s3-1))
                        (set! (-> v1-97 width) (the float 340))
                        )
                      (let ((v1-98 s3-1))
                        (set! (-> v1-98 height) (the float 80))
                        )
                      (let ((v1-99 s3-1))
                        (set! (-> v1-99 scale) 0.9)
                        )
                      (set! (-> s3-1 flags) (font-flags shadow kerning large))
                      (print-game-text
                        (lookup-text! *common-text* (text-id press-triangle-to-use) #f)
                        s3-1
                        #f
                        44
                        (bucket-id progress)
                        )
                      )
                    (when (cpad-pressed? 0 triangle)
                      (cond
                        (s4-1
                          (when (send-event *target* 'change-mode 'pilot this 0 #f)
                            (logior! (-> this flags) (rigid-body-object-flag player-driving))
                            (logclear! (-> this flags) (rigid-body-object-flag ai-driving))
                            (vehicle-method-87 this)
                            )
                          )
                        (else
                          (set! (-> s5-0 handles 0) (process->handle this))
                          (mem-copy! (the-as pointer *pilot-edge-grab-info*) (the-as pointer (-> s5-0 vectors)) 40)
                          (if (send-event *target* 'pilot-edge-grab *pilot-edge-grab-info*)
                              (format 0 "vehicle::check-player-get-on: (send-event *target* 'pilot-edge-grab self)~%")
                              )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          )
        )
      )
    (cond
      ((and (logtest? (-> this flags) (rigid-body-object-flag player-driving)) *target* (!= (-> this crash-level) 3))
       (when (focus-test? *target* pilot-riding)
         (vehicle-controller-method-11 (-> this controller))
         (vehicle-method-138 this)
         )
       )
      (else
        (vehicle-method-88 this)
        )
      )
    0
    (none)
    )
  )

(defmethod vehicle-method-110 ((this vehicle))
  (sound-stop (-> this scrape-sound-id))
  (sound-stop (-> this engine-sound-id))
  (sound-stop (-> this thrust-sound-id))
  (set! (-> this scrape-sound-envelope) 0.0)
  (set! (-> this engine-sound-envelope) 0.0)
  0
  (none)
  )

(defmethod vehicle-method-62 ((this vehicle) (arg0 float))
  (if (not (logtest? (rigid-body-object-flag ai-driving measure-control-parameters) (-> this flags)))
      (set! (-> this controls steering) (fmax -1.0 (fmin 1.0 arg0)))
      )
  0
  (none)
  )

(defmethod vehicle-method-63 ((this vehicle) (arg0 float))
  (if (not (logtest? (rigid-body-object-flag ai-driving measure-control-parameters) (-> this flags)))
      (set! (-> this controls throttle) (fmax -0.5 (fmin 1.0 arg0)))
      )
  0
  (none)
  )

(defmethod vehicle-method-98 ((this vehicle) (arg0 float))
  (let* ((v1-1 (-> this rbody state lin-velocity))
         (f0-4 (sqrtf (+ (* (-> v1-1 x) (-> v1-1 x)) (* (-> v1-1 z) (-> v1-1 z)))))
         (f0-6 (/ (- arg0 f0-4) arg0))
         (f1-6 (* 0.005 f0-6))
         )
    (set! (-> this controls throttle) (fmax 0.0 (fmin 1.0 (+ (-> this controls throttle) f1-6))))
    )
  0
  (none)
  )

(defmethod start-jump ((this vehicle))
  (when (logtest? (-> this info flags) 16)
    (when (not (logtest? (rigid-body-object-flag jump-sound) (-> this flags)))
      (logior! (-> this flags) (rigid-body-object-flag jump-sound))
      (sound-play "bike-hop")
      )
    (logior! (-> this flags) (rigid-body-object-flag jump))
    )
  0
  (none)
  )

(defmethod vehicle-method-66 ((this vehicle))
  0
  (none)
  )

(defmethod get-seat-count ((this vehicle))
  (-> this info seat-count)
  )

(defmethod compute-seat-position ((this vehicle) (arg0 vector) (arg1 int))
  (let ((v1-0 (new 'stack-no-clear 'vector)))
    (set! (-> v1-0 quad) (-> this info seat-array arg1 position quad))
    (set! (-> v1-0 w) 1.0)
    (vector-matrix*! arg0 v1-0 (-> this node-list data 0 bone transform))
    )
  0
  (none)
  )

(defmethod get-rider-in-seat ((this vehicle) (arg0 int))
  (let ((v0-0 (the-as process #f)))
    (if (< arg0 (-> this info seat-count))
        (set! v0-0 (handle->process (-> this rider-array arg0)))
        )
    v0-0
    )
  )

(defmethod vehicle-method-70 ((this vehicle))
  (let ((gp-0 (the-as process #f)))
    (countdown (s4-0 (-> this info seat-count))
      (when (logtest? (-> this info seat-array s4-0 flags) 1)
        (let ((v1-7 (get-rider-in-seat this s4-0)))
          (if v1-7
              (set! gp-0 v1-7)
              )
          )
        )
      )
    gp-0
    )
  )

(defmethod get-best-seat-for-vehicle ((this vehicle) (arg0 vector) (arg1 int) (arg2 int))
  (let ((gp-0 -1))
    (let ((f30-0 (the-as float #x7f800000))
          (s1-0 (new 'stack-no-clear 'vector))
          )
      (countdown (s0-0 (-> this info seat-count))
        (when (logtest? arg1 (-> this info seat-array s0-0 flags))
          (let ((v1-7 arg2))
            (when (cond
                    ((zero? v1-7)
                     #t
                     )
                    ((= v1-7 1)
                     (not (get-rider-in-seat this s0-0))
                     )
                    ((= v1-7 2)
                     (get-rider-in-seat this s0-0)
                     )
                    (else
                      #f
                      )
                    )
              (compute-seat-position this s1-0 s0-0)
              (let ((f0-0 (vector-vector-distance-squared arg0 s1-0)))
                (when (< f0-0 f30-0)
                  (set! f30-0 f0-0)
                  (set! gp-0 s0-0)
                  )
                )
              )
            )
          )
        )
      )
    gp-0
    )
  )

(defmethod remove-rider ((this vehicle) (arg0 process))
  (let ((v1-1 (-> this info seat-count)))
    (dotimes (a2-0 v1-1)
      (if (= arg0 (handle->process (-> this rider-array a2-0)))
          (set! (-> this rider-array a2-0) (the-as handle #f))
          )
      )
    )
  0
  (none)
  )

(defmethod put-rider-in-seat ((this vehicle) (arg0 int) (arg1 process-focusable))
  (if (< arg0 (-> this info seat-count))
      (set! (-> this rider-array arg0) (process->handle arg1))
      )
  0
  (none)
  )

(defmethod vehicle-method-117 ((this vehicle) (arg0 vector) (arg1 int) (arg2 int))
  (let ((v1-0 (new 'stack-no-clear 'vector)))
    (vector+! v1-0 (-> this info seat-array arg1 position) (-> this info rider-hand-offset arg2))
    (vector-matrix*! arg0 v1-0 (-> this node-list data 0 bone transform))
    )
  0
  (none)
  )

(defmethod vehicle-method-72 ((this vehicle))
  (-> this info rider-stance)
  )

(defmethod vehicle-method-75 ((this vehicle))
  (-> this controls steering)
  )

(defmethod vehicle-method-115 ((this vehicle) (arg0 vector))
  (set! (-> arg0 quad) (-> this lin-acceleration quad))
  0
  (none)
  )

(defmethod vehicle-method-116 ((this vehicle) (arg0 (pointer vehicle-controls)))
  (mem-copy! arg0 (the-as pointer (-> this controls)) 16)
  0
  (none)
  )

(defmethod apply-damage ((this vehicle) (arg0 float) (arg1 rigid-body-impact))
  (cond
    (#f
      )
    (else
      (case (-> arg1 pat event)
        (((pat-event melt))
         (set! arg0 (* 10.0 arg0))
         (format #t "vehicle::apply-damage: hit melt (damage ~f)~%" arg0)
         )
        )
      (#when PC_PORT
        ;; og:preserve-this vehicle invuln cheats
        (when (and (pc-cheats? (-> *pc-settings* cheats) vehicle-invuln)
                   *target*
                   (focus-test? *target* pilot)
                   (nonzero? (-> *target* pilot))
                   (= this (handle->process (-> *target* pilot vehicle))))
          (if (!= (-> arg1 pat event) (pat-event melt))
              (set! arg0 0.0))
          )
        )
      (set! (-> this hit-points) (- (-> this hit-points) (* arg0 (-> this damage-factor))))
      (let ((s4-1 (-> arg1 prim-id))
            (s3-0 0)
            )
        (while (nonzero? s4-1)
          (when (and (logtest? s4-1 1) (< s3-0 (-> this info section-count)))
            (let ((v1-14 (-> this section-array s3-0)))
              (+! (-> v1-14 damage) (* 4.0 (-> this damage-factor) arg0))
              )
            (vehicle-method-118 this s3-0)
            )
          (set! s4-1 (shr s4-1 1))
          (+! s3-0 1)
          )
        )
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-118 ((this vehicle) (arg0 int))
  (let* ((v1-2 (-> this section-array arg0))
         (s4-0 (-> this info section-array arg0))
         (s5-1
           (max
             0
             (min (the int (* (-> v1-2 damage) (the float (-> s4-0 damage-seg-count)))) (+ (-> s4-0 damage-seg-count) -1))
             )
           )
         )
    (let ((a2-0 0))
      (dotimes (v1-6 (-> s4-0 damage-seg-count))
        (if (!= v1-6 s5-1)
            (set! a2-0 (logior a2-0 (-> s4-0 damage-seg-array v1-6)))
            )
        )
      (setup-masks (-> this draw) 0 a2-0)
      )
    (setup-masks (-> this draw) (the-as int (-> s4-0 damage-seg-array s5-1)) 0)
    (when (> s5-1 0)
      (if (not (logtest? (rigid-body-object-flag lights-dead) (-> this flags)))
          (sound-play "headlight-pop")
          )
      (set! (-> this flags)
            (the-as rigid-body-object-flag (logior (rigid-body-object-flag lights-dead) (-> this flags)))
            )
      (vehicle-method-132 this)
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-82 ((this vehicle))
  (set! (-> this flags) (the-as rigid-body-object-flag (logclear (-> this flags) (rigid-body-object-flag
                                                                                   disturbed
                                                                                   damaged
                                                                                   dead
                                                                                   player-touching
                                                                                   player-edge-grabbing
                                                                                   player-standing-on
                                                                                   persistent
                                                                                   in-air
                                                                                   riding
                                                                                   player-driving
                                                                                   waiting-for-player
                                                                                   ignition
                                                                                   turbo-boost
                                                                                   reverse-gear
                                                                                   slide
                                                                                   hard-turn
                                                                                   jump
                                                                                   ai-driving
                                                                                   flight-level-transition
                                                                                   alert
                                                                                   in-pursuit
                                                                                   target-in-sight
                                                                                   rammed-target
                                                                                   lights-on
                                                                                   lights-update
                                                                                   lights-dead
                                                                                   )
                                                                 )
                                )
        )
  (set! (-> this vehicle-jkhn1b23jn1) (the-as int (-> this flags)))
  (logior! (-> this rbody state flags) (rigid-body-flag active))
  (logclear! (-> this focus-status) (focus-status disable dead inactive))
  (rigid-body-object-method-35 this)
  (rigid-body-object-method-39 this)
  (vehicle-method-103 this)
  (set! (-> this hit-points) 1.0)
  (set! (-> this damage-factor) (-> this info damage-factor))
  (set! (-> this crash-level) 0)
  (set! (-> this power-fluctuation-factor) 0.02)
  (set! (-> this power-level) 1.0)
  (set! (-> this flight-level-index) 0)
  (let ((a1-0 (-> this root trans)))
    (set! (-> this flight-level) (get-height-at-point *traffic-height-map* a1-0))
    )
  (set! (-> this lights-factor) 0.0)
  (let ((a0-8 (-> this info color-option-select)))
    (set! (-> this draw color-mult quad) (-> this info color-option-array a0-8 quad))
    )
  (+! (-> this info color-option-select) 1)
  (when (>= (-> this info color-option-select) (-> this info color-option-count))
    (set! (-> this info color-option-select) 0)
    0
    )
  (dotimes (s5-0 (-> this info section-count))
    (let ((v1-34 (-> this section-array s5-0)))
      (set! (-> v1-34 damage) 0.0)
      )
    (vehicle-method-118 this s5-0)
    )
  0
  (none)
  )

(defmethod vehicle-method-101 ((this vehicle))
  (set! (-> this hit-points) 1.0)
  0
  (none)
  )

(defmethod vehicle-method-134 ((this vehicle) (arg0 process))
  "Stubbed"
  0
  (none)
  )

(defmethod vehicle-method-76 ((this vehicle) (arg0 int) (arg1 uint))
  (when (< (-> this crash-level) arg0)
    (set! (-> this crash-level) arg0)
    (set! (-> this crash-duration) arg1)
    (set-time! (-> this crash-time))
    (set! (-> this force-scale) 0.0)
    (when (>= (-> this crash-level) 2)
      (sound-play "bike-engine-off")
      (vehicle-method-83 this)
      )
    )
  (when (and (>= 0.0 (-> this hit-points)) (!= (-> this crash-level) 3))
    (logior! (-> this flags) (rigid-body-object-flag dead))
    (set! (-> this crash-level) 3)
    (set! (-> this crash-duration) (the-as uint 1500))
    (set-time! (-> this crash-time))
    )
  0
  (none)
  )

(defmethod vehicle-method-77 ((this vehicle))
  (set! (-> this crash-level) 0)
  0
  (none)
  )

(defmethod vehicle-method-78 ((this vehicle) (arg0 int))
  (set! (-> this flight-level-index-prev) (-> this flight-level-index))
  (set! (-> this flight-level-index) arg0)
  (logior! (-> this flags) (rigid-body-object-flag flight-level-transition camera-rapid-track-mode))
  (logclear! (-> this flags) (rigid-body-object-flag flight-level-transition-ending))
  (set-time! (-> this transition-time))
  (vehicle-method-91 this)
  0
  (none)
  )

(defmethod vehicle-method-79 ((this vehicle))
  (logclear! (-> this flags) (rigid-body-object-flag flight-level-transition))
  (logior! (-> this flags) (rigid-body-object-flag flight-level-transition-ending))
  (set-time! (-> this transition-end-time))
  0
  (none)
  )

(defmethod vehicle-method-131 ((this vehicle))
  (if (not (logtest? (rigid-body-object-flag lights-dead) (-> this flags)))
      (set! (-> this flags)
            (the-as rigid-body-object-flag (logior (rigid-body-object-flag lights-on lights-update) (-> this flags)))
            )
      )
  0
  (none)
  )

(defmethod vehicle-method-132 ((this vehicle))
  (set! (-> this flags)
        (the-as rigid-body-object-flag (logclear (-> this flags) (rigid-body-object-flag lights-on)))
        )
  (set! (-> this flags)
        (the-as rigid-body-object-flag (logior (rigid-body-object-flag lights-update) (-> this flags)))
        )
  0
  (none)
  )

(defmethod vehicle-method-139 ((this vehicle))
  (when (not (logtest? (rigid-body-object-flag ignition) (-> this flags)))
    (logior! (-> this flags) (rigid-body-object-flag ignition))
    (sound-play "vehicl-ignition")
    (let ((s5-1 (-> this node-list data 0 bone transform))
          (s4-1 (new 'stack-no-clear 'merc-matrix))
          )
      (set-vector! (-> s4-1 vector 2) 0.0 1.0 0.0 1.0)
      (mem-copy! (the-as pointer (-> s4-1 vector 4)) (the-as pointer s5-1) 64)
      (dotimes (s3-0 2)
        (vector-matrix*! (the-as vector (-> s4-1 vector)) (-> this info exhaust-local-pos s3-0) s5-1)
        (vector-rotate*! (-> s4-1 vector 1) (-> this info exhaust-local-dir s3-0) s5-1)
        (vector-cross! (-> s4-1 vector 3) (-> s4-1 vector 1) (-> s4-1 vector 2))
        (vector-normalize! (-> s4-1 vector 3) 1.0)
        (vector-cross! (-> s4-1 vector 6) (-> s4-1 vector 3) (-> s4-1 vector 1))
        (set! (-> s4-1 vector 4 quad) (-> s4-1 vector 3 quad))
        (set! (-> s4-1 vector 5 quad) (-> s4-1 vector 1 quad))
        (set! (-> s4-1 vector 6 quad) (-> s4-1 vector 2 quad))
        (set! (-> s4-1 vector 7 quad) (-> s4-1 vector 0 quad))
        (process-spawn
          part-tracker
          :init part-tracker-init
          (-> *part-group-id-table* 162)
          0
          #f
          #f
          #f
          (-> s4-1 vector 4)
          :to *entity-pool*
          )
        )
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-140 ((this vehicle))
  (if (logtest? (rigid-body-object-flag ignition) (-> this flags))
      (logclear! (-> this flags) (rigid-body-object-flag ignition))
      )
  0
  (none)
  )

(defmethod vehicle-method-141 ((this vehicle))
  (let ((a0-2 (find-nearest-nav-mesh (-> this root trans) (the-as float #x7f800000))))
    (when a0-2
      (add-process-drawable-to-navmesh a0-2 this #t)
      (logclear! (-> this nav flags) (nav-control-flag output-sphere-hash))
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-142 ((this vehicle))
  (let ((v1-0 (-> this nav)))
    (when v1-0
      (remove-process-drawable (-> v1-0 state mesh) this)
      (set! (-> this nav) #f)
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-143 ((this vehicle))
  (let ((v1-2 (or (logtest? (-> this flags) (rigid-body-object-flag dead waiting-for-player))
                  (and (logtest? (rigid-body-object-flag player-driving ai-driving) (-> this flags))
                       (not (logtest? (-> this flags) (rigid-body-object-flag on-flight-level)))
                       )
                  )
              )
        (s5-0 (-> this nav))
        )
    (cond
      (v1-2
        (cond
          (s5-0
            (do-navigation-to-destination (-> s5-0 state) (-> this root trans))
            (when (not (logtest? (-> s5-0 state flags) (nav-state-flag in-mesh)))
              (let ((a0-6 (find-nearest-nav-mesh (-> this root trans) (the-as float #x7f800000))))
                (when (and a0-6 (!= a0-6 (-> s5-0 state mesh)))
                  (change-to a0-6 this)
                  (logclear! (-> this nav flags) (nav-control-flag output-sphere-hash))
                  )
                )
              )
            )
          (else
            (vehicle-method-141 this)
            )
          )
        )
      (else
        (if s5-0
            (vehicle-method-142 this)
            )
        )
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-87 ((this vehicle))
  (when (not (logtest? (rigid-body-object-flag camera) (-> this flags)))
    (logior! (-> this flags) (rigid-body-object-flag camera))
    (set! (-> this cam-speed-interp) 0.0)
    (set-setting! 'string-min-height 'abs (-> this info camera-string-min-height) 0)
    (set-setting! 'string-max-height 'abs (-> this info camera-string-max-height) 0)
    (set-setting! 'head-offset 'abs (-> this info camera-head-offset) 0)
    (set-setting! 'foot-offset 'abs (-> this info camera-foot-offset) 0)
    (set-setting! 'target-height 'abs (meters 0) 0)
    (vehicle-method-92 this)
    (vehicle-method-89 this)
    (persist-with-delay *setting-control* 'mode-name (seconds 0.2) 'mode-name 'cam-fixed 0.0 0)
    (persist-with-delay *setting-control* 'interp-time (seconds 0.05) 'interp-time 'abs 0.0 0)
    (let ((v1-27 (process->ppointer this)))
      (persist-with-delay
        *setting-control*
        'butt-handle
        (seconds 1)
        'butt-handle
        (the-as symbol v1-27)
        32768.0
        (-> v1-27 0 pid)
        )
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-88 ((this vehicle))
  (when (logtest? (rigid-body-object-flag camera) (-> this flags))
    (vehicle-method-92 this)
    (vehicle-method-90 this)
    (remove-setting! 'rapid-tracking)
    (remove-setting! 'fov)
    (remove-setting! 'string-camera-ceiling)
    (remove-setting! 'string-min-height)
    (remove-setting! 'string-max-height)
    (remove-setting! 'string-min-length)
    (remove-setting! 'string-max-length)
    (remove-setting! 'extra-follow-height)
    (remove-setting! 'head-offset)
    (remove-setting! 'foot-offset)
    (remove-setting! 'target-height)
    (remove-setting! 'slave-options)
    (remove-setting! 'vertical-follow-matches-camera)
    (persist-with-delay *setting-control* 'mode-name (seconds 0.05) 'mode-name 'cam-decel 0.0 0)
    (persist-with-delay *setting-control* 'interp-time (seconds 0.05) 'interp-time 'hi 0.0 0)
    (persist-with-delay *setting-control* 'interp-time (seconds 0.1) 'interp-time 'lo 300.0 0)
    (persist-with-delay
      *setting-control*
      'immediate-string-min-max
      (seconds 0.05)
      'immediate-string-min-max
      #f
      0.0
      0
      )
    (logclear! (-> this flags) (rigid-body-object-flag camera))
    )
  0
  (none)
  )

(defmethod vehicle-method-89 ((this vehicle))
  (when (not (logtest? (rigid-body-object-flag camera-bike-mode) (-> this flags)))
    (logior! (-> this flags) (rigid-body-object-flag camera-bike-mode))
    (set-setting! 'bike-mode #f 0.0 0)
    )
  0
  (none)
  )

(defmethod vehicle-method-90 ((this vehicle))
  (when (logtest? (rigid-body-object-flag camera-bike-mode) (-> this flags))
    (logclear! (-> this flags) (rigid-body-object-flag camera-bike-mode))
    (remove-setting! 'bike-mode)
    )
  0
  (none)
  )

(defmethod vehicle-method-91 ((this vehicle))
  (when (logtest? (-> this flags) (rigid-body-object-flag player-driving))
    (logior! (-> this flags) (rigid-body-object-flag camera-rapid-track-mode))
    (set-setting! 'rapid-tracking #f 0.0 0)
    )
  0
  (none)
  )

(defmethod vehicle-method-92 ((this vehicle))
  (when (logtest? (-> this flags) (rigid-body-object-flag player-driving))
    (logclear! (-> this flags) (rigid-body-object-flag camera-rapid-track-mode))
    (remove-setting! 'rapid-tracking)
    )
  0
  (none)
  )

(defmethod rigid-body-object-method-40 ((this vehicle))
  (logior! (-> this flags) (rigid-body-object-flag enable-collision))
  (let ((v1-3 (-> this root root-prim)))
    (set! (-> v1-3 prim-core collide-as) (-> this root backup-collide-as))
    (set! (-> v1-3 prim-core collide-with) (-> this root backup-collide-with))
    )
  0
  (none)
  )

(defmethod rigid-body-object-method-41 ((this vehicle))
  (logclear! (-> this flags) (rigid-body-object-flag enable-collision))
  (let ((v1-3 (-> this root root-prim)))
    (set! (-> v1-3 prim-core collide-as) (collide-spec))
    (set! (-> v1-3 prim-core collide-with) (collide-spec))
    )
  0
  0
  (none)
  )

(defmethod vehicle-method-102 ((this vehicle))
  (let ((v1-1 (-> this draw shadow-ctrl)))
    (logclear! (-> v1-1 settings flags) (shadow-flags disable-draw))
    )
  0
  0
  (none)
  )

(defmethod vehicle-method-103 ((this vehicle))
  (let ((v1-1 (-> this draw shadow-ctrl)))
    (logior! (-> v1-1 settings flags) (shadow-flags disable-draw))
    )
  0
  0
  (none)
  )

(defmethod rigid-body-object-method-38 ((this vehicle))
  (when (not (logtest? (-> this rbody state flags) (rigid-body-flag enable-physics)))
    (logior! (-> this rbody state flags) (rigid-body-flag enable-physics))
    (rigid-body-method-26 (-> this rbody state) (-> this root trans) (-> this root quat))
    (vector-float*! (-> this rbody state lin-momentum) (-> this root transv) (-> this info info mass))
    (vector-reset! (-> this rbody state ang-momentum))
    (vector-reset! (-> this lin-acceleration))
    )
  0
  (none)
  )

(defmethod rigid-body-object-method-39 ((this vehicle))
  (set! (-> this force-scale) 1.0)
  (logclear! (-> this rbody state flags) (rigid-body-flag enable-physics))
  (vehicle-method-110 this)
  0
  (none)
  )

(defmethod vehicle-method-111 ((this vehicle) (arg0 object) (arg1 target))
  (let ((a0-1 (-> this controller traffic)))
    (when (and (nonzero? a0-1) arg1)
      (if #t
          (increase-alert-level a0-1 (the-as int arg0) arg1)
          )
      )
    )
  0
  (none)
  )

(defmethod decrease-traffic-alert-level ((this vehicle) (arg0 int))
  (decrease-alert-level (-> this controller traffic) arg0)
  0
  )

(defmethod vehicle-method-80 ((this vehicle))
  (when (and (logtest? (-> this info flags) 64) (< (-> this flight-level-index) 1))
    1
    (cond
      ((< (+ 8192.0 (-> this rbody state position y)) (-> this flight-level))
       (sound-play "bike-up")
       (vehicle-method-78 this 1)
       )
      (else
        (set! (-> this flight-level-index) 1)
        )
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-81 ((this vehicle))
  (when (and (logtest? (-> this info flags) 64) (> (-> this flight-level-index) 0))
    (sound-play "bike-down")
    (vehicle-method-78 this 0)
    )
  0
  (none)
  )

(defmethod vehicle-method-83 ((this vehicle))
  (logclear! (-> this flags) (rigid-body-object-flag flight-level-transition))
  (vehicle-method-92 this)
  (set! (-> this flight-level-index) 0)
  0
  (none)
  )

(defmethod vehicle-method-108 ((this vehicle))
  (vehicle-controller-method-11 (-> this controller))
  (set! (-> this flags)
        (the-as rigid-body-object-flag (logior (rigid-body-object-flag persistent in-pursuit) (-> this flags)))
        )
  (logior! (-> this controller flags) (vehicle-controller-flag ignore-others))
  0
  (none)
  )

(defmethod vehicle-method-109 ((this vehicle))
  (set! (-> this flags)
        (the-as rigid-body-object-flag (logclear (-> this flags) (rigid-body-object-flag in-pursuit)))
        )
  (logclear! (-> this controller flags) (vehicle-controller-flag ignore-others direct-mode))
  (vehicle-method-107 this)
  0
  (none)
  )

(defmethod rigid-body-object-method-42 ((this vehicle))
  (if (and (not (focus-test? this inactive))
           (not (and (-> this next-state) (= (-> this next-state name) 'explode)))
           )
      ((method-of-type rigid-body-object rigid-body-object-method-42) this)
      )
  0
  (none)
  )

(defmethod vehicle-method-113 ((this vehicle))
  (vehicle-method-127 this)
  (logior! (-> this focus-status) (focus-status inactive))
  (set! (-> this event-hook) (-> (method-of-object this inactive) event))
  (go (method-of-object this inactive))
  0
  (none)
  )

(defmethod vehicle-method-114 ((this vehicle))
  (if (focus-test? this inactive)
      (vehicle-method-128 this)
      )
  (go (method-of-object this active))
  0
  (none)
  )

(defmethod rigid-body-object-method-43 ((this vehicle))
  (go (method-of-object this waiting))
  0
  (none)
  )

(defmethod vehicle-method-138 ((this vehicle))
  (go (method-of-object this player-control))
  0
  (none)
  )

;; WARN: Return type mismatch object vs none.
(defmethod vehicle-method-130 ((this vehicle) (arg0 traffic-object-spawn-params))
  (let ((v1-0 (-> arg0 behavior)))
    (cond
      ((zero? v1-0)
       (vehicle-method-82 this)
       (logior! (-> this flags) (rigid-body-object-flag persistent))
       (logclear! (-> this draw status) (draw-control-status no-draw))
       (logior! (-> this skel status) (joint-control-status sync-math))
       (ja-post)
       (update-transforms (-> this root))
       (logclear! (-> this skel status) (joint-control-status sync-math))
       (go (method-of-object this idle))
       )
      ((= v1-0 2)
       (let ((a1-1 (-> arg0 nav-branch)))
         (if a1-1
             (vehicle-controller-method-13 (-> this controller) a1-1 (-> this root trans))
             )
         )
       (vehicle-method-128 this)
       (go (method-of-object this active))
       )
      (else
        (vehicle-method-113 this)
        )
      )
    )
  (none)
  )

(defmethod vehicle-method-136 ((this vehicle) (arg0 traffic-object-spawn-params))
  (let ((v1-0 (-> arg0 behavior)))
    (cond
      ((= v1-0 1)
       (vehicle-method-135 this arg0)
       (vehicle-method-113 this)
       )
      ((zero? v1-0)
       (go (method-of-object this idle))
       )
      ((= v1-0 4)
       (go (method-of-object this player-control))
       )
      (else
        (go (method-of-object this idle))
        )
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-127 ((this vehicle))
  (let ((s5-0 (-> this child)))
    (while s5-0
      (send-event (ppointer->process s5-0) 'traffic-off)
      (set! s5-0 (-> s5-0 0 brother))
      )
    )
  (dotimes (s5-1 (-> this info seat-count))
    (put-rider-in-seat this s5-1 (the-as process-focusable #f))
    )
  (vehicle-method-142 this)
  (vehicle-controller-method-11 (-> this controller))
  (vehicle-method-110 this)
  0
  (none)
  )

(defmethod vehicle-method-128 ((this vehicle))
  (vehicle-method-82 this)
  (set! (-> this root trans y) (-> this flight-level))
  (logior! (-> this flags) (rigid-body-object-flag ignition ai-driving))
  (let ((gp-1 (-> this child)))
    (while gp-1
      (send-event (ppointer->process gp-1) 'traffic-on)
      (set! gp-1 (-> gp-1 0 brother))
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-129 ((this vehicle))
  (if (= this *debug-actor*)
      (format #t "hook-dead~%")
      )
  (logior! (-> this focus-status) (focus-status dead))
  (vehicle-controller-method-11 (-> this controller))
  (vehicle-method-140 this)
  (set! (-> this flags)
        (the-as
          rigid-body-object-flag
          (logclear (-> this flags) (rigid-body-object-flag riding player-driving in-pursuit target-in-sight))
          )
        )
  (set! (-> this controls throttle) 0.0)
  (set! (-> this controls steering) 0.0)
  (vehicle-method-83 this)
  0
  (none)
  )

(defmethod vehicle-method-137 ((this vehicle) (arg0 traffic-object-spawn-params))
  (vehicle-rider-spawn this citizen-norm-rider arg0)
  0
  (none)
  )

(defmethod vehicle-method-105 ((this vehicle))
  (logtest? (rigid-body-object-flag disturbed player-touching player-driving in-pursuit) (-> this flags))
  )

(defmethod vehicle-method-106 ((this vehicle))
  (local-vars (v1-13 float) (v1-25 float) (v1-30 float))
  (rlet ((acc :class vf)
         (vf0 :class vf)
         (vf1 :class vf)
         (vf2 :class vf)
         )
    (init-vf0-vector)
    (when (time-elapsed? (-> this disturbed-time) (seconds 2))
      (cond
        ((logtest? (rigid-body-object-flag ai-driving) (-> this flags))
         (when (and (not (logtest? (-> this controller flags) (vehicle-controller-flag off-path)))
                    (>= (-> this rbody state matrix vector 1 y) (cos 910.2222))
                    )
           (.lvf vf1 (&-> (-> this rbody state ang-velocity) quad))
           (.add.w.vf vf2 vf0 vf0 :mask #b1)
           (.mul.vf vf1 vf1 vf1)
           (.mul.x.vf acc vf2 vf1 :mask #b1)
           (.add.mul.y.vf acc vf2 vf1 acc :mask #b1)
           (.add.mul.z.vf vf1 vf2 vf1 acc :mask #b1)
           (.mov v1-13 vf1)
           (let ((f0-1 v1-13)
                 (f1-0 0.5)
                 )
             (if (< f0-1 (* f1-0 f1-0))
                 (logclear! (-> this flags) (rigid-body-object-flag disturbed))
                 )
             )
           )
         )
        (else
          (when (>= (-> this rbody state matrix vector 1 y) (cos 910.2222))
            (let* ((f0-3 (-> this camera-dist2))
                   (f1-3 0.000024414063)
                   (f0-4 (* f0-3 (* f1-3 f1-3)))
                   )
              (.lvf vf1 (&-> (-> this rbody state ang-velocity) quad))
              (.add.w.vf vf2 vf0 vf0 :mask #b1)
              (.mul.vf vf1 vf1 vf1)
              (.mul.x.vf acc vf2 vf1 :mask #b1)
              (.add.mul.y.vf acc vf2 vf1 acc :mask #b1)
              (.add.mul.z.vf vf1 vf2 vf1 acc :mask #b1)
              (.mov v1-25 vf1)
              (when (and (< v1-25 f0-4) (begin
                                          (.lvf vf1 (&-> (-> this rbody state lin-velocity) quad))
                                          (.add.w.vf vf2 vf0 vf0 :mask #b1)
                                          (.mul.vf vf1 vf1 vf1)
                                          (.mul.x.vf acc vf2 vf1 :mask #b1)
                                          (.add.mul.y.vf acc vf2 vf1 acc :mask #b1)
                                          (.add.mul.z.vf vf1 vf2 vf1 acc :mask #b1)
                                          (.mov v1-30 vf1)
                                          (let ((f1-7 v1-30)
                                                (f2-0 614.4)
                                                )
                                            (< f1-7 (* f0-4 (* f2-0 f2-0)))
                                            )
                                          )
                         )
                (logclear! (-> this flags) (rigid-body-object-flag disturbed))
                (clear-momentum! (-> this rbody state))
                )
              )
            )
          )
        )
      )
    0
    (none)
    )
  )

(defmethod update-joint-mods ((this vehicle))
  0
  (none)
  )

;; WARN: Found some very strange gotos. Check result carefully, this is not well tested.
(defmethod vehicle-method-107 ((this vehicle))
  (logclear! (-> this controller flags) (vehicle-controller-flag ignore-others direct-mode))
  (let ((s5-0 (new 'stack-no-clear 'vehicle-control-point)))
    (set! (-> s5-0 local-pos quad) (-> this root trans quad))
    (set! (-> s5-0 normal quad) (-> this root transv quad))
    (set! (-> s5-0 local-pos w) 40960.0)
    (let ((s4-0 0))
      (label cfg-1)
      (let ((v1-7 (find-best-segment (-> this controller traffic) (-> s5-0 local-pos) (-> s5-0 normal) 0)))
        (when (and (not v1-7) (< s4-0 3))
          (+! (-> s5-0 local-pos w) 40960.0)
          (+! s4-0 1)
          (goto cfg-1)
          )
        (if v1-7
            (vehicle-controller-method-13 (-> this controller) (-> v1-7 branch) (-> this root trans))
            (vehicle-method-113 this)
            )
        )
      )
    )
  0
  (none)
  )

(defmethod vehicle-method-119 ((this vehicle))
  (dotimes (s5-0 (-> this info seat-count))
    (let ((s4-0 (handle->process (-> this rider-array s5-0))))
      (when (and s4-0 (focus-test? (the-as vehicle-rider s4-0) pilot-riding))
        (compute-seat-position this (-> (the-as vehicle-rider s4-0) root trans) s5-0)
        (set! (-> (the-as vehicle-rider s4-0) root transv quad) (-> this root transv quad))
        (let ((f0-1 (the float (-> this info seat-array s5-0 angle))))
          (quaternion-rotate-local-y! (-> (the-as vehicle-rider s4-0) root quat) (-> this root quat) f0-1)
          )
        )
      )
    )
  0
  (none)
  )
