;;-*-Lisp-*-
(in-package goal)

;; name: castle-baron.gc
;; name in dgo: castle-baron
;; dgos: CAB

;; DECOMP BEGINS

(deftype cboss-tractor (process-drawable)
  ()
  :heap-base #x50
  :method-count-assert 21
  :size-assert         #xc8
  :flag-assert         #x15005000c8
  (:methods
    (idle () _type_ :state 20)
    )
  )


(defskelgroup skel-cboss-tractor cboss-tractor cboss-tractor-lod0-jg cboss-tractor-idle-ja
              ((cboss-tractor-lod0-mg (meters 999999)))
              :bounds (static-spherem 0 10 -15 40)
              )

(defstate idle (cboss-tractor)
  :virtual #t
  :code (behavior ()
    (until #f
      (ja-no-eval :group! (ja-group)
                  :num! (seek! (the float (+ (-> (ja-group) frames num-frames) -1)))
                  :frame-num 0.0
                  )
      (until (ja-done? 0)
        (suspend)
        (ja :num! (seek!))
        )
      )
    #f
    (none)
    )
  :post (the-as (function none :behavior cboss-tractor) ja-post)
  )

;; WARN: Return type mismatch object vs none.
(defmethod init-from-entity! cboss-tractor ((obj cboss-tractor) (arg0 entity-actor))
  "Typically the method that does the initial setup on the process, potentially using the [[entity-actor]] provided as part of that.
This commonly includes things such as:
- stack size
- collision information
- loading the skeleton group / bones
- sounds"
  (set! (-> obj root) (new 'process 'trsqv))
  (process-drawable-from-entity! obj arg0)
  (initialize-skeleton
    obj
    (the-as skeleton-group (art-group-get-by-name *level* "skel-cboss-tractor" (the-as (pointer uint32) #f)))
    (the-as pair 0)
    )
  (go (method-of-object obj idle))
  (none)
  )

(defskelgroup skel-cboss-elevator cboss-elevator cboss-elevator-lod0-jg cboss-elevator-idle-ja
              ((cboss-elevator-lod0-mg (meters 999999)))
              :bounds (static-spherem 0 0 0 20)
              )

(deftype cboss-elevator (elevator)
  ((sound-id sound-id  :offset-assert 368)
   )
  :heap-base #x100
  :method-count-assert 49
  :size-assert         #x174
  :flag-assert         #x3101000174
  )


(defstate running (cboss-elevator)
  :virtual #t
  :enter (behavior ()
    (let ((t9-0 (-> (method-of-type elevator running) enter)))
      (if t9-0
          (t9-0)
          )
      )
    (process-grab? *target* #f)
    (none)
    )
  :exit (behavior ()
    (let ((t9-0 (-> (method-of-type elevator running) exit)))
      (if t9-0
          (t9-0)
          )
      )
    (process-release? *target*)
    (sound-stop (-> self sound-id))
    (sound-play "cas-elevate-end")
    (none)
    )
  :post (behavior ()
    (let ((t9-0 (-> (method-of-type elevator running) post)))
      (if t9-0
          ((the-as (function none) t9-0))
          )
      )
    (sound-play "cas-elevate" :id (-> self sound-id) :position (-> self root trans))
    (none)
    )
  )

(defmethod get-art-group cboss-elevator ((obj cboss-elevator))
  "@returns The associated [[art-group]]"
  (art-group-get-by-name *level* "skel-cboss-elevator" (the-as (pointer uint32) #f))
  )

(defmethod deactivate cboss-elevator ((obj cboss-elevator))
  (sound-stop (-> obj sound-id))
  ((the-as (function process-drawable none) (find-parent-method cboss-elevator 10)) obj)
  (none)
  )

(defmethod init-plat! cboss-elevator ((obj cboss-elevator))
  "Does any necessary initial platform setup.
For example for an elevator pre-compute the distance between the first and last points (both ways) and clear the sound."
  (set! (-> obj sound-id) (new-sound-id))
  0
  (none)
  )

(defmethod move-between-points cboss-elevator ((obj cboss-elevator) (arg0 vector) (arg1 float) (arg2 float))
  "Move between two points on the elevator's path
@param vec TODO not sure
@param point-a The first point fetched from the elevator's path
@param point-b The second point fetched from the path
@see [[path-control]] and [[elevator]]"
  (let ((s4-0 (get-point-in-path! (-> obj path) (new 'stack-no-clear 'vector) arg1 'interp))
        (a0-3 (get-point-in-path! (-> obj path) (new 'stack-no-clear 'vector) arg2 'interp))
        (v1-3 (-> obj root trans))
        )
    (when (and (< (-> a0-3 y) (-> s4-0 y)) (< (-> arg0 y) (+ -8192.0 (-> v1-3 y))))
      (let ((s4-2 (vector-! (new 'stack-no-clear 'vector) arg0 v1-3)))
        (vector-inv-orient-by-quat! s4-2 s4-2 (-> obj root quat))
        (and (< (fabs (-> s4-2 x)) 24576.0) (< 0.0 (-> s4-2 z)) (< (-> s4-2 z) 49152.0))
        )
      )
    )
  )

(defmethod commited-to-ride? cboss-elevator ((obj cboss-elevator))
  "@returns if the target is considered within the elevator area enough to begin descending/ascending"
  (let* ((gp-0 *target*)
         (a0-2 (if (type? gp-0 process-focusable)
                   gp-0
                   )
               )
         )
    (when a0-2
      (let* ((v1-1 (get-trans a0-2 0))
             (gp-2 (vector-! (new 'stack-no-clear 'vector) v1-1 (-> obj root trans)))
             )
        (vector-inv-orient-by-quat! gp-2 gp-2 (-> obj root quat))
        (and (< (fabs (-> gp-2 x)) 40960.0) (< (fabs (-> gp-2 z)) 40960.0))
        )
      )
    )
  )

;; WARN: Return type mismatch collide-shape-moving vs none.
(defmethod init-plat-collision! cboss-elevator ((obj cboss-elevator))
  "TODO - collision stuff for setting up the platform"
  (let ((s5-0 (new 'process 'collide-shape-moving obj (collide-list-enum usually-hit-by-player))))
    (set! (-> s5-0 dynam) (copy *standard-dynamics* 'process))
    (set! (-> s5-0 reaction) cshape-reaction-default)
    (set! (-> s5-0 no-reaction)
          (the-as (function collide-shape-moving collide-query vector vector object) nothing)
          )
    (let ((s4-0 (new 'process 'collide-shape-prim-group s5-0 (the-as uint 1) 0)))
      (set! (-> s5-0 total-prims) (the-as uint 2))
      (set! (-> s4-0 prim-core collide-as) (collide-spec obstacle camera-blocker pusher))
      (set! (-> s4-0 prim-core collide-with) (collide-spec jak bot player-list))
      (set! (-> s4-0 prim-core action) (collide-action solid rideable))
      (set! (-> s4-0 transform-index) 0)
      (set-vector! (-> s4-0 local-sphere) 0.0 0.0 0.0 81920.0)
      (set! (-> s5-0 root-prim) s4-0)
      )
    (pusher-init s5-0)
    (let ((v1-14 (new 'process 'collide-shape-prim-mesh s5-0 (the-as uint 0) (the-as uint 0))))
      (set! (-> v1-14 prim-core collide-as) (collide-spec obstacle camera-blocker pusher))
      (set! (-> v1-14 prim-core collide-with) (collide-spec jak bot player-list))
      (set! (-> v1-14 prim-core action) (collide-action solid rideable))
      (set! (-> v1-14 transform-index) 0)
      (set-vector! (-> v1-14 local-sphere) 0.0 0.0 0.0 81920.0)
      )
    (set! (-> s5-0 nav-radius) (* 0.75 (-> s5-0 root-prim local-sphere w)))
    (let ((v1-17 (-> s5-0 root-prim)))
      (set! (-> s5-0 backup-collide-as) (-> v1-17 prim-core collide-as))
      (set! (-> s5-0 backup-collide-with) (-> v1-17 prim-core collide-with))
      )
    (set! (-> obj root) s5-0)
    )
  (none)
  )

(deftype krew-boss-clone (nav-enemy)
  ((old-y-deg          float               :offset-assert 604)
   (diff-angle         degrees             :offset-assert 608)
   (hit-target         symbol              :offset-assert 612)
   (lightning          lightning-control 4 :offset-assert 616)
   (wiggle-time        time-frame          :offset-assert 632)
   (wiggle-angle       degrees             :offset-assert 640)
   (delta-wiggle-angle degrees             :offset-assert 644)
   (wiggle-factor      float               :offset-assert 648)
   (id                 sound-id            :offset-assert 652)
   )
  :heap-base #x210
  :method-count-assert 181
  :size-assert         #x290
  :flag-assert         #xb502100290
  (:methods
    (spawning () _type_ :state 178)
    (krew-boss-clone-method-179 (_type_ vector) none 179)
    (krew-boss-clone-method-180 (_type_) none 180)
    )
  )


(deftype krew-boss (nav-enemy)
  ((task-timeout           time-frame   :offset-assert 608)
   (movie-handle           handle       :offset-assert 616)
   (clones                 handle     8 :offset-assert 624)
   (last-closest-spawn     int32        :offset-assert 688)
   (next-clone-side        int32        :offset-assert 692)
   (next-shooting-frame    int32        :offset-assert 696)
   (old-y-deg              float        :offset-assert 700)
   (diff-angle             degrees      :offset-assert 704)
   (hit-target             symbol       :offset-assert 708)
   (floating               symbol       :offset-assert 712)
   (next-path-point        int32        :offset-assert 716)
   (num-clones-to-spawn    int32        :offset-assert 720)
   (gameplay-pass          int32        :offset-assert 724)
   (hud-handle             handle       :offset-assert 728)
   (channel                uint8        :offset-assert 736)
   (id                     sound-id     :offset-assert 740)
   (play-clone-wave-speech symbol       :offset-assert 744)
   (last-damage-time       time-frame   :offset-assert 752)
   (spawn-charge           symbol       :offset-assert 760)
   )
  :heap-base #x280
  :method-count-assert 180
  :size-assert         #x2fc
  :flag-assert         #xb4028002fc
  (:methods
    (hidden () _type_ :state 178)
    (play-intro () _type_ :state 179)
    )
  )


(defun clones-wave-speech ((arg0 krew-boss))
  (when (= (get-status *gui-control* (-> arg0 id)) (gui-status unknown))
    (let ((v1-3 (rand-vu-int-count 17)))
      (cond
        ((zero? v1-3)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf003" -99.0 0)
               )
         )
        ((= v1-3 1)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf004" -99.0 0)
               )
         )
        ((= v1-3 2)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf005" -99.0 0)
               )
         )
        ((= v1-3 3)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf006" -99.0 0)
               )
         )
        ((= v1-3 4)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf007" -99.0 0)
               )
         )
        ((= v1-3 5)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf008" -99.0 0)
               )
         )
        ((= v1-3 6)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf009" -99.0 0)
               )
         )
        ((= v1-3 7)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf010" -99.0 0)
               )
         )
        ((= v1-3 8)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf035" -99.0 0)
               )
         )
        ((= v1-3 9)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf037" -99.0 0)
               )
         )
        ((= v1-3 10)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf040" -99.0 0)
               )
         )
        ((= v1-3 11)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf012" -99.0 0)
               )
         )
        ((= v1-3 12)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf039" -99.0 0)
               )
         )
        ((= v1-3 13)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "ds261" -99.0 0)
               )
         )
        ((= v1-3 14)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "ds262" -99.0 0)
               )
         )
        ((= v1-3 15)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "ds265" -99.0 0)
               )
         )
        ((= v1-3 16)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "ds266" -99.0 0)
               )
         )
        )
      )
    )
  0
  (none)
  )

(defun krew-hit-speech ((arg0 krew-boss))
  (when (= (get-status *gui-control* (-> arg0 id)) (gui-status unknown))
    (let ((v1-3 (rand-vu-int-count 14)))
      (cond
        ((zero? v1-3)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf016" -99.0 0)
               )
         )
        ((= v1-3 1)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf017" -99.0 0)
               )
         )
        ((= v1-3 2)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf018" -99.0 0)
               )
         )
        ((= v1-3 3)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf019" -99.0 0)
               )
         )
        ((= v1-3 4)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf020" -99.0 0)
               )
         )
        ((= v1-3 5)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf025" -99.0 0)
               )
         )
        ((= v1-3 6)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf042" -99.0 0)
               )
         )
        ((= v1-3 7)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "ds264" -99.0 0)
               )
         )
        ((= v1-3 8)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "ds267" -99.0 0)
               )
         )
        ((= v1-3 9)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "ds268" -99.0 0)
               )
         )
        )
      )
    )
  0
  (none)
  )

(defun krew-hits-jak-speech ((arg0 krew-boss))
  (when (= (get-status *gui-control* (-> arg0 id)) (gui-status unknown))
    (let ((v1-3 (rand-vu-int-count 12)))
      (cond
        ((zero? v1-3)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf028" -99.0 0)
               )
         )
        ((= v1-3 1)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf030" -99.0 0)
               )
         )
        ((= v1-3 2)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf031" -99.0 0)
               )
         )
        ((= v1-3 3)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf032" -99.0 0)
               )
         )
        ((= v1-3 4)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf033" -99.0 0)
               )
         )
        ((= v1-3 5)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf034" -99.0 0)
               )
         )
        ((= v1-3 6)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf036" -99.0 0)
               )
         )
        ((= v1-3 7)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf038" -99.0 0)
               )
         )
        )
      )
    )
  0
  (none)
  )

(defun krew-comes-in-speech ((arg0 krew-boss))
  (when (= (get-status *gui-control* (-> arg0 id)) (gui-status unknown))
    (let ((v1-3 (rand-vu-int-count 11)))
      (cond
        ((zero? v1-3)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf014" -99.0 0)
               )
         )
        ((= v1-3 1)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf015" -99.0 0)
               )
         )
        ((= v1-3 2)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf022" -99.0 0)
               )
         )
        ((= v1-3 3)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf023" -99.0 0)
               )
         )
        ((= v1-3 4)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf024" -99.0 0)
               )
         )
        ((= v1-3 5)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf026" -99.0 0)
               )
         )
        ((= v1-3 6)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf027" -99.0 0)
               )
         )
        ((= v1-3 7)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf029" -99.0 0)
               )
         )
        ((= v1-3 8)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf011" -99.0 0)
               )
         )
        ((= v1-3 9)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "kwbf013" -99.0 0)
               )
         )
        ((= v1-3 10)
         (set! (-> arg0 id)
               (add-process *gui-control* arg0 (the-as gui-channel (-> arg0 channel)) (gui-action play) "ds263" -99.0 0)
               )
         )
        )
      )
    )
  0
  (none)
  )

(defskelgroup skel-krew-boss krew-lowres krew-lowres-lod0-jg krew-lowres-idle-ja
              ((krew-lowres-lod0-mg (meters 20)) (krew-lowres-lod1-mg (meters 999999)))
              :bounds (static-spherem 0 0 0 3)
              :shadow krew-lowres-shadow-mg
              )

(defskelgroup skel-krew-boss-clone krew-clone krew-clone-lod0-jg krew-clone-idle-ja
              ((krew-clone-lod0-mg (meters 999999)))
              :bounds (static-spherem 0 0 0 3)
              :shadow krew-clone-shadow-mg
              :origin-joint-index 3
              )

(define *krew-boss-clone-nav-enemy-info*
  (new 'static 'nav-enemy-info
    :use-die-falling #f
    :use-victory #f
    :use-jump-blocked #f
    :debug-draw-neck #f
    :jump-debug-draw #f
    :move-to-ground #t
    :hover-if-no-ground #f
    :idle-anim-script (new 'static 'array idle-control-frame 4
      (new 'static 'idle-control-frame :command (ic-cmd push) :param0 #x1e)
      (new 'static 'idle-control-frame :command (ic-cmd play) :anim #x3 :param0 #x64 :param1 #x64)
      (new 'static 'idle-control-frame)
      (new 'static 'idle-control-frame)
      )
    :idle-anim 3
    :notice-anim 3
    :hostile-anim 6
    :hit-anim 3
    :knocked-anim 10
    :knocked-land-anim 11
    :die-anim 12
    :die-falling-anim 3
    :victory-anim -1
    :jump-wind-up-anim 3
    :jump-in-air-anim 3
    :jump-land-anim 3
    :neck-joint 5
    :look-at-joint 5
    :bullseye-joint 4
    :sound-hit (static-sound-name "krew-boss-hit")
    :sound-die (static-sound-name "krew-boss-die")
    :notice-distance (meters 50)
    :notice-distance-delta (meters 10)
    :proximity-notice-distance (meters 200)
    :default-hit-points 8
    :gnd-collide-with (collide-spec backgnd)
    :overlaps-others-collide-with-filter (collide-spec jak bot player-list)
    :penetrate-knocked (penetrate
      touch
      generic-attack
      lunge
      flop
      punch
      spin
      roll
      uppercut
      bonk
      tube
      vehicle
      flut-attack
      board
      mech
      mech-punch
      mech-bonk
      dark-skin
      dark-punch
      dark-bomb
      dark-giant
      shield
      explode
      jak-yellow-shot
      jak-red-shot
      jak-blue-shot
      jak-dark-shot
      enemy-yellow-shot
      enemy-dark-shot
      eco-yellow
      eco-red
      eco-blue
      eco-green
      knocked
      penetrate-33
      penetrate-34
      penetrate-35
      penetrate-36
      penetrate-37
      penetrate-38
      penetrate-39
      penetrate-40
      penetrate-41
      penetrate-42
      penetrate-43
      penetrate-44
      penetrate-45
      penetrate-46
      penetrate-47
      penetrate-48
      penetrate-49
      penetrate-50
      penetrate-51
      penetrate-52
      penetrate-53
      penetrate-54
      penetrate-55
      penetrate-56
      penetrate-57
      penetrate-58
      penetrate-59
      penetrate-60
      penetrate-61
      penetrate-62
      penetrate-63
      )
    :movement-gravity (meters -100)
    :friction 0.9
    :attack-shove-back (meters 3.5)
    :attack-shove-up (meters 2)
    :attack-mode 'shock-green
    :attack-damage 2
    :recover-gnd-collide-with (collide-spec backgnd crate obstacle hit-by-others-list pusher)
    :jump-height-min (meters 3)
    :jump-height-factor 0.5
    :knocked-seek-ry-clamp 6371.5557
    :knocked-soft-vxz-lo 72089.6
    :knocked-soft-vxz-hi 108134.4
    :knocked-soft-vy-lo 81920.0
    :knocked-soft-vy-hi 122880.0
    :knocked-medium-vxz-lo 147456.0
    :knocked-medium-vxz-hi 196608.0
    :knocked-medium-vy-lo 135168.0
    :knocked-medium-vy-hi 151552.0
    :knocked-hard-vxz-lo 78643.2
    :knocked-hard-vxz-hi 117964.8
    :knocked-hard-vy-lo 183500.8
    :knocked-hard-vy-hi 209715.2
    :knocked-huge-vxz-lo 164659.2
    :knocked-huge-vxz-hi 249036.8
    :knocked-huge-vy-lo 183500.8
    :knocked-huge-vy-hi 217907.2
    :knocked-yellow-vxz-lo 40960.0
    :knocked-yellow-vxz-hi 65536.0
    :knocked-yellow-vy-lo 57344.0
    :knocked-yellow-vy-hi 81920.0
    :knocked-red-vxz-lo 24576.0
    :knocked-red-vxz-hi 196608.0
    :knocked-red-vy-lo 94208.0
    :knocked-red-vy-hi 151552.0
    :knocked-blue-vxz-lo 40960.0
    :knocked-blue-vxz-hi 65536.0
    :knocked-blue-vy-lo 24576.0
    :knocked-blue-vy-hi 81920.0
    :shadow-size (meters 1)
    :shadow-max-y (meters 1)
    :shadow-min-y (meters -1)
    :shadow-locus-dist (meters 150)
    :gem-joint -1
    :gem-offset (new 'static 'sphere :r 163840.0)
    :callback-info #f
    :use-momentum #t
    :use-frustration #t
    :use-stop-chase #f
    :use-circling #f
    :use-pacing #f
    :walk-anim 3
    :turn-anim -1
    :run-anim 6
    :taunt-anim -1
    :run-travel-speed (meters 5)
    :run-acceleration (meters 32)
    :run-turning-acceleration (meters 20)
    :walk-travel-speed (meters 4)
    :walk-acceleration (meters 16)
    :walk-turning-acceleration (meters 20)
    :maximum-rotation-rate (degrees 360)
    :notice-nav-radius (meters 2)
    :frustration-distance (meters 8)
    :frustration-time (seconds 4)
    :blocked-time (seconds 0.3)
    :circle-dist-lo 20480.0
    :circle-dist-hi 61440.0
    :nav-mesh #f
    )
  )

(set! (-> *krew-boss-clone-nav-enemy-info* fact-defaults) *fact-info-enemy-defaults*)

(defmethod track-target! krew-boss-clone ((obj krew-boss-clone))
  "Does a lot of various things relating to interacting with the target
- tracks when the enemy was last drawn
- looks at the target and handles attacking
@TODO Not extremely well understood yet"
  (let ((t9-0 (method-of-type nav-enemy track-target!)))
    (t9-0 obj)
    )
  (let ((s5-0 (new 'stack-no-clear 'vector))
        (s4-0 (new 'stack-no-clear 'vector))
        )
    (vector<-cspace! s5-0 (-> obj node-list data 36))
    (dotimes (s3-0 4)
      (let ((v1-2 s3-0))
        (cond
          ((zero? v1-2)
           (vector<-cspace! s5-0 (-> obj node-list data 7))
           (vector<-cspace! s4-0 (-> obj node-list data 15))
           )
          ((= v1-2 1)
           (vector<-cspace! s5-0 (-> obj node-list data 6))
           (vector<-cspace! s4-0 (-> obj node-list data 7))
           )
          ((= v1-2 2)
           (vector<-cspace! s5-0 (-> obj node-list data 19))
           (vector<-cspace! s4-0 (-> obj node-list data 27))
           )
          (else
            (vector<-cspace! s5-0 (-> obj node-list data 18))
            (vector<-cspace! s4-0 (-> obj node-list data 19))
            )
          )
        )
      (let ((a0-13 (-> obj lightning s3-0))
            (v1-17 s5-0)
            )
        (set! (-> a0-13 state meet data 0 quad) (-> v1-17 quad))
        )
      (let ((a0-16 (-> obj lightning s3-0))
            (v1-21 s4-0)
            )
        (set! (-> a0-16 state meet data (+ (-> a0-16 state points-to-draw) -1) quad) (-> v1-21 quad))
        )
      (when (not (and (-> obj next-state) (= (-> obj next-state name) 'die-falling)))
        (case (-> obj lightning s3-0 state mode)
          (((lightning-mode lm0) (lightning-mode lm3))
           (let ((v1-35 (-> obj lightning s3-0))
                 (a0-22 1)
                 )
             (let ((a1-14 (!= a0-22 (-> v1-35 state mode))))
               (case a0-22
                 ((3)
                  (if a1-14
                      (set! (-> v1-35 state counter) 0.0)
                      )
                  )
                 ((1)
                  (set! (-> v1-35 state start-color) (-> v1-35 spec start-color))
                  (set! (-> v1-35 state end-color) (-> v1-35 spec end-color))
                  )
                 )
               )
             (set! (-> v1-35 state mode) (the-as lightning-mode a0-22))
             )
           )
          )
        )
      )
    )
  (if (< (-> obj root trans y) 1228800.0)
      (deactivate obj)
      )
  0
  (none)
  )

(defmethod general-event-handler krew-boss-clone ((obj krew-boss-clone) (arg0 process) (arg1 int) (arg2 symbol) (arg3 event-message-block))
  "Handles various events for the enemy
@TODO - unsure if there is a pattern for the events and this should have a more specific name"
  (with-pp
    (case arg2
      (('touch 'bonk 'attack)
       (when (and (-> obj next-state) (= (-> obj next-state name) 'hostile))
         (let ((a1-3 (new 'stack-no-clear 'event-message-block)))
           (set! (-> a1-3 from) (process->ppointer pp))
           (set! (-> a1-3 num-params) 2)
           (set! (-> a1-3 message) 'attack)
           (set! (-> a1-3 param 0) (the-as uint #f))
           (let ((v1-8 (new 'static 'attack-info :mask (attack-info-mask mode shove-back shove-up id damage))))
             (let* ((a0-7 *game-info*)
                    (a2-2 (+ (-> a0-7 attack-id) 1))
                    )
               (set! (-> a0-7 attack-id) a2-2)
               (set! (-> v1-8 id) a2-2)
               )
             (set! (-> v1-8 mode) 'shock-green)
             (set! (-> v1-8 shove-up) 8192.0)
             (set! (-> v1-8 shove-back) 16384.0)
             (set! (-> v1-8 damage) 1.0)
             (set! (-> a1-3 param 1) (the-as uint v1-8))
             )
           (send-event-function arg0 a1-3)
           )
         (cond
           ((!= arg0 *target*)
            ((method-of-type nav-enemy general-event-handler) obj arg0 arg1 arg2 arg3)
            )
           (else
             (ja-channel-push! 1 (seconds 0.1))
             (let ((a0-15 (-> obj skel root-channel 0)))
               (set! (-> a0-15 frame-group)
                     (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info die-anim)))
                     )
               (set! (-> a0-15 param 0) 0.0)
               (set! (-> a0-15 param 1) (* 2.0 (-> pp clock time-adjust-ratio)))
               (set! (-> a0-15 frame-num)
                     (the float
                          (+ (-> (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info die-anim))) frames num-frames)
                             -1
                             )
                          )
                     )
               (joint-control-channel-group!
                 a0-15
                 (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info die-anim)))
                 num-func-seek!
                 )
               )
             (kill-prefer-falling obj)
             )
           )
         )
       )
      (('track)
       (cond
         ((-> arg3 param 0)
          (if (logtest? (-> obj enemy-flags) (enemy-flag enable-on-active))
              #t
              'abort
              )
          )
         (else
           (logtest? (-> obj enemy-flags) (enemy-flag enable-on-active))
           )
         )
       )
      (else
        ((method-of-type nav-enemy general-event-handler) obj arg0 arg1 arg2 arg3)
        )
      )
    )
  )

(defstate spawning (krew-boss-clone)
  :virtual #t
  :event (the-as
    (function process int symbol event-message-block object :behavior krew-boss-clone)
    enemy-event-handler
    )
  :enter (behavior ()
    (sound-play "krew-spawn")
    (none)
    )
  :exit (behavior ()
    (set! (-> self id) (sound-play "krew-travel"))
    (none)
    )
  :trans (behavior ()
    (let ((gp-1 (vector-! (new 'stack-no-clear 'vector) (target-pos 0) (-> self root trans)))
          (s5-0 (quaternion->matrix (new-stack-matrix0) (-> self root quat)))
          )
      (vector-normalize! gp-1 1.0)
      (let* ((a2-1 (vector-normalize-copy! (new 'stack-no-clear 'vector) (-> s5-0 vector 1) 1.0))
             (a0-8 (vector-normalize! (vector-flatten! (new 'stack-no-clear 'vector) gp-1 a2-1) 1.0))
             )
        (quaternion-axis-angle! (-> self root quat) 0.0 1.0 0.0 (vector-y-angle a0-8))
        )
      )
    (none)
    )
  :code (behavior ()
    (ja-no-eval :group! (-> self draw art-group data 12)
                :num! (seek! (the float (+ (-> (the-as art-joint-anim (-> self draw art-group data 12)) frames num-frames) -1)))
                :frame-num 0.0
                )
    (until (ja-done? 0)
      (suspend)
      (ja :num! (seek!))
      )
    (go-virtual hostile)
    (none)
    )
  :post (behavior ()
    (logior! (-> self enemy-flags) (enemy-flag directed))
    (let ((gp-0 (-> self root)))
      (let ((a1-0 (new-stack-vector0)))
        (vector-v++! (-> gp-0 transv) (compute-acc-due-to-gravity gp-0 a1-0 (-> self enemy-info slip-factor)))
        )
      (let ((a2-1 (new 'stack-no-clear 'collide-query)))
        (set! (-> a2-1 collide-with) (-> gp-0 root-prim prim-core collide-with))
        (set! (-> a2-1 ignore-process0) self)
        (set! (-> a2-1 ignore-process1) #f)
        (set! (-> a2-1 ignore-pat) (-> gp-0 pat-ignore-mask))
        (set! (-> a2-1 action-mask) (collide-action solid))
        (fill-cache-integrate-and-collide gp-0 (-> gp-0 transv) a2-1 (meters 0))
        )
      )
    (enemy-method-111 self)
    (track-target! self)
    (none)
    )
  )

(defstate knocked (krew-boss-clone)
  :virtual #t
  :enter (behavior ()
    (sound-play "krew-gets-hit")
    (let ((t9-2 (-> (method-of-type nav-enemy knocked) enter)))
      (if t9-2
          (t9-2)
          )
      )
    (none)
    )
  )

(defmethod enemy-method-77 krew-boss-clone ((obj krew-boss-clone) (arg0 (pointer float)))
  (with-pp
    (ja-channel-push! 1 0)
    (cond
      ((<= (-> obj hit-points) 0)
       (let ((a0-2 (-> obj skel root-channel 0)))
         (set! (-> a0-2 frame-group) (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info die-anim))))
         (set! (-> a0-2 param 0) 0.0)
         (set! (-> a0-2 param 1) (* 2.0 (-> pp clock time-adjust-ratio)))
         (set! (-> a0-2 frame-num)
               (the float
                    (+ (-> (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info die-anim))) frames num-frames)
                       -1
                       )
                    )
               )
         (joint-control-channel-group!
           a0-2
           (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info die-anim)))
           num-func-seek!
           )
         )
       )
      (else
        (let ((a0-3 (-> obj skel root-channel 0)))
          (set! (-> a0-3 frame-group)
                (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-anim)))
                )
          (set! (-> a0-3 param 0)
                (the float
                     (+ (-> (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-anim))) frames num-frames)
                        -1
                        )
                     )
                )
          (set! (-> a0-3 param 1) (* 2.0 (-> pp clock time-adjust-ratio)))
          (set! (-> a0-3 frame-num) 0.0)
          (joint-control-channel-group!
            a0-3
            (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-anim)))
            num-func-seek!
            )
          )
        )
      )
    #t
    )
  )

(defmethod enemy-method-78 krew-boss-clone ((obj krew-boss-clone) (arg0 (pointer float)))
  (when (> (-> obj hit-points) 0)
    (ja-channel-push! 1 (seconds 0.1))
    (let ((a0-2 (-> obj skel root-channel 0)))
      (set! (-> a0-2 frame-group)
            (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-land-anim)))
            )
      (set! (-> a0-2 param 0)
            (the float
                 (+ (-> (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-land-anim)))
                        frames
                        num-frames
                        )
                    -1
                    )
                 )
            )
      (set! (-> a0-2 param 1) (* 5.0 (-> arg0 0)))
      (set! (-> a0-2 frame-num) 0.0)
      (joint-control-channel-group!
        a0-2
        (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-land-anim)))
        num-func-seek!
        )
      )
    )
  #t
  )

(defmethod enemy-method-79 krew-boss-clone ((obj krew-boss-clone) (arg0 int) (arg1 enemy-knocked-info))
  (local-vars (s5-0 symbol))
  (let ((v1-0 arg0))
    (cond
      ((zero? v1-0)
       (enemy-method-77 obj (the-as (pointer float) arg1))
       #f
       )
      ((= v1-0 1)
       (set! s5-0 (ja-done? 0))
       (ja-eval)
       s5-0
       )
      ((= v1-0 2)
       (set! s5-0 (not (enemy-method-78 obj (the-as (pointer float) arg1))))
       (set! (-> obj incoming blue-juggle-count) (the-as uint 0))
       s5-0
       )
      ((= v1-0 3)
       (set! s5-0 (ja-done? 0))
       (ja-eval)
       s5-0
       )
      ((= v1-0 4)
       (vector-reset! (-> obj root transv))
       #t
       )
      (else
        #t
        )
      )
    )
  )

(defmethod krew-boss-clone-method-180 krew-boss-clone ((obj krew-boss-clone))
  (let* ((f0-0 (rand-vu-float-range 0.0 1.0))
         (f1-1 (+ 1.0 (* 2.0 f0-0)))
         (f2-2 f1-1)
         (f2-4 (/ 1.0 f2-2))
         )
    (+ 1.0 (* 0.2 f0-0))
    (set! (-> obj delta-wiggle-angle) (* 182.04445 f1-1))
    (set! (-> obj wiggle-factor) (* 2.0 f2-4))
    )
  0
  (none)
  )

(defmethod krew-boss-clone-method-179 krew-boss-clone ((obj krew-boss-clone) (arg0 vector))
  (rlet ((acc :class vf)
         (vf0 :class vf)
         (vf4 :class vf)
         (vf5 :class vf)
         (vf6 :class vf)
         (vf7 :class vf)
         )
    (init-vf0-vector)
    (+! (-> obj wiggle-angle) (-> obj delta-wiggle-angle))
    (if (< 65536.0 (-> obj wiggle-angle))
        (+! (-> obj wiggle-angle) -65536.0)
        )
    (let* ((v1-5 (-> obj root trans))
           (a1-2 (vector-! (new 'stack-no-clear 'vector) v1-5 arg0))
           (s3-0 (vector-rotate-around-y! (new 'stack-no-clear 'vector) a1-2 16384.0))
           (s4-0 (new 'stack-no-clear 'vector))
           )
      (let ((v1-6 (* (-> obj wiggle-factor) (sin (-> obj wiggle-angle)))))
        (.mov vf7 v1-6)
        )
      (.lvf vf5 (&-> s3-0 quad))
      (.lvf vf4 (&-> arg0 quad))
      (.add.x.vf vf6 vf0 vf0 :mask #b1000)
      (.mul.x.vf acc vf5 vf7 :mask #b111)
      (.add.mul.w.vf vf6 vf4 vf0 acc :mask #b111)
      (.svf (&-> s4-0 quad) vf6)
      (let ((v1-8 (-> obj nav state)))
        (logclear! (-> v1-8 flags) (nav-state-flag directional-mode))
        (logior! (-> v1-8 flags) (nav-state-flag target-poly-dirty))
        (set! (-> v1-8 target-post quad) (-> s4-0 quad))
        )
      )
    0
    0
    (none)
    )
  )

;; WARN: Return type mismatch object vs none.
(defmethod go-stare2 krew-boss-clone ((obj krew-boss-clone))
  (go (method-of-object obj hostile))
  (none)
  )

(defstate hostile (krew-boss-clone)
  :virtual #t
  :enter (behavior ()
    (let ((t9-0 (-> (method-of-type nav-enemy hostile) enter)))
      (if t9-0
          (t9-0)
          )
      )
    (let ((v1-6 (ja-group)))
      (when (not (and v1-6 (= v1-6 (-> self draw art-group data (-> self enemy-info hostile-anim)))))
        (ja-channel-push! 1 (seconds 0.1))
        (ja :group! (-> self draw art-group data (-> self enemy-info hostile-anim)) :num! min)
        )
      )
    (none)
    )
  :code (behavior ()
    (set! (-> self wiggle-time) (+ (current-time) (seconds -10)))
    (set! (-> self wiggle-angle) 0.0)
    (let ((f30-0 (get-rand-float-range self 0.9 1.1)))
      (until #f
        (ja :num! (loop! f30-0))
        (when (>= (- (current-time) (-> self wiggle-time)) (seconds 1))
          (set! (-> self wiggle-time) (current-time))
          (krew-boss-clone-method-180 self)
          )
        (suspend)
        )
      )
    #f
    (none)
    )
  :post (behavior ()
    (krew-boss-clone-method-179 self (target-pos 0))
    (nav-enemy-method-176 self)
    (none)
    )
  )

(defstate die (krew-boss-clone)
  :virtual #t
  :event (the-as
    (function process int symbol event-message-block object :behavior krew-boss-clone)
    enemy-event-handler
    )
  :enter (behavior ()
    (if (nonzero? (-> self id))
        (sound-stop (-> self id))
        )
    (when (< 25 (rand-vu-int-range 0 50))
      (let ((gp-1 (-> self root))
            (a1-1 (new 'stack-no-clear 'collide-query))
            )
        (when (find-ground gp-1 a1-1 (-> self enemy-info recover-gnd-collide-with) 8192.0 81920.0 1024.0)
          (let ((f0-1 (- (-> self root trans y) (-> gp-1 gspot-pos y))))
            (when (and (>= f0-1 -1228.8) (>= 26624.0 f0-1))
              (cond
                ((>= (rand-vu-int-range 0 100) (/ (* 40 (you-suck-stage *game-info* #f)) 4))
                 (set! (-> self fact pickup-type) (pickup-type ammo-random))
                 (set! (-> self fact pickup-amount) 1.0)
                 )
                (else
                  (set! (-> self fact pickup-type) (pickup-type health))
                  (set! (-> self fact pickup-amount) 2.0)
                  )
                )
              (set! (-> self fact fade-time) (seconds 10))
              (let ((v1-25 (drop-pickup (-> self fact) #t *entity-pool* (-> self fact) 0)))
                (when v1-25
                  (set! (-> (the-as collectable (-> v1-25 0)) draw light-index) (the-as uint 0))
                  0
                  )
                )
              )
            )
          )
        )
      )
    (none)
    )
  :code (behavior ()
    (while (not (ja-done? 0))
      (ja-eval)
      (suspend)
      )
    (send-event self 'death-end)
    (while (-> self child)
      (suspend)
      )
    (cleanup-for-death self)
    (none)
    )
  :post (the-as (function none :behavior krew-boss-clone) enemy-simple-post)
  )

(defmethod init-enemy-collision! krew-boss-clone ((obj krew-boss-clone))
  "Initializes the [[collide-shape-moving]] and any ancillary tasks to make the enemy collide properly"
  (let ((s5-0 (new 'process 'collide-shape-moving obj (collide-list-enum usually-hit-by-player))))
    (set! (-> s5-0 dynam) (copy *standard-dynamics* 'process))
    (set! (-> s5-0 reaction) cshape-reaction-default)
    (set! (-> s5-0 no-reaction)
          (the-as (function collide-shape-moving collide-query vector vector object) nothing)
          )
    (set! (-> s5-0 penetrated-by) (penetrate
                                    generic-attack
                                    lunge
                                    flop
                                    punch
                                    spin
                                    roll
                                    uppercut
                                    bonk
                                    tube
                                    vehicle
                                    flut-attack
                                    board
                                    mech-punch
                                    dark-punch
                                    dark-giant
                                    )
          )
    (let ((s4-0 (new 'process 'collide-shape-prim-group s5-0 (the-as uint 2) 0)))
      (set! (-> s5-0 total-prims) (the-as uint 3))
      (set! (-> s4-0 prim-core collide-as) (collide-spec enemy))
      (set! (-> s4-0 prim-core collide-with)
            (collide-spec backgnd jak bot crate enemy hit-by-others-list player-list collectable)
            )
      (set! (-> s4-0 prim-core action) (collide-action solid deadly))
      (set-vector! (-> s4-0 local-sphere) 0.0 8192.0 0.0 8192.0)
      (set! (-> s5-0 root-prim) s4-0)
      )
    (let ((v1-13 (new 'process 'collide-shape-prim-sphere s5-0 (the-as uint 0))))
      (set! (-> v1-13 prim-core collide-as) (collide-spec enemy))
      (set! (-> v1-13 prim-core collide-with)
            (collide-spec backgnd jak bot crate enemy hit-by-others-list player-list collectable)
            )
      (set! (-> v1-13 prim-core action) (collide-action solid deadly no-standon))
      (set-vector! (-> v1-13 local-sphere) 0.0 8192.0 0.0 5324.8)
      )
    (let ((v1-15 (new 'process 'collide-shape-prim-sphere s5-0 (the-as uint 0))))
      (set! (-> v1-15 prim-core collide-as) (collide-spec enemy))
      (set! (-> v1-15 prim-core collide-with)
            (collide-spec backgnd jak bot crate enemy hit-by-others-list player-list collectable)
            )
      (set! (-> v1-15 prim-core action) (collide-action solid deadly))
      (set-vector! (-> v1-15 local-sphere) 0.0 5324.8 0.0 5324.8)
      )
    (set! (-> s5-0 nav-radius) 4096.0)
    (let ((v1-17 (-> s5-0 root-prim)))
      (set! (-> s5-0 backup-collide-as) (-> v1-17 prim-core collide-as))
      (set! (-> s5-0 backup-collide-with) (-> v1-17 prim-core collide-with))
      )
    (set! (-> s5-0 max-iteration-count) (the-as uint 3))
    (set! (-> s5-0 pat-ignore-mask) (new 'static 'pat-surface :noentity #x1 :probe #x1 :noendlessfall #x1))
    (set! (-> obj root) s5-0)
    )
  0
  (none)
  )

(defmethod coin-flip? krew-boss-clone ((obj krew-boss-clone))
  "@returns The result of a 50/50 RNG roll"
  #f
  )

;; WARN: Return type mismatch nav-enemy vs krew-boss-clone.
(defmethod relocate krew-boss-clone ((obj krew-boss-clone) (arg0 int))
  (dotimes (v1-0 4)
    (if (nonzero? (-> obj lightning v1-0))
        (&+! (-> obj lightning v1-0) arg0)
        )
    )
  (the-as krew-boss-clone ((method-of-type nav-enemy relocate) obj arg0))
  )

;; WARN: Return type mismatch object vs none.
(defmethod init-enemy! krew-boss-clone ((obj krew-boss-clone))
  "Common method called to initialize the enemy, typically sets up default field values and calls ancillary helper methods"
  (initialize-skeleton
    obj
    (the-as skeleton-group (art-group-get-by-name *level* "skel-krew-boss-clone" (the-as (pointer uint32) #f)))
    (the-as pair 0)
    )
  (logior! (-> obj draw global-effect) (draw-control-global-effect disable-envmap))
  (set! (-> obj enemy-flags) (the-as enemy-flag (logior (enemy-flag vulnerable-backup) (-> obj enemy-flags))))
  (set! (-> *krew-boss-clone-nav-enemy-info* nav-mesh)
        (nav-mesh-from-res-tag (-> obj entity) 'nav-mesh-actor 1)
        )
  (init-enemy-behaviour-and-stats! obj *krew-boss-clone-nav-enemy-info*)
  (dotimes (s5-1 4)
    (set! (-> obj lightning s5-1) (new
                                    'process
                                    'lightning-control
                                    (new 'static 'lightning-spec
                                      :name #f
                                      :flags (lightning-spec-flags lsf0)
                                      :start-color (new 'static 'rgba :r #xff :g #xff :b #xff :a #x80)
                                      :end-color (new 'static 'rgba :r #xff :g #xff :b #xff :a #x80)
                                      :fade-to-color (new 'static 'rgba :r #xbf :b #x8f :a #x5)
                                      :fade-start-factor 0.2
                                      :texture (new 'static 'texture-id :page #xd82)
                                      :reduction 0.42
                                      :num-points 16
                                      :box-size 8192.0
                                      :merge-factor 0.5
                                      :merge-count 2
                                      :radius 512.0
                                      :duration 30.0
                                      :sound #f
                                      )
                                    obj
                                    0.0
                                    )
          )
    (let ((v1-17 (-> obj lightning s5-1))
          (a0-8 0)
          )
      (let ((a1-6 (!= a0-8 (-> v1-17 state mode))))
        (case a0-8
          ((3)
           (if a1-6
               (set! (-> v1-17 state counter) 0.0)
               )
           )
          ((1)
           (set! (-> v1-17 state start-color) (-> v1-17 spec start-color))
           (set! (-> v1-17 state end-color) (-> v1-17 spec end-color))
           )
          )
        )
      (set! (-> v1-17 state mode) (the-as lightning-mode a0-8))
      )
    )
  (let ((v1-20 (-> obj neck)))
    (set! (-> v1-20 up) (the-as uint 1))
    (set! (-> v1-20 nose) (the-as uint 2))
    (set! (-> v1-20 ear) (the-as uint 0))
    (set-vector! (-> v1-20 twist-max) 3640.889 11832.889 0.0 1.0)
    (set! (-> v1-20 ignore-angle) 15473.777)
    )
  (let ((v1-22 (-> obj nav)))
    (set! (-> v1-22 speed-scale) 1.0)
    )
  0
  (set-gravity-length (-> obj root dynam) 573440.0)
  (logior! (-> obj nav flags) (nav-control-flag momentum-ignore-heading))
  (set-vector! (-> obj root scale) 0.8 0.8 0.8 1.0)
  (set! (-> obj draw light-index) (the-as uint 1))
  (set-vector! (-> obj draw color-emissive) 0.0 1.0 0.0 0.0)
  (set! (-> obj wiggle-angle) 0.0)
  (set! (-> obj delta-wiggle-angle) 182.04445)
  (set! (-> obj wiggle-factor) 2.0)
  (set! (-> obj id) (new 'static 'sound-id))
  (logclear! (-> obj mask) (process-mask actor-pause))
  (go (method-of-object obj spawning))
  (none)
  )

(deftype krew-boss-shot (guard-shot)
  ()
  :heap-base #x170
  :method-count-assert 40
  :size-assert         #x1f0
  :flag-assert         #x28017001f0
  )


(defun krew-boss-shot-move ((arg0 krew-boss-shot))
  (guard-shot-move arg0)
  0
  (none)
  )

(defmethod init-proj-settings! krew-boss-shot ((obj krew-boss-shot))
  "Init relevant settings for the [[projectile]] such as gravity, speed, timeout, etc"
  ((the-as (function projectile none) (find-parent-method krew-boss-shot 31)) obj)
  (set! (-> obj move) krew-boss-shot-move)
  (set! (-> obj max-speed) 245760.0)
  (set! (-> obj timeout) (seconds 5))
  (none)
  )

(defmethod play-impact-sound krew-boss-shot ((obj krew-boss-shot) (arg0 projectile-options))
  (let ((v1-0 arg0))
    (cond
      ((zero? v1-0)
       (sound-play "krew-shot-fire")
       )
      ((= v1-0 (projectile-options lose-altitude))
       (sound-play "krew-shot-hit")
       )
      )
    )
  0
  (none)
  )

(deftype hud-krew-boss (hud)
  ()
  :heap-base #xb30
  :method-count-assert 27
  :size-assert         #xba4
  :flag-assert         #x1b0b300ba4
  )


(defmethod draw hud-krew-boss ((obj hud-krew-boss))
  (set-hud-piece-position! (-> obj sprites 1) (the int (+ 462.0 (* 130.0 (-> obj offset)))) 350)
  (set-as-offset-from! (the-as hud-sprite (-> obj sprites)) (the-as vector4w (-> obj sprites 1)) -32 0)
  (set-as-offset-from! (-> obj sprites 2) (the-as vector4w (-> obj sprites 1)) -96 0)
  (set-as-offset-from! (-> obj sprites 5) (the-as vector4w (-> obj sprites 1)) -62 14)
  (set-as-offset-from! (-> obj sprites 6) (the-as vector4w (-> obj sprites 1)) -32 14)
  (let ((s5-0 (-> obj values 0 current))
        (f28-0 (* 0.01 (the float (-> obj values 1 current))))
        (f30-0 (* 0.01 (the float (-> obj values 2 current))))
        )
    (set-as-offset-from! (-> obj sprites 3) (the-as vector4w (-> obj sprites 1)) -92 15)
    (cond
      ((zero? s5-0)
       (set! (-> obj sprites 3 color x) 0)
       (set! (-> obj sprites 3 color y) 255)
       (set! f28-0 (+ 2.0 f28-0))
       )
      ((= s5-0 1)
       (set! (-> obj sprites 3 color y) 255)
       (set! (-> obj sprites 3 color x) 255)
       (set! f28-0 (+ 1.0 f28-0))
       )
      (else
        (set! (-> obj sprites 3 color x) 255)
        (set! (-> obj sprites 3 color y) 0)
        0
        )
      )
    (set! (-> obj sprites 3 scale-x) (* -7.25 f28-0))
    (set-as-offset-from! (-> obj sprites 4) (the-as vector4w (-> obj sprites 1)) -84 4)
    (cond
      ((< f30-0 0.5)
       (set! (-> obj sprites 4 color x) 255)
       (set! (-> obj sprites 4 color y) (the int (lerp 0.0 255.0 (* 2.0 f30-0))))
       )
      (else
        (set! (-> obj sprites 4 color x) (the int (lerp 255.0 0.0 (* 2.0 (+ -0.5 f30-0)))))
        (set! (-> obj sprites 4 color y) 255)
        )
      )
    (set! (-> obj sprites 4 scale-x) (* -18.25 f30-0))
    )
  ((method-of-type hud draw) obj)
  0
  (none)
  )

(defmethod update-values hud-krew-boss ((obj hud-krew-boss))
  (set! (-> obj values 0 target) (+ (-> (the-as krew-boss (-> obj parent 0)) gameplay-pass) -1))
  (let ((v1-7 (/ (-> (the-as krew-boss (-> obj parent 0)) hit-points)
                 (if (logtest? (-> *game-info* secrets) (game-secrets hero-mode))
                     2
                     1
                     )
                 )
              )
        )
    (case (-> (the-as krew-boss (-> obj parent 0)) gameplay-pass)
      ((1)
       (set! (-> obj values 1 target) (the int (* 3.3333333 (the float (+ v1-7 -70)))))
       )
      ((2)
       (set! (-> obj values 1 target) (the int (* 3.3333333 (the float (+ v1-7 -40)))))
       )
      (else
        (set! (-> obj values 1 target) (the int (* 2.5 (the float v1-7))))
        )
      )
    )
  (when (< (-> obj values 1 target) 0)
    (set! (-> obj values 1 target) 0)
    0
    )
  ((method-of-type hud update-values) obj)
  0
  (none)
  )

(defmethod init-callback hud-krew-boss ((obj hud-krew-boss))
  (set! (-> obj gui-id)
        (add-process *gui-control* obj (gui-channel hud-middle-right) (gui-action hidden) (-> obj name) 81920.0 0)
        )
  (set! (-> obj values 0 target) 0)
  (set! (-> obj values 1 target) 100)
  (logior! (-> obj flags) (hud-flags show))
  (set! (-> obj sprites 0 tex) (lookup-texture-by-id (new 'static 'texture-id :index #x3b :page #x67a)))
  (set! (-> obj sprites 0 flags) (the-as uint 4))
  (set! (-> obj sprites 1 tex) (lookup-texture-by-id (new 'static 'texture-id :index #x3c :page #x67a)))
  (set! (-> obj sprites 1 flags) (the-as uint 4))
  (set! (-> obj sprites 2 tex)
        (lookup-texture-by-name "hud-baronsymbol-01" (the-as string #f) (the-as (pointer texture-page) #f))
        )
  (set! (-> obj sprites 2 flags) (the-as uint 4))
  (set! (-> obj sprites 5 tex) (lookup-texture-by-id (new 'static 'texture-id :index #x3d :page #x67a)))
  (set! (-> obj sprites 5 scale-x) 0.5)
  (set! (-> obj sprites 5 flags) (the-as uint 4))
  (set! (-> obj sprites 6 tex) (lookup-texture-by-id (new 'static 'texture-id :index #x3d :page #x67a)))
  (set! (-> obj sprites 6 scale-x) 0.5)
  (set! (-> obj sprites 6 flags) (the-as uint 4))
  (set! (-> obj sprites 3 tex) (lookup-texture-by-id (new 'static 'texture-id :index #x41 :page #x67a)))
  (set! (-> obj sprites 3 scale-y) 3.25)
  (set! (-> obj sprites 3 color z) 0)
  (set! (-> obj sprites 3 flags) (the-as uint 4))
  (set! (-> obj sprites 4 tex) (lookup-texture-by-id (new 'static 'texture-id :index #x41 :page #x67a)))
  (set! (-> obj sprites 4 scale-y) 1.5)
  (set! (-> obj sprites 4 color z) 0)
  (set! (-> obj sprites 4 flags) (the-as uint 4))
  (alloc-string-if-needed obj 0)
  (set! (-> obj strings 0 flags) (font-flags kerning large))
  (set! (-> obj strings 0 scale) 0.5)
  0
  (none)
  )

(defpartgroup group-krew-boss-gun-charge
  :id 1204
  :flags (use-local-clock)
  :bounds (static-bspherem 0 0 0 8)
  :parts ((sp-item 5175 :flags (bit6) :period (seconds 1) :length (seconds 0.05))
    (sp-item 5176 :flags (bit6) :period (seconds 1) :length (seconds 0.05) :offset 75)
    (sp-item 5176 :flags (bit6) :period (seconds 1) :length (seconds 0.05) :offset 100)
    (sp-item 5177 :flags (bit6) :period (seconds 1) :length (seconds 0.05) :offset 150)
    (sp-item 5177 :flags (bit6) :period (seconds 1) :length (seconds 0.05) :offset 175)
    (sp-item 5177 :flags (bit6) :period (seconds 1) :length (seconds 0.05) :offset 200)
    (sp-item 5178 :flags (bit6) :period (seconds 1) :length (seconds 0.05) :offset 215)
    (sp-item 5178 :flags (bit6) :period (seconds 1) :length (seconds 0.05) :offset 235)
    (sp-item 5178 :flags (bit6) :period (seconds 1) :length (seconds 0.05) :offset 255)
    (sp-item 5178 :flags (bit6) :period (seconds 1) :length (seconds 0.05) :offset 275)
    )
  )

(defpart 5175
  :init-specs ((:texture (new 'static 'texture-id :index #xca :page #xc))
    (:num 1.0)
    (:x (meters -0.05))
    (:scale-x (meters 0.25))
    (:rot-x (degrees 6.7500005))
    (:scale-y :copy scale-x)
    (:r 128.0)
    (:g 0.0)
    (:b 0.0)
    (:a 32.0)
    (:timer (seconds 0.017))
    (:flags (sp-cpuinfo-flag-2 sp-cpuinfo-flag-3 glow))
    (:userdata 8192.0)
    (:func 'sparticle-track-root)
    )
  )

(defpart 5176
  :init-specs ((:texture (new 'static 'texture-id :index #xca :page #xc))
    (:num 1.0)
    (:x (meters -0.05))
    (:scale-x (meters 0.5))
    (:rot-x (degrees 6.7500005))
    (:scale-y :copy scale-x)
    (:r 128.0)
    (:g 0.0)
    (:b 0.0)
    (:a 64.0)
    (:timer (seconds 0.017))
    (:flags (sp-cpuinfo-flag-2 sp-cpuinfo-flag-3 glow))
    (:userdata 8192.0)
    (:func 'sparticle-track-root)
    )
  )

(defpart 5177
  :init-specs ((:texture (new 'static 'texture-id :index #xca :page #xc))
    (:num 1.0)
    (:x (meters -0.05))
    (:scale-x (meters 0.75))
    (:rot-x (degrees 6.7500005))
    (:scale-y :copy scale-x)
    (:r 128.0)
    (:g 32.0)
    (:b 32.0)
    (:a 96.0)
    (:timer (seconds 0.017))
    (:flags (sp-cpuinfo-flag-2 sp-cpuinfo-flag-3 glow))
    (:userdata 8192.0)
    (:func 'sparticle-track-root)
    )
  )

(defpart 5178
  :init-specs ((:texture (new 'static 'texture-id :index #xca :page #xc))
    (:num 1.0)
    (:x (meters -0.05))
    (:scale-x (meters 1.25))
    (:rot-x (degrees 6.7500005))
    (:scale-y :copy scale-x)
    (:r 128.0)
    (:g 32.0)
    (:b 32.0)
    (:a 128.0)
    (:timer (seconds 0.017))
    (:flags (sp-cpuinfo-flag-2 sp-cpuinfo-flag-3 glow))
    (:userdata 8192.0)
    (:func 'sparticle-track-root)
    )
  )

(define *krew-boss-crate-spawn-points*
  (new 'static 'boxed-array :type vector
    (new 'static 'vector :x -1187840.0 :y 1449984.0 :z -7054541.0 :w 1456.3556)
    (new 'static 'vector :x -1167360.0 :y 1449984.0 :z -7056179.0)
    (new 'static 'vector :x -1323008.0 :y 1449984.0 :z -6782976.0 :w 21845.334)
    (new 'static 'vector :x -1311948.8 :y 1449984.0 :z -6766592.0 :w 23119.645)
    )
  )

(define *krew-boss-clone-spawn-points* (new 'static 'boxed-array :type vector
                                         (new 'static 'vector :x -1208320.0 :y 1449984.0 :z -6705152.0)
                                         (new 'static 'vector :x -1118208.0 :y 1449984.0 :z -6705152.0)
                                         (new 'static 'vector :x -1040384.0 :y 1449984.0 :z -6746112.0)
                                         (new 'static 'vector :x -995328.0 :y 1449984.0 :z -6823936.0)
                                         (new 'static 'vector :x -995328.0 :y 1449984.0 :z -6918144.0)
                                         (new 'static 'vector :x -1040384.0 :y 1449984.0 :z -6995968.0)
                                         (new 'static 'vector :x -1114112.0 :y 1449984.0 :z -7041024.0)
                                         (new 'static 'vector :x -1204224.0 :y 1449984.0 :z -7041024.0)
                                         (new 'static 'vector :x -1286144.0 :y 1449984.0 :z -7000064.0)
                                         (new 'static 'vector :x -1290240.0 :y 1449984.0 :z -6754304.0)
                                         )
        )

(define *krew-boss-idle-path* (new 'static 'boxed-array :type vector
                                (new 'static 'vector :x -1019904.0 :y 1449984.0 :z -6512640.0)
                                (new 'static 'vector :x -917504.0 :y 1449984.0 :z -6656000.0)
                                (new 'static 'vector :x -806912.0 :y 1449984.0 :z -6840320.0)
                                )
        )

(define *krew-boss-nav-enemy-info*
  (new 'static 'nav-enemy-info
    :use-die-falling #f
    :use-victory #f
    :use-jump-blocked #f
    :debug-draw-neck #f
    :jump-debug-draw #f
    :move-to-ground #f
    :hover-if-no-ground #t
    :idle-anim-script (new 'static 'array idle-control-frame 4
      (new 'static 'idle-control-frame :command (ic-cmd push) :param0 #x1e)
      (new 'static 'idle-control-frame :command (ic-cmd play) :anim #x4 :param0 #x64 :param1 #x64)
      (new 'static 'idle-control-frame)
      (new 'static 'idle-control-frame)
      )
    :idle-anim 4
    :notice-anim 4
    :hostile-anim 18
    :hit-anim 4
    :knocked-anim 11
    :knocked-land-anim 12
    :die-anim 15
    :die-falling-anim 4
    :victory-anim -1
    :jump-wind-up-anim 4
    :jump-in-air-anim 4
    :jump-land-anim 4
    :neck-joint 5
    :look-at-joint 5
    :bullseye-joint 4
    :sound-hit (static-sound-name "krew-boss-hit")
    :sound-die (static-sound-name "krew-boss-die")
    :notice-distance (meters 200)
    :notice-distance-delta (meters 10)
    :proximity-notice-distance (meters 40)
    :default-hit-points 100
    :gnd-collide-with (collide-spec backgnd)
    :overlaps-others-collide-with-filter (collide-spec jak bot player-list)
    :penetrate-knocked (penetrate
      touch
      generic-attack
      lunge
      flop
      punch
      spin
      roll
      uppercut
      bonk
      tube
      vehicle
      flut-attack
      board
      mech
      mech-punch
      mech-bonk
      dark-skin
      dark-punch
      dark-bomb
      dark-giant
      shield
      explode
      jak-yellow-shot
      jak-red-shot
      jak-blue-shot
      jak-dark-shot
      enemy-yellow-shot
      enemy-dark-shot
      eco-yellow
      eco-red
      eco-blue
      eco-green
      knocked
      penetrate-33
      penetrate-34
      penetrate-35
      penetrate-36
      penetrate-37
      penetrate-38
      penetrate-39
      penetrate-40
      penetrate-41
      penetrate-42
      penetrate-43
      penetrate-44
      penetrate-45
      penetrate-46
      penetrate-47
      penetrate-48
      penetrate-49
      penetrate-50
      penetrate-51
      penetrate-52
      penetrate-53
      penetrate-54
      penetrate-55
      penetrate-56
      penetrate-57
      penetrate-58
      penetrate-59
      penetrate-60
      penetrate-61
      penetrate-62
      penetrate-63
      )
    :friction 0.9
    :attack-shove-back (meters 7.5)
    :attack-shove-up (meters 5)
    :attack-mode 'generic
    :attack-damage 2
    :recover-gnd-collide-with (collide-spec backgnd crate obstacle hit-by-others-list pusher)
    :jump-height-min (meters 3)
    :jump-height-factor 0.5
    :knocked-seek-ry-clamp -6371.5557
    :knocked-soft-vxz-lo 72089.6
    :knocked-soft-vxz-hi 108134.4
    :knocked-soft-vy-lo 81920.0
    :knocked-soft-vy-hi 122880.0
    :knocked-medium-vxz-lo 147456.0
    :knocked-medium-vxz-hi 196608.0
    :knocked-medium-vy-lo 135168.0
    :knocked-medium-vy-hi 151552.0
    :knocked-hard-vxz-lo 78643.2
    :knocked-hard-vxz-hi 117964.8
    :knocked-hard-vy-lo 183500.8
    :knocked-hard-vy-hi 209715.2
    :knocked-huge-vxz-lo 164659.2
    :knocked-huge-vxz-hi 249036.8
    :knocked-huge-vy-lo 183500.8
    :knocked-huge-vy-hi 217907.2
    :knocked-yellow-vxz-lo 122880.0
    :knocked-yellow-vxz-hi 147456.0
    :knocked-yellow-vy-lo 57344.0
    :knocked-yellow-vy-hi 81920.0
    :knocked-red-vxz-lo 24576.0
    :knocked-red-vxz-hi 196608.0
    :knocked-red-vy-lo 94208.0
    :knocked-red-vy-hi 151552.0
    :knocked-blue-vxz-lo 122880.0
    :knocked-blue-vxz-hi 147456.0
    :knocked-blue-vy-lo 24576.0
    :knocked-blue-vy-hi 81920.0
    :shadow-size (meters 1)
    :shadow-max-y (meters 1)
    :shadow-min-y (meters -1)
    :shadow-locus-dist (meters 150)
    :gem-joint -1
    :gem-offset (new 'static 'sphere :r 163840.0)
    :callback-info #f
    :use-momentum #t
    :use-frustration #t
    :use-stop-chase #f
    :use-circling #f
    :use-pacing #f
    :walk-anim 4
    :turn-anim -1
    :run-anim 4
    :taunt-anim -1
    :run-travel-speed (meters 7)
    :run-acceleration (meters 32)
    :run-turning-acceleration (meters 60)
    :walk-travel-speed (meters 4)
    :walk-acceleration (meters 16)
    :walk-turning-acceleration (meters 5)
    :maximum-rotation-rate (degrees 100.00001)
    :notice-nav-radius (meters 2)
    :frustration-distance (meters 8)
    :frustration-time (seconds 4)
    :blocked-time (seconds 0.3)
    :circle-dist-lo 20480.0
    :circle-dist-hi 61440.0
    :nav-mesh #f
    )
  )

(set! (-> *krew-boss-nav-enemy-info* fact-defaults) *fact-info-enemy-defaults*)

(defun baron-move-point-on-ground ((arg0 vector))
  (rlet ((acc :class vf)
         (vf0 :class vf)
         (vf4 :class vf)
         (vf5 :class vf)
         (vf6 :class vf)
         (vf7 :class vf)
         )
    (init-vf0-vector)
    (let ((s5-0 (new 'stack-no-clear 'collide-query)))
      (set! (-> s5-0 start-pos quad) (-> arg0 quad))
      (set-vector! (-> s5-0 move-dist) 0.0 -8192.0 0.0 1.0)
      (let ((v1-2 s5-0))
        (set! (-> v1-2 radius) 40.96)
        (set! (-> v1-2 collide-with) (collide-spec backgnd))
        (set! (-> v1-2 ignore-process0) #f)
        (set! (-> v1-2 ignore-process1) #f)
        (set! (-> v1-2 ignore-pat) (new 'static 'pat-surface :noentity #x1 :nojak #x1 :probe #x1 :noendlessfall #x1))
        (set! (-> v1-2 action-mask) (collide-action solid))
        )
      (let ((f0-5 (fill-and-probe-using-line-sphere *collide-cache* s5-0)))
        (when (< 0.0 f0-5)
          (let ((v0-1 arg0))
            (let ((v1-5 (-> s5-0 move-dist)))
              (let ((a0-10 f0-5))
                (.mov vf7 a0-10)
                )
              (.lvf vf5 (&-> v1-5 quad))
              )
            (.lvf vf4 (&-> arg0 quad))
            (.add.x.vf vf6 vf0 vf0 :mask #b1000)
            (.mul.x.vf acc vf5 vf7 :mask #b111)
            (.add.mul.w.vf vf6 vf4 vf0 acc :mask #b111)
            (.svf (&-> v0-1 quad) vf6)
            v0-1
            )
          )
        )
      )
    )
  )

(defmethod init-enemy! krew-boss ((obj krew-boss))
  "Common method called to initialize the enemy, typically sets up default field values and calls ancillary helper methods"
  (initialize-skeleton
    obj
    (the-as skeleton-group (art-group-get-by-name *level* "skel-krew-boss" (the-as (pointer uint32) #f)))
    (the-as pair 0)
    )
  (init-enemy-behaviour-and-stats! obj *krew-boss-nav-enemy-info*)
  (let ((v1-5 (-> obj neck)))
    (set! (-> v1-5 up) (the-as uint 1))
    (set! (-> v1-5 nose) (the-as uint 2))
    (set! (-> v1-5 ear) (the-as uint 0))
    (set-vector! (-> v1-5 twist-max) 3640.889 11832.889 0.0 1.0)
    (set! (-> v1-5 ignore-angle) 15473.777)
    )
  (logclear! (-> obj mask) (process-mask actor-pause))
  (let ((v1-9 (-> obj nav)))
    (set! (-> v1-9 speed-scale) 1.0)
    )
  0
  (set-gravity-length (-> obj root dynam) 573440.0)
  (logior! (-> obj nav flags) (nav-control-flag momentum-ignore-heading))
  (set-vector! (-> obj root trans) -1302528.0 -1449984.0 -6836224.0 1.0)
  (let ((v1-20 (-> obj nav state))
        (a0-17 (-> obj root trans))
        )
    (logclear! (-> v1-20 flags) (nav-state-flag directional-mode))
    (logior! (-> v1-20 flags) (nav-state-flag target-poly-dirty))
    (set! (-> v1-20 target-post quad) (-> a0-17 quad))
    )
  0
  (set! (-> obj next-clone-side) 0)
  (set! (-> obj last-closest-spawn) 0)
  (set! (-> obj next-shooting-frame) 0)
  (set! (-> obj floating) #f)
  (set! (-> obj next-path-point) 0)
  (set! (-> obj num-clones-to-spawn) 0)
  (set! (-> obj gameplay-pass) 0)
  (set! (-> obj hud-handle) (the-as handle #f))
  (set! (-> obj id) (new 'static 'sound-id))
  (set! (-> obj channel) (the-as uint 35))
  (set! (-> obj play-clone-wave-speech) #f)
  (set! (-> obj spawn-charge) #f)
  (dotimes (v1-24 8)
    (set! (-> obj clones v1-24) (the-as handle #f))
    )
  (set! (-> obj enemy-flags) (the-as enemy-flag (logclear (-> obj enemy-flags) (enemy-flag enemy-flag36))))
  (set! (-> obj nav callback-info) *nav-enemy-null-callback-info*)
  0
  0
  (none)
  )

;; WARN: Return type mismatch object vs none.
(defmethod go-idle krew-boss ((obj krew-boss))
  (cond
    ((task-node-closed? (game-task-node castle-boss-resolution))
     (cleanup-for-death obj)
     (go (method-of-object obj die-fast))
     )
    (else
      (go (method-of-object obj hidden))
      )
    )
  (none)
  )

(defstate hidden (krew-boss)
  :virtual #t
  :event (behavior ((proc process) (arg1 int) (event-type symbol) (event event-message-block))
    (case event-type
      (('trigger)
       (go-virtual play-intro)
       )
      )
    )
  :enter (behavior ()
    (logior! (-> self focus-status) (focus-status disable))
    (let ((v1-3 (-> self root root-prim)))
      (set! (-> v1-3 prim-core collide-as) (collide-spec))
      (set! (-> v1-3 prim-core collide-with) (collide-spec))
      )
    0
    (logior! (-> self draw status) (draw-control-status no-draw))
    (none)
    )
  :trans (behavior ()
    (if (task-node-closed? (game-task-node castle-boss-introduction))
        (go-virtual play-intro)
        )
    (none)
    )
  :code (the-as (function none :behavior krew-boss) sleep-code)
  )

(defstate play-intro (krew-boss)
  :virtual #t
  :exit (behavior ()
    (logclear! (-> self draw status) (draw-control-status no-draw))
    (logclear! (-> self focus-status) (focus-status disable))
    (let ((v1-5 (-> self root root-prim)))
      (set! (-> v1-5 prim-core collide-as) (-> self root backup-collide-as))
      (set! (-> v1-5 prim-core collide-with) (-> self root backup-collide-with))
      )
    (none)
    )
  :code (behavior ()
    (when (not (task-node-closed? (game-task-node castle-boss-introduction)))
      (while (not (process-grab? *target* #f))
        (suspend)
        )
      (process-spawn scene-player :init scene-player-init "castle-krew-boss-fight-intro" #t #f)
      )
    (set-setting! 'music 'danger6 0.0 0)
    (while (not (task-node-closed? (game-task-node castle-boss-introduction)))
      (suspend)
      )
    (go-virtual idle)
    (none)
    )
  )

;; WARN: disable def twice: 22. This may happen when a cond (no else) is nested inside of another conditional, but it should be rare.
(defmethod general-event-handler krew-boss ((obj krew-boss) (arg0 process) (arg1 int) (arg2 symbol) (arg3 event-message-block))
  "Handles various events for the enemy
@TODO - unsure if there is a pattern for the events and this should have a more specific name"
  (case arg2
    (('track)
     (cond
       ((-> arg3 param 0)
        (if (logtest? (-> obj enemy-flags) (enemy-flag enable-on-active))
            #t
            'abort
            )
        )
       (else
         (logtest? (-> obj enemy-flags) (enemy-flag enable-on-active))
         )
       )
     )
    (('notify)
     (case (-> arg3 param 0)
       (('hit)
        (krew-hits-jak-speech obj)
        (set! (-> obj next-shooting-frame) 100)
        (set! (-> obj spawn-charge) #t)
        (let ((v0-0 (the-as object (current-time))))
          (set! (-> obj state-time) (the-as time-frame v0-0))
          v0-0
          )
        )
       )
     )
    (else
      ((method-of-type nav-enemy general-event-handler) obj arg0 arg1 arg2 arg3)
      )
    )
  )

(defmethod enemy-method-102 krew-boss ((obj krew-boss))
  #f
  )

(defmethod enemy-method-77 krew-boss ((obj krew-boss) (arg0 (pointer float)))
  (with-pp
    (ja-channel-push! 1 0)
    (cond
      ((<= (-> obj hit-points) 0)
       (let ((a0-2 (-> obj skel root-channel 0)))
         (set! (-> a0-2 frame-group) (the-as art-joint-anim (-> obj draw art-group data 14)))
         (set! (-> a0-2 param 0) (-> pp clock time-adjust-ratio))
         (set! (-> a0-2 frame-num) 0.0)
         (joint-control-channel-group! a0-2 (the-as art-joint-anim (-> obj draw art-group data 14)) num-func-loop!)
         )
       )
      (else
        (let ((a0-3 (-> obj skel root-channel 0)))
          (set! (-> a0-3 frame-group)
                (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-anim)))
                )
          (set! (-> a0-3 param 0)
                (the float
                     (+ (-> (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-anim))) frames num-frames)
                        -1
                        )
                     )
                )
          (set! (-> a0-3 param 1) (* 2.0 (-> pp clock time-adjust-ratio)))
          (set! (-> a0-3 frame-num) 0.0)
          (joint-control-channel-group!
            a0-3
            (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-anim)))
            num-func-seek!
            )
          )
        )
      )
    #t
    )
  )

(defmethod enemy-method-78 krew-boss ((obj krew-boss) (arg0 (pointer float)))
  (cond
    ((<= (-> obj hit-points) 0)
     #f
     )
    (else
      (ja-channel-push! 1 (seconds 0.1))
      (let ((a0-2 (-> obj skel root-channel 0)))
        (set! (-> a0-2 frame-group)
              (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-land-anim)))
              )
        (set! (-> a0-2 param 0)
              (the float
                   (+ (-> (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-land-anim)))
                          frames
                          num-frames
                          )
                      -1
                      )
                   )
              )
        (set! (-> a0-2 param 1) (* 2.0 (-> arg0 0)))
        (set! (-> a0-2 frame-num) 0.0)
        (joint-control-channel-group!
          a0-2
          (the-as art-joint-anim (-> obj draw art-group data (-> obj enemy-info knocked-land-anim)))
          num-func-seek!
          )
        )
      #t
      )
    )
  )

(defmethod enemy-method-81 krew-boss ((obj krew-boss))
  #f
  )

(defstate knocked (krew-boss)
  :virtual #t
  :enter (behavior ()
    (let ((t9-0 (-> (method-of-type nav-enemy knocked) enter)))
      (if t9-0
          (t9-0)
          )
      )
    (krew-hit-speech self)
    (logclear! (-> self enemy-flags) (enemy-flag enable-on-active))
    (logclear! (-> self nav flags) (nav-control-flag update-heading-from-facing))
    (none)
    )
  :exit (behavior ()
    (local-vars (v1-5 enemy-flag))
    (let ((t9-0 (-> (method-of-type nav-enemy knocked) exit)))
      (if t9-0
          (t9-0)
          )
      )
    (set! (-> self floating) #f)
    (let ((v1-4 (-> self enemy-flags)))
      (if (logtest? v1-4 (enemy-flag checking-water))
          (set! v1-5 (logior v1-4 (enemy-flag enable-on-active)))
          (set! v1-5 (logclear v1-4 (enemy-flag enable-on-active)))
          )
      )
    (set! (-> self enemy-flags) v1-5)
    (if (logtest? (enemy-flag enemy-flag43) (-> self enemy-flags))
        (logior! (-> self nav flags) (nav-control-flag update-heading-from-facing))
        (logclear! (-> self nav flags) (nav-control-flag update-heading-from-facing))
        )
    (none)
    )
  :post (behavior ()
    (logior! (-> self enemy-flags) (enemy-flag directed))
    (let ((gp-0 (-> self root)))
      (cond
        ((and (>= 1449984.0 (-> gp-0 trans y)) (< (-> gp-0 transv y) 0.0))
         (set! (-> gp-0 transv y) 0.0)
         (set! (-> gp-0 trans y) 1449984.0)
         (set! (-> self floating) #t)
         )
        (else
          (let ((a1-0 (new-stack-vector0)))
            (vector-v++! (-> gp-0 transv) (compute-acc-due-to-gravity gp-0 a1-0 (-> self enemy-info slip-factor)))
            )
          )
        )
      (let ((a2-1 (new 'stack-no-clear 'collide-query)))
        (set! (-> a2-1 collide-with) (-> gp-0 root-prim prim-core collide-with))
        (set! (-> a2-1 ignore-process0) self)
        (set! (-> a2-1 ignore-process1) #f)
        (set! (-> a2-1 ignore-pat) (-> gp-0 pat-ignore-mask))
        (set! (-> a2-1 action-mask) (collide-action solid))
        (fill-cache-integrate-and-collide gp-0 (-> gp-0 transv) a2-1 (meters 0))
        )
      (if (-> self floating)
          (logior! (-> gp-0 status) (collide-status on-ground touch-surface))
          )
      )
    (enemy-method-111 self)
    (nav-enemy-method-142 self (-> self nav))
    (track-target! self)
    (none)
    )
  )

(defmethod init-enemy-collision! krew-boss ((obj krew-boss))
  "Initializes the [[collide-shape-moving]] and any ancillary tasks to make the enemy collide properly"
  (let ((s5-0 (new 'process 'collide-shape-moving obj (collide-list-enum usually-hit-by-player))))
    (set! (-> s5-0 dynam) (copy *standard-dynamics* 'process))
    (set! (-> s5-0 reaction) cshape-reaction-default)
    (set! (-> s5-0 no-reaction)
          (the-as (function collide-shape-moving collide-query vector vector object) nothing)
          )
    (set! (-> s5-0 penetrated-by) (penetrate
                                    generic-attack
                                    lunge
                                    flop
                                    punch
                                    spin
                                    roll
                                    uppercut
                                    bonk
                                    tube
                                    vehicle
                                    flut-attack
                                    board
                                    mech-punch
                                    dark-punch
                                    dark-giant
                                    )
          )
    (let ((s4-0 (new 'process 'collide-shape-prim-group s5-0 (the-as uint 2) 0)))
      (set! (-> s5-0 total-prims) (the-as uint 3))
      (set! (-> s4-0 prim-core collide-as) (collide-spec enemy))
      (set! (-> s4-0 prim-core collide-with) (collide-spec backgnd jak bot crate player-list collectable))
      (set! (-> s4-0 prim-core action) (collide-action solid deadly))
      (set-vector! (-> s4-0 local-sphere) 0.0 9420.8 0.0 9420.8)
      (set! (-> s5-0 root-prim) s4-0)
      )
    (let ((v1-13 (new 'process 'collide-shape-prim-sphere s5-0 (the-as uint 0))))
      (set! (-> v1-13 prim-core collide-as) (collide-spec enemy))
      (set! (-> v1-13 prim-core collide-with) (collide-spec backgnd jak bot crate player-list collectable))
      (set! (-> v1-13 prim-core action) (collide-action solid deadly no-standon))
      (set-vector! (-> v1-13 local-sphere) 0.0 10649.6 0.0 8192.0)
      )
    (let ((v1-15 (new 'process 'collide-shape-prim-sphere s5-0 (the-as uint 0))))
      (set! (-> v1-15 prim-core collide-as) (collide-spec enemy))
      (set! (-> v1-15 prim-core collide-with) (collide-spec backgnd jak bot crate player-list collectable))
      (set! (-> v1-15 prim-core action) (collide-action solid deadly))
      (set-vector! (-> v1-15 local-sphere) 0.0 8192.0 0.0 8192.0)
      )
    (set! (-> s5-0 nav-radius) 8192.0)
    (let ((v1-17 (-> s5-0 root-prim)))
      (set! (-> s5-0 backup-collide-as) (-> v1-17 prim-core collide-as))
      (set! (-> s5-0 backup-collide-with) (-> v1-17 prim-core collide-with))
      )
    (set! (-> s5-0 max-iteration-count) (the-as uint 3))
    (set! (-> obj root) s5-0)
    )
  0
  (none)
  )

(defmethod coin-flip? krew-boss ((obj krew-boss))
  "@returns The result of a 50/50 RNG roll"
  #f
  )

(defstate idle (krew-boss)
  :virtual #t
  :enter (behavior ()
    (let ((v1-0 (-> self nav)))
      (set! (-> v1-0 target-speed) 122880.0)
      )
    0
    (set! (-> *krew-boss-nav-enemy-info* run-travel-speed) 122880.0)
    (when (nonzero? (-> self gameplay-pass))
      (nav-enemy-method-166 self)
      (let ((v1-8 self))
        (if (not (logtest? (enemy-flag enemy-flag36) (-> v1-8 enemy-flags)))
            (set! (-> v1-8 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag38) (-> v1-8 enemy-flags))))
            )
        (set! (-> v1-8 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag36) (-> v1-8 enemy-flags))))
        (set! (-> v1-8 nav callback-info) (-> v1-8 enemy-info callback-info))
        )
      0
      (let ((v1-11 self))
        (set! (-> v1-11 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag37) (-> v1-11 enemy-flags))))
        )
      0
      )
    (let ((v1-14 (-> self nav state))
          (a0-20 (-> *krew-boss-idle-path* (-> self next-path-point)))
          )
      (logclear! (-> v1-14 flags) (nav-state-flag directional-mode))
      (logior! (-> v1-14 flags) (nav-state-flag target-poly-dirty))
      (set! (-> v1-14 target-post quad) (-> a0-20 quad))
      )
    0
    (logclear! (-> self enemy-flags) (enemy-flag enable-on-active))
    (let ((v1-19 (-> self nav)))
      (set! (-> v1-19 sphere-mask) (the-as uint #x800fa))
      )
    0
    (logior! (-> self nav flags) (nav-control-flag update-heading-from-facing))
    (none)
    )
  :exit (behavior ()
    (set! (-> self next-shooting-frame) 200)
    (let ((v1-1 (-> self nav)))
      (set! (-> v1-1 target-speed) 122880.0)
      )
    0
    (set! (-> *krew-boss-nav-enemy-info* run-travel-speed) 122880.0)
    (let ((v1-5 (-> self nav)))
      (set! (-> v1-5 sphere-mask) (the-as uint #x800f8))
      )
    0
    (if (logtest? (enemy-flag enemy-flag43) (-> self enemy-flags))
        (logior! (-> self nav flags) (nav-control-flag update-heading-from-facing))
        (logclear! (-> self nav flags) (nav-control-flag update-heading-from-facing))
        )
    (none)
    )
  :trans (behavior ()
    (local-vars
      (sv-752 (pointer collide-shape))
      (sv-756 sphere)
      (sv-760 (pointer uint32))
      (sv-768 int)
      (sv-832 vector)
      (sv-848 int)
      (sv-864 int)
      (sv-880 vector)
      (sv-896 vector)
      (sv-912 vector)
      )
    (rlet ((vf0 :class vf)
           (vf4 :class vf)
           (vf5 :class vf)
           (vf6 :class vf)
           )
      (init-vf0-vector)
      (when (and (task-node-closed? (game-task-node castle-boss-introduction))
                 (zero? (-> self gameplay-pass))
                 (< (-> self root trans y) 0.0)
                 )
        (let ((v1-5 (-> self nav state))
              (a0-4 (-> *krew-boss-idle-path* (-> self next-path-point)))
              )
          (logclear! (-> v1-5 flags) (nav-state-flag directional-mode))
          (logior! (-> v1-5 flags) (nav-state-flag target-poly-dirty))
          (set! (-> v1-5 target-post quad) (-> a0-4 quad))
          )
        0
        (if (zero? (talker-spawn-func (-> *talker-speech* 308) *entity-pool* (target-pos 0) (the-as region #f)))
            (set! (-> self id)
                  (add-process *gui-control* self (the-as gui-channel (-> self channel)) (gui-action play) "kwbf002" -99.0 0)
                  )
            )
        (nav-enemy-method-166 self)
        (let ((v1-13 self))
          (if (not (logtest? (enemy-flag enemy-flag36) (-> v1-13 enemy-flags)))
              (set! (-> v1-13 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag38) (-> v1-13 enemy-flags))))
              )
          (set! (-> v1-13 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag36) (-> v1-13 enemy-flags))))
          (set! (-> v1-13 nav callback-info) (-> v1-13 enemy-info callback-info))
          )
        0
        (let ((v1-16 self))
          (set! (-> v1-16 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag37) (-> v1-16 enemy-flags))))
          )
        0
        (set! (-> self root trans y) 1449984.0)
        (set! (-> self num-clones-to-spawn) 20)
        (set! (-> self state-time) (current-time))
        )
      (when (< (vector-vector-xz-distance (-> self root trans) (-> *krew-boss-idle-path* (-> self next-path-point)))
               20480.0
               )
        (let ((gp-1 (+ (-> self next-path-point) 1)))
          (set! (-> self next-path-point) gp-1)
          (set! (-> self next-path-point) (mod gp-1 (length *krew-boss-idle-path*)))
          )
        (let ((v1-33 (-> self nav state))
              (a0-30 (-> *krew-boss-idle-path* (-> self next-path-point)))
              )
          (logclear! (-> v1-33 flags) (nav-state-flag directional-mode))
          (logior! (-> v1-33 flags) (nav-state-flag target-poly-dirty))
          (set! (-> v1-33 target-post quad) (-> a0-30 quad))
          )
        0
        (let ((v1-36 (-> self nav)))
          (set! (-> v1-36 target-speed) 20480.0)
          )
        0
        (set! (-> *krew-boss-nav-enemy-info* run-travel-speed) 20480.0)
        (when (-> self play-clone-wave-speech)
          (clones-wave-speech self)
          (set! (-> self play-clone-wave-speech) #f)
          )
        (when (zero? (-> self gameplay-pass))
          (+! (-> self gameplay-pass) 1)
          (set! (-> *krew-boss-clone-nav-enemy-info* run-travel-speed) 28672.0)
          )
        )
      (when (< 0.0 (-> self root trans y))
        (let ((gp-2 -1))
          (let ((v1-51 0))
            (dotimes (a0-34 8)
              (if (handle->process (-> self clones a0-34))
                  (+! v1-51 1)
                  (set! gp-2 a0-34)
                  )
              )
            (if (and (<= (-> self num-clones-to-spawn) 0) (nonzero? (-> self gameplay-pass)) (zero? v1-51))
                (go-virtual hostile)
                )
            )
          (when (and (> gp-2 0)
                     (> (-> self num-clones-to-spawn) 0)
                     (>= (- (current-time) (-> self state-time)) (seconds 0.6))
                     )
            (let ((s3-0 (-> self root))
                  (a1-26 (new 'stack-no-clear 'collide-query))
                  (s2-0 #t)
                  (s4-1 #f)
                  (s5-1 (new 'stack-no-clear 'vector))
                  )
              (when (find-ground s3-0 a1-26 (-> self enemy-info recover-gnd-collide-with) 8192.0 81920.0 1024.0)
                (let ((f0-8 (- (-> s3-0 trans y) (-> s3-0 gspot-pos y))))
                  (if (and (>= f0-8 -1228.8) (>= 26624.0 f0-8))
                      (set! s2-0 #f)
                      )
                  )
                )
              (cond
                ((not s2-0)
                 (set! (-> s5-1 quad) (-> s3-0 trans quad))
                 (set! s4-1 #t)
                 (set! (-> self state-time) (current-time))
                 )
                (else
                  (let ((s2-1 0)
                        (f30-0 8192000.0)
                        (s3-1 (length *krew-boss-clone-spawn-points*))
                        )
                    0
                    (dotimes (s1-0 s3-1)
                      (let ((s0-0 vector-vector-xz-distance))
                        (set! sv-832 (-> *krew-boss-clone-spawn-points* s1-0))
                        (let* ((a1-27 (target-pos 0))
                               (f0-9 (s0-0 sv-832 a1-27))
                               )
                          (when (< f0-9 f30-0)
                            (set! s2-1 s1-0)
                            (set! f30-0 f0-9)
                            )
                          )
                        )
                      )
                    (if (!= (-> self last-closest-spawn) s2-1)
                        (nonzero? (-> self next-clone-side))
                        )
                    (set! (-> self last-closest-spawn) s2-1)
                    (set! sv-848 (mod (+ s2-1 1) s3-1))
                    (set! sv-864 (mod (+ s2-1 -1) s3-1))
                    (let ((s1-1 (quaternion->matrix (new-stack-matrix0) (-> self root quat))))
                      (when (< sv-864 0)
                        (set! sv-864 (+ sv-864 s3-1))
                        sv-864
                        )
                      (let ((s0-1 (new 'stack-no-clear 'vector)))
                        (set! sv-880 (-> *krew-boss-clone-spawn-points* sv-848))
                        (let* ((v0-16 (target-pos 0))
                               (s0-2 (vector-! s0-1 sv-880 v0-16))
                               )
                          (set! sv-912 (new 'stack-no-clear 'vector))
                          (set! sv-896 (-> *krew-boss-clone-spawn-points* sv-864))
                          (let ((v0-17 (target-pos 0)))
                            (.lvf vf4 (&-> sv-896 quad))
                            (.lvf vf5 (&-> v0-17 quad))
                            )
                          (.mov.vf vf6 vf0 :mask #b1000)
                          (.sub.vf vf6 vf4 vf5 :mask #b111)
                          (.svf (&-> sv-912 quad) vf6)
                          (let ((f30-1 (vector-y-angle (-> s1-1 vector 2))))
                            (cond
                              ((< (fabs (deg-diff (vector-y-angle s0-2) f30-1)) (fabs (deg-diff (vector-y-angle sv-912) f30-1)))
                               (if (> (-> self next-clone-side) 0)
                                   (+! (-> self next-clone-side) 1)
                                   (set! (-> self next-clone-side) 1)
                                   )
                               )
                              ((< (-> self next-clone-side) 0)
                               (+! (-> self next-clone-side) -1)
                               )
                              (else
                                (set! (-> self next-clone-side) -1)
                                )
                              )
                            )
                          )
                        )
                      )
                    (let ((a0-62 (mod (+ s2-1 (-> self next-clone-side)) s3-1)))
                      (if (< a0-62 0)
                          (+! a0-62 s3-1)
                          )
                      (set! (-> s5-1 quad) (-> *krew-boss-clone-spawn-points* a0-62 quad))
                      )
                    )
                  )
                )
              (set! sv-752 (the-as (pointer collide-shape) (new 'stack-no-clear 'array 'collide-shape 10)))
              (let ((v1-121 (new 'stack-no-clear 'sphere)))
                (set! (-> v1-121 quad) (-> s5-1 quad))
                (set! sv-756 v1-121)
                )
              (set! sv-760 (new 'static 'array uint32 64
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             #x0
                             )
                    )
              (set! sv-768 0)
              (set! (-> sv-756 r) 10240.0)
              (set! sv-768 (fill-actor-list-for-sphere *actor-hash* sv-756 sv-752 10))
              (if s4-1
                  (set! sv-768 (+ sv-768 -1))
                  )
              (when (<= sv-768 0)
                (let ((s4-2 (new 'stack-no-clear 'enemy-init-by-other-params)))
                  (set! (-> s4-2 trans quad) (-> s5-1 quad))
                  (quaternion-copy! (-> s4-2 quat) (-> self root quat))
                  (set! (-> s4-2 entity) #f)
                  (set! (-> s4-2 directed?) #f)
                  (set! (-> s4-2 no-initial-move-to-ground?) #f)
                  (+! (-> self num-clones-to-spawn) -1)
                  (set! (-> self clones gp-2)
                        (ppointer->handle (process-spawn krew-boss-clone :init enemy-init-by-other self s4-2 :to self))
                        )
                  )
                )
              )
            )
          )
        )
      (none)
      )
    )
  :code (behavior ()
    (ja-channel-push! 1 (seconds 0.1))
    (ja :group! (-> self draw art-group data (-> self enemy-info idle-anim)) :num! min)
    (let ((f30-0 (get-rand-float-range self 0.3 0.5)))
      (until #f
        (suspend)
        (ja :num! (loop! f30-0))
        )
      )
    #f
    (none)
    )
  :post (behavior ()
    (let ((t9-0 (-> (method-of-type nav-enemy idle) post)))
      (if t9-0
          ((the-as (function none) t9-0))
          )
      )
    (if (< 0.0 (-> self root trans y))
        (seek! (-> self root trans y) 1470464.0 (* 204.8 (-> self clock time-adjust-ratio)))
        )
    (nav-enemy-method-176 self)
    (none)
    )
  )

(defmethod damage-amount-from-attack krew-boss ((obj krew-boss) (arg0 process) (arg1 event-message-block))
  "@returns the amount of damage taken from an attack.  This can come straight off the [[attack-info]] or via [[penetrate-using->damage]]"
  (let ((v1-0 (get-penetrate-using-from-attack-event (the-as process-drawable arg0) arg1)))
    (cond
      ((or (logtest? (penetrate jak-blue-shot) v1-0) (logtest? (penetrate jak-dark-shot) v1-0))
       (cond
         ((>= (- (current-time) (-> obj last-damage-time)) (seconds 5))
          (set! (-> obj last-damage-time) (current-time))
          5
          )
         (else
           0
           )
         )
       )
      ((logtest? (penetrate dark-bomb) v1-0)
       20
       )
      (else
        5
        )
      )
    )
  )

(defmethod nav-enemy-method-142 krew-boss ((obj krew-boss) (arg0 nav-control))
  (with-pp
    (cond
      ((not (logtest? (-> obj nav flags) (nav-control-flag update-heading-from-facing)))
       (let ((s5-1 (vector-! (new 'stack-no-clear 'vector) (target-pos 0) (-> obj root trans)))
             (s3-0 (quaternion->matrix (new-stack-matrix0) (-> obj root quat)))
             )
         (vector-normalize! s5-1 1.0)
         (let* ((s4-0 (vector-normalize-copy! (new 'stack-no-clear 'vector) (-> s3-0 vector 1) 1.0))
                (s3-1 (vector-normalize-copy! (new 'stack-no-clear 'vector) (-> s3-0 vector 2) 1.0))
                (s5-2 (vector-normalize! (vector-flatten! (new 'stack-no-clear 'vector) s5-1 s4-0) 1.0))
                (f30-0 (vector-y-angle s3-1))
                (f0-0 (vector-y-angle s5-2))
                (f1-1 (fabs (- f30-0 f0-0)))
                (f2-0 182.04445)
                )
           (cond
             ((= (-> obj gameplay-pass) 2)
              (set! f2-0 273.06668)
              )
             ((= (-> obj gameplay-pass) 3)
              (set! f2-0 364.0889)
              )
             )
           (if (< 16384.0 f1-1)
               (set! f2-0 910.2222)
               )
           (if (< 32768.0 f1-1)
               (set! f0-0 (if (< f30-0 f0-0)
                              (+ -65536.0 f0-0)
                              (+ 65536.0 f0-0)
                              )
                     )
               )
           (let ((f0-3 (seek f30-0 f0-0 (* f2-0 (-> pp clock time-adjust-ratio)))))
             (quaternion-axis-angle! (-> obj root quat) 0.0 1.0 0.0 f0-3)
             )
           )
         )
       )
      (else
        ((method-of-type nav-enemy nav-enemy-method-142) obj arg0)
        )
      )
    0
    (none)
    )
  )

(defstate hostile (krew-boss)
  :virtual #t
  :event (the-as (function process int symbol event-message-block object :behavior krew-boss) enemy-event-handler)
  :enter (behavior ()
    (let ((gp-0 (/ (-> self hit-points) (if (logtest? (-> *game-info* secrets) (game-secrets hero-mode))
                                            2
                                            1
                                            )
                   )
                )
          )
      (cond
        ((= (-> self gameplay-pass) 1)
         (when (>= 70 gp-0)
           (if (< gp-0 70)
               (set! gp-0 70)
               )
           (+! (-> self gameplay-pass) 1)
           (set! (-> self num-clones-to-spawn) 25)
           (set! (-> *krew-boss-clone-nav-enemy-info* run-travel-speed) 36864.0)
           (send-event (-> self hud-handle process 0) 'hide-and-die)
           (set! (-> self hud-handle) (the-as handle #f))
           (set! (-> self play-clone-wave-speech) #t)
           (send-event *target* 'get-notify #f)
           (go-virtual idle)
           )
         )
        ((= (-> self gameplay-pass) 2)
         (when (>= 40 gp-0)
           (if (< gp-0 40)
               (set! gp-0 40)
               )
           (set! (-> self num-clones-to-spawn) 30)
           (set! (-> *krew-boss-clone-nav-enemy-info* run-travel-speed) 40960.0)
           (+! (-> self gameplay-pass) 1)
           (send-event (-> self hud-handle process 0) 'hide-and-die)
           (set! (-> self hud-handle) (the-as handle #f))
           (set! (-> self play-clone-wave-speech) #t)
           (send-event *target* 'get-notify #f)
           (go-virtual idle)
           )
         )
        )
      (set! (-> self hit-points) (* gp-0 (if (logtest? (-> *game-info* secrets) (game-secrets hero-mode))
                                             2
                                             1
                                             )
                                    )
            )
      )
    (look-at-target! self (enemy-flag lock-focus))
    (logior! (-> self enemy-flags) (enemy-flag use-notice-distance))
    (let ((v1-58 self))
      (if (not (logtest? (enemy-flag enemy-flag36) (-> v1-58 enemy-flags)))
          (set! (-> v1-58 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag38) (-> v1-58 enemy-flags))))
          )
      (set! (-> v1-58 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag36) (-> v1-58 enemy-flags))))
      (set! (-> v1-58 nav callback-info) (-> v1-58 enemy-info callback-info))
      )
    0
    (nav-enemy-method-166 self)
    (let ((v1-63 self))
      (set! (-> v1-63 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag37) (-> v1-63 enemy-flags))))
      )
    0
    (logclear! (-> self mask) (process-mask actor-pause))
    (let ((gp-1 (handle->process (-> self focus handle))))
      (if (not gp-1)
          (go-virtual active)
          )
      (set! (-> self focus-pos quad) (-> (get-trans (the-as process-focusable gp-1) 0) quad))
      )
    (let ((f30-0 (-> self enemy-info circle-dist-lo))
          (f28-0 (-> self enemy-info circle-dist-hi))
          )
      (if (zero? (get-rand-int self 4))
          (set! (-> self desired-angle) (get-rand-float-range self f30-0 f28-0))
          (set! (-> self desired-angle)
                (fmax (fmin (vector-vector-xz-distance (-> self focus-pos) (-> self root trans)) f28-0) f30-0)
                )
          )
      )
    (set! (-> self spawn-charge) #t)
    (set! (-> self enemy-flags) (the-as enemy-flag (logxor (shl 256 32) (the-as int (-> self enemy-flags)))))
    (set! (-> self enemy-flags) (the-as enemy-flag (logclear (-> self enemy-flags) (enemy-flag enemy-flag41))))
    (set! (-> self starting-time) (current-time))
    (when (not (handle->process (-> self hud-handle)))
      (set! (-> self hud-handle) (ppointer->handle (process-spawn hud-krew-boss :init hud-init-by-other :to self)))
      (krew-comes-in-speech self)
      (send-event *target* 'get-notify self)
      )
    (logclear! (-> self nav flags) (nav-control-flag update-heading-from-facing))
    (none)
    )
  :exit (behavior ()
    (if (logtest? (enemy-flag enemy-flag43) (-> self enemy-flags))
        (logior! (-> self nav flags) (nav-control-flag update-heading-from-facing))
        (logclear! (-> self nav flags) (nav-control-flag update-heading-from-facing))
        )
    (none)
    )
  :trans (behavior ()
    (local-vars (v1-25 enemy-flag))
    (let ((a0-1 (handle->process (-> self focus handle))))
      (if a0-1
          (set! (-> self focus-pos quad) (-> (get-trans (the-as process-focusable a0-1) 0) quad))
          )
      )
    (if (or (!= (-> self focus aware) 3) (not (get-enemy-target self)))
        (set! (-> self starting-time) (current-time))
        )
    (when (= (-> self next-shooting-frame) 200)
      (cond
        ((< (vector-length (vector-! (new 'stack-no-clear 'vector) (-> self focus-pos) (-> self root trans))) 122880.0)
         (set! (-> self next-shooting-frame) 0)
         (ja :chan 1 :num-func num-func-identity :frame-num 0.0)
         (let ((v1-24 (-> self enemy-flags)))
           (if (logtest? v1-24 (enemy-flag checking-water))
               (set! v1-25 (logior v1-24 (enemy-flag enable-on-active)))
               (set! v1-25 (logclear v1-24 (enemy-flag enable-on-active)))
               )
           )
         (set! (-> self enemy-flags) v1-25)
         (cond
           ((= (-> self gameplay-pass) 1)
            (let ((v1-28 (-> self nav)))
              (set! (-> v1-28 target-speed) 24576.0)
              )
            0
            (set! (-> *krew-boss-nav-enemy-info* run-travel-speed) 24576.0)
            )
           ((= (-> self gameplay-pass) 2)
            (let ((v1-34 (-> self nav)))
              (set! (-> v1-34 target-speed) 28672.0)
              )
            0
            (set! (-> *krew-boss-nav-enemy-info* run-travel-speed) 28672.0)
            )
           ((= (-> self gameplay-pass) 3)
            (let ((v1-39 (-> self nav)))
              (set! (-> v1-39 target-speed) 36864.0)
              )
            0
            (set! (-> *krew-boss-nav-enemy-info* run-travel-speed) 36864.0)
            )
           )
         )
        (else
          (set! (-> self state-time) (current-time))
          )
        )
      )
    (none)
    )
  :code (behavior ()
    (ja-channel-push! 2 (seconds 0.1))
    (ja :group! (-> self draw art-group data (-> self enemy-info idle-anim)) :num! min)
    (ja :chan 1 :group! (-> self draw art-group data (-> self enemy-info hostile-anim)) :num! min)
    (let ((f30-0 (get-rand-float-range self 0.9 1.1)))
      (until #f
        (ja :num! (loop! f30-0))
        (when (!= (-> self next-shooting-frame) 100)
          (let ((a0-6 (-> self skel root-channel 1)))
            (let ((f0-2 0.5))
              (set! (-> a0-6 frame-interp 1) f0-2)
              (set! (-> a0-6 frame-interp 0) f0-2)
              )
            (set! (-> a0-6 param 0) (the float (+ (-> a0-6 frame-group frames num-frames) -1)))
            (set! (-> a0-6 param 1) 1.0)
            (joint-control-channel-group-eval! a0-6 (the-as art-joint-anim #f) num-func-seek!)
            )
          )
        (suspend)
        )
      )
    #f
    (none)
    )
  :post (behavior ()
    (let ((a0-0 self))
      (when (logtest? (enemy-flag enemy-flag36) (-> a0-0 enemy-flags))
        (let ((s5-0 (new 'stack-no-clear 'vector)))
          (let ((gp-0 (new 'stack-no-clear 'vector)))
            (let ((f30-0 16384.0))
              (if (logtest? (enemy-flag enemy-flag40) (-> self enemy-flags))
                  (set! f30-0 (- f30-0))
                  )
              (set! (-> s5-0 quad) (-> self focus-pos quad))
              (vector-! gp-0 (-> self root trans) s5-0)
              (set! (-> gp-0 y) 0.0)
              (vector-normalize! gp-0 (-> self desired-angle))
              (vector+! s5-0 s5-0 gp-0)
              (vector-rotate-around-y! gp-0 gp-0 f30-0)
              )
            (vector-normalize! gp-0 16384.0)
            (vector+! s5-0 s5-0 gp-0)
            )
          (let ((gp-1 (new 'stack-no-clear 'vector)))
            (set! (-> gp-1 quad) (-> self root trans quad))
            (cloest-point-on-mesh (-> self nav) gp-1 s5-0 (the-as nav-poly #f))
            (if (< (vector-vector-xz-distance gp-1 (-> self root trans)) 409.6)
                (set! (-> self enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag41) (-> self enemy-flags))))
                (set! (-> self enemy-flags) (the-as enemy-flag (logclear (-> self enemy-flags) (enemy-flag enemy-flag41))))
                )
            (let ((v1-28 (-> self nav state)))
              (logclear! (-> v1-28 flags) (nav-state-flag directional-mode))
              (logior! (-> v1-28 flags) (nav-state-flag target-poly-dirty))
              (set! (-> v1-28 target-post quad) (-> gp-1 quad))
              )
            )
          )
        0
        )
      )
    (let ((gp-2 (the int (* 300.0 (- 3.0 (* 0.5 (+ -1.0 (the float (-> self gameplay-pass)))))))))
      (when (and (-> self spawn-charge) (>= (- (current-time) (-> self state-time)) (+ gp-2 -300)))
        (process-spawn
          part-tracker
          :init part-tracker-init
          (-> *part-group-id-table* 1204)
          300
          #f
          #f
          self
          33
          :to self
          )
        (set! (-> self spawn-charge) #f)
        )
      (when (and (= (-> self next-shooting-frame) 100) (>= (- (current-time) (-> self state-time)) gp-2))
        (set! (-> self next-shooting-frame) 0)
        (ja :chan 1 :num-func num-func-identity :frame-num 0.0)
        )
      )
    (if (= (the int (ja-frame-num 1)) (-> self next-shooting-frame))
        (logior! (-> self skel status) (joint-control-status sync-math))
        )
    (nav-enemy-travel-post)
    (seek! (-> self root trans y) 1449984.0 (* 204.8 (-> self clock time-adjust-ratio)))
    (when (= (the int (ja-frame-num 1)) (-> self next-shooting-frame))
      (logclear! (-> self skel status) (joint-control-status sync-math))
      (cond
        ((= (-> self next-shooting-frame) 20)
         (set! (-> self next-shooting-frame) 100)
         (set! (-> self spawn-charge) #t)
         (set! (-> self state-time) (current-time))
         )
        (else
          (+! (-> self next-shooting-frame) 5)
          )
        )
      (let* ((gp-5 *target*)
             (a0-40 (if (type? gp-5 process-focusable)
                        gp-5
                        )
                    )
             )
        (when a0-40
          (let ((gp-6 (new 'stack-no-clear 'projectile-init-by-other-params)))
            (let ((s4-0 (new 'stack-no-clear 'vector)))
              (set! (-> s4-0 quad) (-> (get-trans a0-40 0) quad))
              (let ((s2-0 (vector<-cspace! (new 'stack-no-clear 'vector) (-> self node-list data 32)))
                    (s5-2 (vector<-cspace! (new 'stack-no-clear 'vector) (-> self node-list data 33)))
                    )
                (let ((s3-0 (new 'stack-no-clear 'vector)))
                  0.0
                  (set! (-> s3-0 quad) (-> s4-0 quad))
                  (set! (-> s3-0 y) (-> s5-2 y))
                  (vector-! s3-0 s3-0 s5-2)
                  (let ((f0-17 (vector-length s3-0)))
                    (vector-! s3-0 s5-2 s2-0)
                    (set! (-> s3-0 y) 0.0)
                    (vector-normalize! s3-0 f0-17)
                    )
                  (set! (-> s3-0 y) (- (-> s4-0 y) (-> s5-2 y)))
                  (vector-normalize-copy! (-> gp-6 vel) s3-0 245760.0)
                  )
                (set! (-> gp-6 ent) #f)
                (set! (-> gp-6 charge) 1.0)
                (set! (-> gp-6 options) (projectile-options))
                (set! (-> gp-6 notify-handle) (the-as handle #f))
                (set! (-> gp-6 owner-handle) (the-as handle #f))
                (set! (-> gp-6 ignore-handle) (process->handle self))
                (let* ((v1-94 *game-info*)
                       (a0-55 (+ (-> v1-94 attack-id) 1))
                       )
                  (set! (-> v1-94 attack-id) a0-55)
                  (set! (-> gp-6 attack-id) a0-55)
                  )
                (set! (-> gp-6 timeout) (seconds 4))
                (set! (-> gp-6 pos quad) (-> s5-2 quad))
                )
              )
            (spawn-projectile krew-boss-shot gp-6 self *default-dead-pool*)
            )
          )
        )
      )
    (none)
    )
  )

(defmethod kill-prefer-falling krew-boss ((obj krew-boss))
  "If available in `enemy-info`, [[go]] to the [[die-falling]] state, if not, [[die]]"
  (when (handle->process (-> obj hud-handle))
    (send-event (-> obj hud-handle process 0) 'hide-and-die)
    (set! (-> obj hud-handle) (the-as handle #f))
    )
  (send-event *target* 'get-notify #f)
  (add-process *gui-control* obj (the-as gui-channel (-> obj channel)) (gui-action play) "ds269" -99.0 0)
  ((method-of-type nav-enemy kill-prefer-falling) obj)
  )

(define *krew-boss-die-positions* (new 'static 'boxed-array :type vector
                                    (new 'static 'vector :x -1167360.0 :y 1449984.0 :z -6746112.0)
                                    (new 'static 'vector :x -1040384.0 :y 1449984.0 :z -6860800.0)
                                    (new 'static 'vector :x -1155072.0 :y 1449984.0 :z -6991872.0)
                                    (new 'static 'vector :x -1290240.0 :y 1449984.0 :z -6881280.0)
                                    )
        )

(defstate die (krew-boss)
  :virtual #t
  :event (the-as (function process int symbol event-message-block object :behavior krew-boss) enemy-event-handler)
  :enter (behavior ()
    (let ((t9-0 (-> (method-of-type nav-enemy die) enter)))
      (if t9-0
          (t9-0)
          )
      )
    (set-setting! 'music #f 0.0 0)
    (nav-enemy-method-166 self)
    (let ((v1-8 self))
      (if (not (logtest? (enemy-flag enemy-flag36) (-> v1-8 enemy-flags)))
          (set! (-> v1-8 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag38) (-> v1-8 enemy-flags))))
          )
      (set! (-> v1-8 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag36) (-> v1-8 enemy-flags))))
      (set! (-> v1-8 nav callback-info) (-> v1-8 enemy-info callback-info))
      )
    0
    (let ((v1-11 self))
      (set! (-> v1-11 enemy-flags) (the-as enemy-flag (logior (enemy-flag enemy-flag37) (-> v1-11 enemy-flags))))
      )
    0
    (let ((v1-13 (-> self nav)))
      (set! (-> v1-13 sphere-mask) (the-as uint #x800fa))
      )
    0
    (set! (-> self next-path-point) 0)
    (let ((v1-15 (-> self nav)))
      (set! (-> v1-15 target-speed) 81920.0)
      )
    0
    (let ((v1-18 (-> self nav state))
          (a0-22 (-> *krew-boss-die-positions* (-> self next-path-point)))
          )
      (logclear! (-> v1-18 flags) (nav-state-flag directional-mode))
      (logior! (-> v1-18 flags) (nav-state-flag target-poly-dirty))
      (set! (-> v1-18 target-post quad) (-> a0-22 quad))
      )
    0
    (let ((v1-22 (-> self root root-prim)))
      (set! (-> v1-22 prim-core collide-as) (-> self root backup-collide-as))
      (set! (-> v1-22 prim-core collide-with) (-> self root backup-collide-with))
      )
    (iterate-process-tree
      *entity-pool*
      (the-as
        (function object object)
        (lambda ((arg0 collectable))
          (if (and (or (type? arg0 ammo-collectable) (type? arg0 health))
                   (and (nonzero? (-> arg0 root)) (>= 819200.0 (vector-vector-distance (-> arg0 root trans) (target-pos 0))))
                   )
              (deactivate arg0)
              )
          (none)
          )
        )
      *null-kernel-context*
      )
    (logior! (-> self nav flags) (nav-control-flag update-heading-from-facing))
    (none)
    )
  :exit (behavior ()
    (let ((t9-0 (-> (method-of-type nav-enemy die) exit)))
      (if t9-0
          (t9-0)
          )
      )
    (let ((v1-4 (-> self nav)))
      (set! (-> v1-4 sphere-mask) (the-as uint #x800f8))
      )
    0
    (none)
    )
  :trans (behavior ()
    (let ((f30-0 (vector-vector-xz-distance (target-pos 0) (-> *krew-boss-die-positions* (-> self next-path-point)))))
      (when (and (< f30-0
                    (vector-vector-xz-distance (-> self root trans) (-> *krew-boss-die-positions* (-> self next-path-point)))
                    )
                 (< f30-0 40960.0)
                 )
        (set! (-> self next-path-point) (- 1 (-> self next-path-point)))
        (let ((v1-13 (-> self nav state))
              (a0-7 (-> *krew-boss-die-positions* (-> self next-path-point)))
              )
          (logclear! (-> v1-13 flags) (nav-state-flag directional-mode))
          (logior! (-> v1-13 flags) (nav-state-flag target-poly-dirty))
          (set! (-> v1-13 target-post quad) (-> a0-7 quad))
          )
        0
        )
      )
    (none)
    )
  :code (behavior ()
    (while (< 81920.0
              (vector-vector-xz-distance (-> self root trans) (-> *krew-boss-die-positions* (-> self next-path-point)))
              )
      (ja :num! (loop! (-> self clock time-adjust-ratio)))
      (suspend)
      )
    (ja-channel-push! 1 (seconds 0.1))
    (ja-no-eval :group! (-> self draw art-group data 15)
                :num! (seek!
                  (the float (+ (-> (the-as art-joint-anim (-> self draw art-group data 15)) frames num-frames) -1))
                  (-> self clock time-adjust-ratio)
                  )
                :frame-num 0.0
                )
    (while (not (ja-done? 0))
      (ja-eval)
      (suspend)
      )
    (let ((v1-26 self))
      (set! (-> v1-26 enemy-flags) (the-as enemy-flag (logclear (-> v1-26 enemy-flags) (enemy-flag enemy-flag36))))
      (set! (-> v1-26 nav callback-info) *nav-enemy-null-callback-info*)
      )
    0
    (let ((v1-29 self))
      (set! (-> v1-29 enemy-flags) (the-as enemy-flag (logclear (-> v1-29 enemy-flags) (enemy-flag enemy-flag37))))
      )
    0
    (while (not (ja-done? 0))
      (ja-eval)
      (suspend)
      )
    (while (nonzero? (get-status *gui-control* (-> self id)))
      (suspend)
      )
    (set! (-> self movie-handle) (ppointer->handle (process-spawn
                                                     scene-player
                                                     :init scene-player-init
                                                     '("castle-krew-boss-fight-res" "city-ashelin-drop-off")
                                                     #t
                                                     #f
                                                     )
                                                   )
          )
    (send-event self 'death-end)
    (while (-> self child)
      (suspend)
      )
    (cleanup-for-death self)
    (none)
    )
  :post (behavior ()
    (nav-enemy-method-176 self)
    (none)
    )
  )

(defun casboss-deactivate ()
  (set-height! *ocean-map-city* 0.0)
  (set! (-> *math-camera* f) 40960000.0)
  0
  (none)
  )

(defun casboss-activate ()
  (set-height! *ocean-map-city* 57344.0)
  (set! (-> *math-camera* f) 81920000.0)
  0
  (none)
  )
