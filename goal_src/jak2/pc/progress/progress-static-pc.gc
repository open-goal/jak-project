;;-*-Lisp-*-
(in-package goal)

#|@file
Additional PC port specific file for overriding/expanding the progress menu
This gives us more freedom to write code how we want.
|#

(set! (-> *main-options-debug* options 9) (new 'static 'menu-main-menu-option :name (text-id progress-music-player) :scale #t :next-state 'music-player))

;; TODO - make the scale of the generic menus smaller so we can fit more on the screen, text is way bigger than it needs to be
;; backing out of a nested generic menu causes a history issue, might be because of leaving with start too, i think it might be overflowing the history entries or something need a consistent repro. exiting with start might be related
;; wire up should-disable?
;; in jak 2, the options dont have to be all-caps anymore!

(define *game-options-pc*
  (progress-new-generic-scrolling-page (text-id progress-root-game-options)
    (progress-new-generic-link-to-scrolling-page (text-id progress-menu-input-options)
      (progress-new-generic-link-to-scrolling-page (text-id progress-camera-options)
        (new 'static 'menu-generic-boolean-option
          :name (text-id progress-camera-options-first-horz)
          :truthy-text (text-id progress-normal)
          :falsey-text (text-id progress-inverted)
          :get-value-fn (lambda () (-> *pc-settings* first-camera-h-inverted?))
          :on-confirm (lambda ((val symbol))
            (set! (-> *pc-settings* first-camera-h-inverted?) val)
            (commit-to-file *pc-settings*)))
        (new 'static 'menu-generic-boolean-option
          :name (text-id progress-camera-options-first-vert)
          :truthy-text (text-id progress-normal)
          :falsey-text (text-id progress-inverted)
          :get-value-fn (lambda () (-> *pc-settings* first-camera-v-inverted?))
          :on-confirm (lambda ((val symbol))
            (set! (-> *pc-settings* first-camera-v-inverted?) val)
            (commit-to-file *pc-settings*)))
        (new 'static 'menu-generic-boolean-option
          :name (text-id progress-camera-options-third-horz)
          :truthy-text (text-id progress-normal)
          :falsey-text (text-id progress-inverted)
          :get-value-fn (lambda () (-> *pc-settings* third-camera-h-inverted?))
          :on-confirm (lambda ((val symbol))
            (set! (-> *pc-settings* third-camera-h-inverted?) val)
            (commit-to-file *pc-settings*)))
        (new 'static 'menu-generic-boolean-option
          :name (text-id progress-camera-options-third-vert)
          :truthy-text (text-id progress-normal)
          :falsey-text (text-id progress-inverted)
          :get-value-fn (lambda () (-> *pc-settings* third-camera-v-inverted?))
          :on-confirm (lambda ((val symbol))
            (set! (-> *pc-settings* third-camera-v-inverted?) val)
            (commit-to-file *pc-settings*)))
        (new 'static 'menu-generic-confirm-option
          :name (text-id progress-restore-defaults)
          :on-confirm (lambda ((val symbol))
            (reset-camera *pc-settings* #t)
            (commit-to-file *pc-settings*))))
      (progress-new-generic-link-to-scrolling-page (text-id progress-menu-controller-options)
        (new 'static 'menu-generic-carousel-option
          :name (text-id progress-controller-options-select-controller)
          :get-max-size-fn (lambda () (pc-get-controller-count))
          :get-item-label-fn (lambda ((index int))
            (pc-get-controller-name index *pc-cpp-temp-string*)
            *pc-cpp-temp-string*)
          :get-item-index-fn (lambda () 0)
          :on-confirm (lambda ((index int)) (pc-set-controller! 0 index)))
        (new 'static 'menu-generic-boolean-option
          :name (text-id progress-vibration)
          :should-disable? (lambda () #t);;(not (pc-current-controller-has-rumble?)))
          :truthy-text (text-id progress-on)
          :falsey-text (text-id progress-off)
          :get-value-fn (lambda () (-> *setting-control* user-default vibration))
          :on-confirm (lambda ((val symbol)) (set! (-> *setting-control* user-default vibration) val)))
        (new 'static 'menu-generic-slider-option
          :name (text-id progress-controller-options-analog-deadzone)
          :min-value 0.0
          :max-value 1.0
          :step 0.01
          :show-decimal? #t
          :get-value-fn (lambda () (-> *pc-settings* stick-deadzone))
          :on-confirm (lambda ((val float))
            (set! (-> *pc-settings* stick-deadzone) val)
            (commit-to-file *pc-settings*)))
        (new 'static 'menu-generic-boolean-option
          :name (text-id progress-controller-options-ignore-if-unfocused)
          :truthy-text (text-id progress-on)
          :falsey-text (text-id progress-off)
          :get-value-fn (lambda () (-> *pc-settings* ignore-controller-win-unfocused?))
          :on-confirm (lambda ((val symbol))
            (set! (-> *pc-settings* ignore-controller-win-unfocused?) val)
            (commit-to-file *pc-settings*)))
        (new 'static 'menu-generic-boolean-option
          :name (text-id progress-controller-options-led-hp)
          :truthy-text (text-id progress-on)
          :falsey-text (text-id progress-off)
          :get-value-fn (lambda () (-> *pc-settings* controller-hp-led?))
          :on-confirm (lambda ((val symbol))
            (set! (-> *pc-settings* controller-hp-led?) val)
            (commit-to-file *pc-settings*)))
        (new 'static 'menu-generic-boolean-option
          :name (text-id progress-controller-options-led-darkjak)
          :truthy-text (text-id progress-on)
          :falsey-text (text-id progress-off)
          :get-value-fn (lambda () (-> *pc-settings* controller-eco-led?))
          :on-confirm (lambda ((val symbol))
            (set! (-> *pc-settings* controller-eco-led?) val)
            (commit-to-file *pc-settings*)))
        (new 'static 'menu-generic-confirm-option
          :name (text-id progress-restore-defaults)
          :on-confirm (lambda ((val symbol))
            (reset-input *pc-settings* 'controller #t)
            (set-ignore-controller-in-bg! *pc-settings* (-> *pc-settings* ignore-controller-win-unfocused?))
            (commit-to-file *pc-settings*))))
      (new 'static 'menu-generic-boolean-option
        :name (text-id progress-input-options-enable-keyboard)
        :truthy-text (text-id progress-on)
        :falsey-text (text-id progress-off)
        :get-value-fn (lambda () (-> *pc-settings* keyboard-enabled?))
        :on-confirm (lambda ((val symbol))
          (set! (-> *pc-settings* keyboard-enabled?) val)
          (commit-to-file *pc-settings*)))
      (new 'static 'menu-generic-boolean-option
        :name (text-id progress-input-options-enable-mouse)
        :truthy-text (text-id progress-on)
        :falsey-text (text-id progress-off)
        :get-value-fn (lambda () (-> *pc-settings* mouse-enabled?))
        :on-confirm (lambda ((val symbol))
          (set! (-> *pc-settings* mouse-enabled?) val)
          (commit-to-file *pc-settings*)))
      (progress-new-generic-link-to-scrolling-page (text-id progress-menu-mouse-options) ;; TODO - disable based on mouse setting
        (new 'static 'menu-generic-boolean-option
          :name (text-id progress-mouse-options-track-camera)
          :truthy-text (text-id progress-on)
          :falsey-text (text-id progress-off)
          :get-value-fn (lambda () (-> *pc-settings* mouse-camera?))
          :on-confirm (lambda ((val symbol))
            (set! (-> *pc-settings* mouse-camera?) val)
            (commit-to-file *pc-settings*)))
        ;; TODO - hidden based on track camera option
        (new 'static 'menu-generic-slider-option
          :name (text-id progress-mouse-options-horz-sens)
          :min-value -30.0
          :max-value 30.0
          :step 0.10
          :show-decimal? #t
          :get-value-fn (lambda () (-> *pc-settings* mouse-xsens))
          :on-confirm (lambda ((val float))
            (set! (-> *pc-settings* mouse-xsens) val)
            (commit-to-file *pc-settings*)))
        ;; TODO - hidden based on track camera option
        (new 'static 'menu-generic-slider-option
          :name (text-id progress-mouse-options-vert-sens)
          :min-value -30.0
          :max-value 30.0
          :step 0.10
          :show-decimal? #t
          :get-value-fn (lambda () (-> *pc-settings* mouse-ysens))
          :on-confirm (lambda ((val float))
            (set! (-> *pc-settings* mouse-ysens) val)
            (commit-to-file *pc-settings*)))
        (new 'static 'menu-generic-boolean-option
          :name (text-id progress-mouse-options-player-movement)
          :truthy-text (text-id progress-on)
          :falsey-text (text-id progress-off)
          :get-value-fn (lambda () (-> *pc-settings* mouse-movement?))
          :on-confirm (lambda ((val symbol))
            (set! (-> *pc-settings* mouse-movement?) val)
            (commit-to-file *pc-settings*)))
        (new 'static 'menu-generic-confirm-option
          :name (text-id progress-restore-defaults)
          :on-confirm (lambda ((val symbol))
            (reset-input *pc-settings* 'mouse #t)
            (update-mouse-controls! *pc-settings*)
            (commit-to-file *pc-settings*))))
      (new 'static 'menu-generic-boolean-option
        :name (text-id progress-input-options-auto-hide-cursor)
        :truthy-text (text-id progress-on)
        :falsey-text (text-id progress-off)
        :get-value-fn (lambda () (-> *pc-settings* auto-hide-cursor?))
        :on-confirm (lambda ((val symbol))
          (set! (-> *pc-settings* auto-hide-cursor?) val)
          (commit-to-file *pc-settings*)))
      (progress-new-generic-link-to-scrolling-page (text-id progress-menu-reassign-binds)
        (progress-new-generic-link (text-id progress-reassign-binds-controller)
          ;; TODO - make details list to use for keybinds
          ;; TODO - shouldn't be a bool!
          (progress-new-generic-option (new 'static 'menu-generic-boolean-option
            :name (text-id progress-restore-defaults)
            :truthy-text (text-id progress-on)
            :falsey-text (text-id progress-off)
            :get-value-fn (lambda () #t)
            :on-confirm (lambda ((val symbol)) (format 0 "TODO~%")))))
        (progress-new-generic-link (text-id progress-reassign-binds-keyboard)
          ;; TODO - make details list to use for keybinds;; TODO - shouldn't be a bool!
          (progress-new-generic-option (new 'static 'menu-generic-boolean-option
            :name (text-id progress-restore-defaults)
            :truthy-text (text-id progress-on)
            :falsey-text (text-id progress-off)
            :get-value-fn (lambda () #t)
            :on-confirm (lambda ((val symbol)) (format 0 "TODO~%")))))
        (progress-new-generic-link (text-id progress-reassign-binds-mouse)
          ;; TODO - make details list to use for keybinds;; TODO - shouldn't be a bool!
          (progress-new-generic-option (new 'static 'menu-generic-boolean-option
            :name (text-id progress-restore-defaults)
            :truthy-text (text-id progress-on)
            :falsey-text (text-id progress-off)
            :get-value-fn (lambda () #t)
            :on-confirm (lambda ((val symbol)) (format 0 "TODO~%")))))
        )
      (new 'static 'menu-generic-confirm-option
        :name (text-id progress-restore-defaults)
        :on-confirm (lambda ((val symbol))
          (reset-input *pc-settings* 'input #t)
          (set-enable-keyboard! *pc-settings* (-> *pc-settings* keyboard-enabled?))
          (update-mouse-controls! *pc-settings*)
          (commit-to-file *pc-settings*)))
    )
    (new 'static 'menu-generic-boolean-option
      :name (text-id progress-subtitles)
      :truthy-text (text-id progress-on)
      :falsey-text (text-id progress-off)
      :get-value-fn (lambda () (-> *setting-control* user-default subtitle))
      :on-confirm (lambda ((val symbol)) (set! (-> *setting-control* user-default subtitle) val)))
    (new 'static 'menu-generic-carousel-option
      :name (text-id progress-sound-subtitle-language)
      :items (new 'static 'boxed-array :type text-id
                  (text-id language-name-english)
                  (text-id language-name-french)
                  (text-id language-name-german)
                  (text-id language-name-spanish)
                  (text-id language-name-italian)
                  (text-id language-name-japanese)
                  (text-id language-name-korean)
                  (text-id language-name-english-uk))
      :get-item-index-fn (lambda () (-> *setting-control* user-default subtitle-language))
      :on-confirm (lambda ((index int)) (set! (-> *setting-control* user-default subtitle-language)
                                              (the-as language-enum index))))
    (new 'static 'menu-generic-carousel-option
      :name (text-id progress-sound-language)
      :items (new 'static 'boxed-array :type text-id
                  (text-id language-name-english)
                  (text-id language-name-french)
                  (text-id language-name-german)
                  (text-id language-name-spanish)
                  (text-id language-name-italian)
                  (text-id language-name-japanese)
                  (text-id language-name-korean)
                  (text-id language-name-english-uk))
      :get-item-index-fn (lambda () (-> *setting-control* user-default language))
      :on-confirm (lambda ((index int)) (set! (-> *setting-control* user-default language) (the-as language-enum index))
                                        ;; NOTE - this doesn't actually work (naughty dog tried it too in their progress code)
                                        ;; fix it eventually
                                        (load-level-text-files (the-as int (-> *setting-control* user-default language)))))
    (progress-new-generic-link-to-scrolling-page (text-id progress-misc-game-options)
      (new 'static 'menu-generic-boolean-option
        :name (text-id progress-discord-rpc)
        :truthy-text (text-id progress-on)
        :falsey-text (text-id progress-off)
        :get-value-fn (lambda () (-> *pc-settings* discord-rpc?))
        :on-confirm (lambda ((val symbol))
          (set! (-> *pc-settings* discord-rpc?) val)
          (commit-to-file *pc-settings*)))
      (new 'static 'menu-generic-boolean-option
        :name (text-id progress-speedrunner-mode)
        :truthy-text (text-id progress-on)
        :falsey-text (text-id progress-off)
        :get-value-fn (lambda () (-> *pc-settings* speedrunner-mode?))
        :on-confirm (lambda ((val symbol))
          (set! (-> *pc-settings* speedrunner-mode?) val)
          (commit-to-file *pc-settings*))))))


;; TODO - update this
;; graphic options
;;   resolution
;;   display mode
;;   display select
;;   vsync
;;   aspect ratio
;;   msaa
;;   frame rate
;;   ps2 options
;;     lod bg
;;     lod fg
;;     particle culling
;;     force env mapping
;;     actor culling
(define *graphic-options-pc*
  (new 'static 'menu-option-list
    :y-center 198
    :y-space 34
    :scale 0.82
    :options (new 'static 'boxed-array :type menu-option
      (new 'static 'menu-display-mode-option :name (text-id progress-display-mode))
      (new 'static 'menu-aspect-ratio-pc-option :name (text-id progress-aspect-ratio))
      (new 'static 'menu-frame-rate-option :name (text-id progress-frame-rate))
      (new 'static 'menu-on-off-vsync-option :name (text-id progress-vsync))
      )
    )
  )

(define *frame-rate-options* (new 'static 'boxed-array :type int16 30 50 60 75 120 144 165 240))

(define *aspect-ratio-custom-options*
  (new 'static 'menu-option-list
    :y-center 198
    :y-space 34
    :scale 0.82
    :options (new 'static 'boxed-array :type menu-option
      (new 'static 'menu-aspect-ratio-custom-option :name (text-id progress-aspect-ratio-custom-title))
      )
    )
  )


(define *music-player-options*
  (new 'static 'menu-option-list
    :y-center 198
    :y-space 34
    :scale 0.82
    :options (new 'static 'boxed-array :type menu-option
      (new 'static 'menu-music-player-option :name (text-id progress-music-player))
      )
    )
  )


