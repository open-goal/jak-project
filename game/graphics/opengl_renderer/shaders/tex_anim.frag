#version 410 core

out vec4 color;

uniform vec4 rgba;
uniform int enable_tex;
uniform int tcc;
uniform ivec4 channel_scramble;
uniform float alpha_multiply;
uniform float minimum;
uniform float maximum;
uniform float slime_scroll;

in vec2 uv;

uniform sampler2D tex_T0;

float cloud_lookup(float v, float minimum, float maximum) {
  maximum = max(minimum, maximum);
  if (v <= minimum) {
    return 0.0;
  }
  if (v >= maximum) {
    return 1.0;
  }

  float alpha = (v - minimum) / (maximum - minimum);
  float sin_alpha = sin(alpha * 3.1415926 / 2.f);
  return sin_alpha * sin_alpha;
}

vec4 slime_lut[256] = vec4[](
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3254, 0.3333, 0.0745, 0.5019),
  vec4(0.3333, 0.3450, 0.0745, 0.5019),
  vec4(0.3411, 0.3607, 0.0745, 0.5019),
  vec4(0.3490, 0.3725, 0.0745, 0.5019),
  vec4(0.3568, 0.3882, 0.0745, 0.5019),
  vec4(0.3607, 0.4000, 0.0745, 0.5019),
  vec4(0.3686, 0.4117, 0.0745, 0.5019),
  vec4(0.3764, 0.4274, 0.0745, 0.5019),
  vec4(0.3764, 0.4274, 0.0784, 0.5019),
  vec4(0.3686, 0.4117, 0.0745, 0.5019),
  vec4(0.3607, 0.4000, 0.0745, 0.5019),
  vec4(0.3529, 0.3843, 0.0745, 0.5019),
  vec4(0.3490, 0.3725, 0.0745, 0.5019),
  vec4(0.3411, 0.3607, 0.0745, 0.5019),
  vec4(0.3333, 0.3450, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3215, 0.0745, 0.5019),
  vec4(0.3215, 0.3254, 0.0705, 0.5019),
  vec4(0.3254, 0.3294, 0.0705, 0.5019),
  vec4(0.3294, 0.3333, 0.0705, 0.5019),
  vec4(0.3333, 0.3372, 0.0705, 0.5019),
  vec4(0.3333, 0.3450, 0.0705, 0.5019),
  vec4(0.3372, 0.3490, 0.0705, 0.5019),
  vec4(0.3411, 0.3529, 0.0705, 0.5019),
  vec4(0.3450, 0.3568, 0.0705, 0.5019),
  vec4(0.3450, 0.3607, 0.0705, 0.5019),
  vec4(0.3490, 0.3686, 0.0705, 0.5019),
  vec4(0.3529, 0.3725, 0.0705, 0.5019),
  vec4(0.3568, 0.3764, 0.0705, 0.5019),
  vec4(0.3607, 0.3803, 0.0705, 0.5019),
  vec4(0.3607, 0.3843, 0.0705, 0.5019),
  vec4(0.3647, 0.3921, 0.0705, 0.5019),
  vec4(0.3686, 0.3960, 0.0705, 0.5019),
  vec4(0.3725, 0.4000, 0.0705, 0.5019),
  vec4(0.3725, 0.4039, 0.0705, 0.5019),
  vec4(0.3764, 0.4078, 0.0705, 0.5019),
  vec4(0.3803, 0.4156, 0.0705, 0.5019),
  vec4(0.3843, 0.4196, 0.0705, 0.5019),
  vec4(0.3882, 0.4235, 0.0705, 0.5019),
  vec4(0.3882, 0.4274, 0.0705, 0.5019),
  vec4(0.3921, 0.4313, 0.0705, 0.5019),
  vec4(0.3960, 0.4392, 0.0705, 0.5019),
  vec4(0.4000, 0.4431, 0.0705, 0.5019),
  vec4(0.4000, 0.4470, 0.0705, 0.5019),
  vec4(0.4039, 0.4509, 0.0705, 0.5019),
  vec4(0.4078, 0.4549, 0.0705, 0.5019),
  vec4(0.4117, 0.4627, 0.0705, 0.5019),
  vec4(0.4117, 0.4666, 0.0705, 0.5019),
  vec4(0.4235, 0.4862, 0.0705, 0.5019),
  vec4(0.4509, 0.5254, 0.0705, 0.5019),
  vec4(0.4784, 0.5686, 0.0705, 0.5019),
  vec4(0.5058, 0.6117, 0.0666, 0.5019),
  vec4(0.5333, 0.6509, 0.0666, 0.5019),
  vec4(0.5607, 0.6941, 0.0666, 0.5019),
  vec4(0.5882, 0.7372, 0.0666, 0.5019),
  vec4(0.6196, 0.7803, 0.0666, 0.5019),
  vec4(0.6196, 0.7803, 0.0666, 0.5019),
  vec4(0.6000, 0.7529, 0.0666, 0.5019),
  vec4(0.5803, 0.7254, 0.0666, 0.5019),
  vec4(0.5647, 0.6980, 0.0666, 0.5019),
  vec4(0.5450, 0.6705, 0.0666, 0.5019),
  vec4(0.5294, 0.6431, 0.0666, 0.5019),
  vec4(0.5098, 0.6156, 0.0705, 0.5019),
  vec4(0.4745, 0.5607, 0.0705, 0.5019),
  vec4(0.4666, 0.5450, 0.0705, 0.5019),
  vec4(0.4666, 0.5529, 0.0705, 0.5019),
  vec4(0.4705, 0.5568, 0.0705, 0.5019),
  vec4(0.4745, 0.5607, 0.0705, 0.5019),
  vec4(0.4784, 0.5647, 0.0705, 0.5019),
  vec4(0.4784, 0.5686, 0.0705, 0.5019),
  vec4(0.4823, 0.5764, 0.0705, 0.5019),
  vec4(0.4862, 0.5803, 0.0705, 0.5019),
  vec4(0.4901, 0.5843, 0.0705, 0.5019),
  vec4(0.4941, 0.5882, 0.0705, 0.5019),
  vec4(0.4941, 0.5921, 0.0705, 0.5019),
  vec4(0.4980, 0.6000, 0.0705, 0.5019),
  vec4(0.5019, 0.6039, 0.0705, 0.5019),
  vec4(0.5058, 0.6078, 0.0705, 0.5019),
  vec4(0.5058, 0.6117, 0.0705, 0.5019),
  vec4(0.5098, 0.6156, 0.0705, 0.5019),
  vec4(0.5137, 0.6235, 0.0705, 0.5019),
  vec4(0.5176, 0.6274, 0.0705, 0.5019),
  vec4(0.5215, 0.6313, 0.0705, 0.5019),
  vec4(0.5215, 0.6352, 0.0705, 0.5019),
  vec4(0.5254, 0.6392, 0.0705, 0.5019),
  vec4(0.5294, 0.6470, 0.0705, 0.5019),
  vec4(0.5333, 0.6509, 0.0705, 0.5019),
  vec4(0.5333, 0.6549, 0.0705, 0.5019),
  vec4(0.5372, 0.6588, 0.0705, 0.5019),
  vec4(0.5411, 0.6627, 0.0705, 0.5019),
  vec4(0.5450, 0.6705, 0.0705, 0.5019),
  vec4(0.5450, 0.6745, 0.0705, 0.5019),
  vec4(0.5490, 0.6784, 0.0705, 0.5019),
  vec4(0.5529, 0.6823, 0.0705, 0.5019),
  vec4(0.5568, 0.6862, 0.0705, 0.5019),
  vec4(0.5607, 0.6941, 0.0705, 0.5019),
  vec4(0.5607, 0.6980, 0.0705, 0.5019),
  vec4(0.5725, 0.7098, 0.0666, 0.5019),
  vec4(0.5803, 0.7254, 0.0666, 0.5019),
  vec4(0.5882, 0.7372, 0.0666, 0.5019),
  vec4(0.6000, 0.7490, 0.0666, 0.5019),
  vec4(0.6078, 0.7647, 0.0666, 0.5019),
  vec4(0.6156, 0.7764, 0.0666, 0.5019),
  vec4(0.6274, 0.7921, 0.0666, 0.5019),
  vec4(0.6274, 0.7921, 0.0666, 0.5019),
  vec4(0.6196, 0.7803, 0.0666, 0.5019),
  vec4(0.6117, 0.7686, 0.0666, 0.5019),
  vec4(0.6039, 0.7607, 0.0666, 0.5019),
  vec4(0.5960, 0.7490, 0.0666, 0.5019),
  vec4(0.5882, 0.7411, 0.0705, 0.5019),
  vec4(0.5803, 0.7294, 0.0705, 0.5019),
  vec4(0.5647, 0.7098, 0.0705, 0.5019),
  vec4(0.5647, 0.7098, 0.0705, 0.5019),
  vec4(0.5607, 0.7058, 0.0705, 0.5019),
  vec4(0.5568, 0.7019, 0.0705, 0.5019),
  vec4(0.5529, 0.6980, 0.0705, 0.5019),
  vec4(0.5529, 0.6941, 0.0705, 0.5019),
  vec4(0.5490, 0.6901, 0.0745, 0.5019),
  vec4(0.5450, 0.6862, 0.0745, 0.5019),
  vec4(0.5411, 0.6823, 0.0745, 0.5019),
  vec4(0.5411, 0.6823, 0.0745, 0.5019),
  vec4(0.5372, 0.6784, 0.0745, 0.5019),
  vec4(0.5333, 0.6745, 0.0745, 0.5019),
  vec4(0.5294, 0.6705, 0.0745, 0.5019),
  vec4(0.5294, 0.6666, 0.0745, 0.5019),
  vec4(0.5254, 0.6627, 0.0745, 0.5019),
  vec4(0.5215, 0.6588, 0.0745, 0.5019),
  vec4(0.5176, 0.6549, 0.0745, 0.5019),
  vec4(0.5176, 0.6549, 0.0745, 0.5019),
  vec4(0.5137, 0.6509, 0.0745, 0.5019),
  vec4(0.5098, 0.6470, 0.0784, 0.5019),
  vec4(0.5058, 0.6431, 0.0784, 0.5019),
  vec4(0.5058, 0.6392, 0.0784, 0.5019),
  vec4(0.5019, 0.6352, 0.0784, 0.5019),
  vec4(0.4980, 0.6313, 0.0784, 0.5019),
  vec4(0.4941, 0.6274, 0.0784, 0.5019),
  vec4(0.4941, 0.6274, 0.0784, 0.5019),
  vec4(0.4901, 0.6235, 0.0784, 0.5019),
  vec4(0.4862, 0.6196, 0.0784, 0.5019),
  vec4(0.4823, 0.6156, 0.0784, 0.5019),
  vec4(0.4823, 0.6117, 0.0784, 0.5019),
  vec4(0.4784, 0.6078, 0.0784, 0.5019),
  vec4(0.4745, 0.6039, 0.0784, 0.5019),
  vec4(0.4745, 0.6039, 0.0823, 0.5019),
  vec4(0.4745, 0.6039, 0.0823, 0.5019),
  vec4(0.4862, 0.6156, 0.0784, 0.5019),
  vec4(0.4980, 0.6313, 0.0784, 0.5019),
  vec4(0.5098, 0.6470, 0.0784, 0.5019),
  vec4(0.5215, 0.6588, 0.0745, 0.5019),
  vec4(0.5333, 0.6745, 0.0745, 0.5019),
  vec4(0.5450, 0.6901, 0.0745, 0.5019),
  vec4(0.5568, 0.7019, 0.0705, 0.5019),
  vec4(0.5686, 0.7176, 0.0705, 0.5019),
  vec4(0.5803, 0.7333, 0.0705, 0.5019),
  vec4(0.5921, 0.7490, 0.0705, 0.5019),
  vec4(0.6039, 0.7607, 0.0666, 0.5019),
  vec4(0.6156, 0.7764, 0.0666, 0.5019),
  vec4(0.6274, 0.7921, 0.0666, 0.5019),
  vec4(0.6392, 0.8039, 0.0627, 0.5019),
  vec4(0.6509, 0.8196, 0.0627, 0.5019),
  vec4(0.6745, 0.8509, 0.0627, 0.5019),
  vec4(0.6705, 0.8470, 0.0627, 0.5019),
  vec4(0.6666, 0.8431, 0.0627, 0.5019),
  vec4(0.6627, 0.8392, 0.0627, 0.5019),
  vec4(0.6588, 0.8352, 0.0627, 0.5019),
  vec4(0.6588, 0.8313, 0.0627, 0.5019),
  vec4(0.6549, 0.8274, 0.0627, 0.5019),
  vec4(0.6509, 0.8235, 0.0627, 0.5019),
  vec4(0.6470, 0.8196, 0.0627, 0.5019),
  vec4(0.6431, 0.8156, 0.0627, 0.5019),
  vec4(0.6431, 0.8117, 0.0627, 0.5019),
  vec4(0.6392, 0.8078, 0.0627, 0.5019),
  vec4(0.6352, 0.8039, 0.0666, 0.5019),
  vec4(0.6313, 0.8000, 0.0666, 0.5019),
  vec4(0.6274, 0.7960, 0.0666, 0.5019),
  vec4(0.6274, 0.7921, 0.0666, 0.5019),
  vec4(0.6235, 0.7882, 0.0666, 0.5019),
  vec4(0.6196, 0.7843, 0.0666, 0.5019),
  vec4(0.6156, 0.7803, 0.0666, 0.5019),
  vec4(0.6156, 0.7764, 0.0666, 0.5019),
  vec4(0.6117, 0.7725, 0.0666, 0.5019),
  vec4(0.6078, 0.7686, 0.0666, 0.5019),
  vec4(0.6039, 0.7647, 0.0666, 0.5019),
  vec4(0.6000, 0.7607, 0.0666, 0.5019),
  vec4(0.6000, 0.7568, 0.0666, 0.5019),
  vec4(0.5960, 0.7529, 0.0705, 0.5019),
  vec4(0.5921, 0.7490, 0.0705, 0.5019),
  vec4(0.5882, 0.7450, 0.0705, 0.5019),
  vec4(0.5843, 0.7411, 0.0705, 0.5019),
  vec4(0.5843, 0.7372, 0.0705, 0.5019),
  vec4(0.5803, 0.7333, 0.0705, 0.5019),
  vec4(0.5764, 0.7294, 0.0705, 0.5019),
  vec4(0.5725, 0.7254, 0.0705, 0.5019),
  vec4(0.5686, 0.7215, 0.0705, 0.5019),
  vec4(0.5686, 0.7176, 0.0705, 0.5019),
  vec4(0.5647, 0.7137, 0.0705, 0.5019),
  vec4(0.5607, 0.7098, 0.0705, 0.5019),
  vec4(0.5568, 0.7058, 0.0705, 0.5019),
  vec4(0.5568, 0.7019, 0.0745, 0.5019),
  vec4(0.5490, 0.6941, 0.0745, 0.5019),
  vec4(0.5490, 0.6941, 0.0745, 0.5019),
  vec4(0.5647, 0.7137, 0.0705, 0.5019),
  vec4(0.5803, 0.7294, 0.0705, 0.5019),
  vec4(0.5921, 0.7490, 0.0705, 0.5019),
  vec4(0.6078, 0.7647, 0.0666, 0.5019),
  vec4(0.6196, 0.7843, 0.0666, 0.5019),
  vec4(0.6352, 0.8000, 0.0666, 0.5019),
  vec4(0.6509, 0.8196, 0.0666, 0.5019),
  vec4(0.6509, 0.8196, 0.0666, 0.5019),
  vec4(0.6392, 0.8039, 0.0666, 0.5019),
  vec4(0.6274, 0.7921, 0.0666, 0.5019),
  vec4(0.6156, 0.7764, 0.0666, 0.5019),
  vec4(0.6078, 0.7647, 0.0705, 0.5019),
  vec4(0.5960, 0.7490, 0.0705, 0.5019),
  vec4(0.5843, 0.7372, 0.0705, 0.5019),
  vec4(0.5647, 0.7098, 0.0745, 0.5019),
  vec4(0.5647, 0.7098, 0.0745, 0.5019),
  vec4(0.5647, 0.7098, 0.0745, 0.5019),
  vec4(0.5647, 0.7098, 0.0745, 0.5019),
  vec4(0.5647, 0.7098, 0.0745, 0.5019),
  vec4(0.5647, 0.7098, 0.0745, 0.5019),
  vec4(0.5647, 0.7098, 0.0745, 0.5019),
  vec4(0.5647, 0.7098, 0.0745, 0.5019),
  vec4(0.5647, 0.7098, 0.0745, 0.5019)
);

void main() {
  if (enable_tex == 1) {
    vec4 tex_color = texture(tex_T0, uv);
    vec4 unscambled_tex = vec4(tex_color[channel_scramble[0]],
    tex_color[channel_scramble[1]],
    tex_color[channel_scramble[2]],
    tex_color[channel_scramble[3]]);
    color = rgba / 128.;
    if (tcc == 1) {
      color *= unscambled_tex;
    } else {
      color.xyz *= unscambled_tex.xyz;
    }
  } else if (enable_tex == 2) {
    // cloud version
    vec4 tex_color = texture(tex_T0, uv);
    color.x = 0.5;
    color.y = 0.5;
    color.z = 0.5;
    color.a = 0.5 * cloud_lookup(tex_color.r, minimum, maximum);
  } else if (enable_tex == 3) {
    // cloud version
    vec4 tex_color = texture(tex_T0, uv + vec2(0, slime_scroll));
    color = slime_lut[int(tex_color.r * 255.f)];
  } else {
    color = (rgba / 128.);
  }
  color.a *= alpha_multiply;
}