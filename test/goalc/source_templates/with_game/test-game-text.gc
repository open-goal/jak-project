
(start-test "game-text")

(defun hack-load ()
  (declare (inline))
  (str-load "0TEST.TXT" 
            -1 
            (the pointer (align64 (-> *common-text-heap* current))) 
            ; note, this max size is probably wrong because of the alignment.
            (the int (&- (-> *common-text-heap* top) (-> *common-text-heap* current)))
            )
  (sync *load-str-rpc* '#t)
  (let ((result (the load-chunk-msg (pop-last-received *load-str-rpc*))))
    (link (the pointer (align64 (-> *common-text-heap* current))) 
          (-> "test" data)
          (the int (-> result maxlen))
          *common-text-heap*
          0
          )
    )
  )

;(let ((text (the game-text-info (load "$ISO/0TEST.TXT" *common-text-heap*))))
(let ((text (the game-text-info (hack-load))))
  (format 0 "~I~%" text)
  (expect-true (= #x123 (-> text data 0 id)))
  (expect-true (= #x456 (-> text data 1 id)))
  (expect-true (= #\e (-> text data 1 text data 1)))
  (expect-true (= 5 (-> text data 1 text allocated-length)))
  (expect-true (= 5 (length (-> text data 1 text))))
  )

(finish-test)