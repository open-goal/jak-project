;;-*-Lisp-*-
(in-package goal)

;; definition of type precura-states
(deftype precura-states (structure)
  ((pulse          pulse-state  :inline)
   (generator      pulse-state  :inline)
   (main           float)
   (target-laser   float        2)
   (current-laser  float        2)
   (speed-laser    float)
   (target-bomb    float)
   (current-bomb   float)
   (speed-bomb     float)
   )
  )

;; definition for method 3 of type precura-states
(defmethod inspect ((this precura-states))
  (when (not this)
    (set! this this)
    (goto cfg-4)
    )
  (format #t "[~8x] ~A~%" this 'precura-states)
  (format #t "~1Tpulse: #<pulse-state @ #x~X>~%" (-> this pulse))
  (format #t "~1Tgenerator: #<pulse-state @ #x~X>~%" (-> this generator))
  (format #t "~1Tmain: ~f~%" (-> this main))
  (format #t "~1Ttarget-laser[2] @ #x~X~%" (-> this target-laser))
  (format #t "~1Tcurrent-laser[2] @ #x~X~%" (-> this current-laser))
  (format #t "~1Tspeed-laser: ~f~%" (-> this speed-laser))
  (format #t "~1Ttarget-bomb: ~f~%" (-> this target-bomb))
  (format #t "~1Tcurrent-bomb: ~f~%" (-> this current-bomb))
  (format #t "~1Tspeed-bomb: ~f~%" (-> this speed-bomb))
  (label cfg-4)
  this
  )

;; definition for function init-mood-precura
(defun init-mood-precura ((arg0 mood-context))
  (let ((v1-0 (-> arg0 state)))
    (set! (-> v1-0 1) (the-as uint 1.0))
    (set! (-> v1-0 2) (the-as uint 1.0))
    (set! (-> v1-0 3) (the-as uint 1.0))
    (set! (-> v1-0 5) (the-as uint 1.0))
    (set! (-> v1-0 6) (the-as uint 1.0))
    (let ((f0-5 2.0))
      (set! (-> v1-0 7) (the-as uint f0-5))
      f0-5
      )
    )
  )

;; definition for function update-precura-lights
;; WARN: Return type mismatch float vs none.
(defun update-precura-lights ((arg0 mood-context))
  (let ((v1-0 (-> arg0 light-group)))
    (let ((a0-1 (-> v1-0 0)))
      (set! (-> a0-1 dir0 direction x) 0.0)
      (set! (-> a0-1 dir0 direction y) 1.0)
      (set! (-> a0-1 dir0 direction z) 0.0)
      (set! (-> a0-1 dir0 direction w) 0.0)
      )
    (set-vector! (-> v1-0 0 dir0 color) 0.5 0.667 0.667 1.0)
    (set-vector! (-> v1-0 0 ambi color) 0.25 0.333 0.333 1.0)
    (set! (-> v1-0 0 dir0 extra x) 1.0)
    (set! (-> v1-0 0 dir1 extra x) 0.0)
    (set! (-> v1-0 0 dir2 extra x) 0.0)
    (set! (-> v1-0 0 ambi extra x) 1.0)
    )
  (none)
  )

;; definition for function update-mood-precura
;; WARN: Return type mismatch int vs none.
(defbehavior update-mood-precura time-of-day-proc ((arg0 mood-context) (arg1 float) (arg2 int))
  (update-mood-interior arg0 #f)
  (update-precura-lights arg0)
  (cond
    ((< (the-as uint 8) (the-as uint (-> *time-of-day-context* mode)))
     (palette-select-special arg0)
     )
    (else
      (let ((gp-0 (the-as object (-> arg0 state))))
        (set! (-> arg0 times 0 w) 1.0)
        (update-mood-pulse arg0 1 0 1.0 0.25 (* 65536.0 (seconds-per-frame)) 0.0)
        (update-mood-pulse arg0 4 16 1.0 0.125 (* 65536.0 (seconds-per-frame)) 0.0)
        (set! (-> arg0 times 2 w) 1.0)
        (let* ((v1-10 (-> *display* part-clock frame-counter))
               (f0-7 (* 218.45334 (the float (mod v1-10 300))))
               )
          (set! (-> arg0 times 3 w) (+ 0.875 (* 0.175 (cos f0-7))))
          )
        (set! (-> arg0 times 5 w) (-> (the-as precura-states gp-0) current-bomb))
        (set! (-> arg0 times 6 w) (-> (the-as precura-states gp-0) current-laser 0))
        (set! (-> arg0 times 7 w) (-> (the-as precura-states gp-0) current-laser 1))
        (when (not (paused?))
          (seek!
            (-> (the-as precura-states gp-0) current-bomb)
            (-> (the-as precura-states gp-0) target-bomb)
            (-> (the-as precura-states gp-0) speed-bomb)
            )
          (seek!
            (-> (the-as precura-states gp-0) current-laser 0)
            (-> (the-as precura-states gp-0) target-laser 0)
            (-> (the-as precura-states gp-0) speed-laser)
            )
          (seek!
            (-> (the-as precura-states gp-0) current-laser 1)
            (-> (the-as precura-states gp-0) target-laser 1)
            (-> (the-as precura-states gp-0) speed-laser)
            )
          )
        )
      )
    )
  0
  (none)
  )

;; definition for function set-precura-generator-light!
;; WARN: Return type mismatch float vs none.
(defun set-precura-generator-light! ((arg0 float))
  (let ((v1-1 (level-get *level* 'precura)))
    (when v1-1
      (let ((v1-2 (the-as object (-> v1-1 mood-context state))))
        (set! (-> (the-as precura-states v1-2) generator target-brightness) arg0)
        )
      )
    )
  (none)
  )

;; definition for function set-precura-laser-light!
;; WARN: Return type mismatch float vs none.
(defun set-precura-laser-light! ((arg0 float) (arg1 float) (arg2 int))
  (let ((v1-1 (level-get *level* 'precura)))
    (when v1-1
      (let ((v1-2 (the-as object (-> v1-1 mood-context state))))
        (set! (-> (the-as precura-states v1-2) target-laser arg2) arg0)
        (set! (-> (the-as precura-states v1-2) speed-laser) arg1)
        (if (= arg1 0.0)
            (set! (-> (the-as precura-states (+ (* arg2 4) (the-as int v1-2))) current-laser 0) arg0)
            )
        )
      )
    )
  (none)
  )

;; definition for function set-precura-bomb-light!
;; WARN: Return type mismatch float vs none.
(defun set-precura-bomb-light! ((arg0 float) (arg1 float))
  (let ((v1-1 (level-get *level* 'precura)))
    (when v1-1
      (let ((v1-2 (the-as object (-> v1-1 mood-context state))))
        (set! (-> (the-as precura-states v1-2) target-bomb) arg0)
        (set! (-> (the-as precura-states v1-2) speed-bomb) arg1)
        )
      )
    )
  (none)
  )

;; definition of type precurb-states
(deftype precurb-states (structure)
  ((pulse  pulse-state  :inline)
   (main   float)
   )
  )

;; definition for method 3 of type precurb-states
(defmethod inspect ((this precurb-states))
  (when (not this)
    (set! this this)
    (goto cfg-4)
    )
  (format #t "[~8x] ~A~%" this 'precurb-states)
  (format #t "~1Tpulse: #<pulse-state @ #x~X>~%" (-> this pulse))
  (format #t "~1Tmain: ~f~%" (-> this main))
  (label cfg-4)
  this
  )

;; definition for function init-mood-precurb
(defun init-mood-precurb ((arg0 mood-context))
  (let ((v1-0 (-> arg0 state)))
    (set! (-> v1-0 1) (the-as uint 1.0))
    (set! (-> v1-0 2) (the-as uint 1.0))
    (let ((f0-2 1.0))
      (set! (-> v1-0 3) (the-as uint f0-2))
      f0-2
      )
    )
  )

;; definition for function update-mood-precurb
;; WARN: Return type mismatch int vs none.
(defbehavior update-mood-precurb time-of-day-proc ((arg0 mood-context) (arg1 float) (arg2 int))
  (update-mood-interior arg0 #f)
  (update-precura-lights arg0)
  (cond
    ((< (the-as uint 8) (the-as uint (-> *time-of-day-context* mode)))
     (palette-select-special arg0)
     )
    (else
      (-> arg0 state)
      (set! (-> arg0 times 0 w) 1.0)
      (update-mood-pulse arg0 1 0 1.0 0.25 (* 65536.0 (seconds-per-frame)) 0.0)
      (set! (-> arg0 times 2 w) 1.0)
      (let* ((v1-9 (-> *display* part-clock frame-counter))
             (f0-5 (* 218.45334 (the float (mod v1-9 300))))
             )
        (set! (-> arg0 times 3 w) (+ 0.875 (* 0.175 (cos f0-5))))
        )
      (set! (-> arg0 times 4 w) 1.0)
      (set! (-> arg0 times 5 w) 1.0)
      (set! (-> arg0 times 6 w) 1.0)
      (set! (-> arg0 times 7 w) 1.0)
      )
    )
  0
  (none)
  )

;; definition of type lprecurc-loader
(deftype lprecurc-loader (process)
  ()
  (:state-methods
    idle
    die
    )
  )

;; definition for method 3 of type lprecurc-loader
(defmethod inspect ((this lprecurc-loader))
  (when (not this)
    (set! this this)
    (goto cfg-68)
    )
  (format #t "[~8x] ~A~%" this (-> this type))
  (format #t "~1Tname: ~A~%" (-> this name))
  (format #t "~1Tmask: #x~X : (process-mask " (-> this mask))
  (let ((s5-0 (-> this mask)))
    (if (= (logand s5-0 (process-mask process-tree)) (process-mask process-tree))
        (format #t "process-tree ")
        )
    (if (= (logand s5-0 (process-mask target)) (process-mask target))
        (format #t "target ")
        )
    (if (= (logand (process-mask collectable) s5-0) (process-mask collectable))
        (format #t "collectable ")
        )
    (if (= (logand (process-mask projectile) s5-0) (process-mask projectile))
        (format #t "projectile ")
        )
    (if (= (logand s5-0 (process-mask sleep-code)) (process-mask sleep-code))
        (format #t "sleep-code ")
        )
    (if (= (logand s5-0 (process-mask actor-pause)) (process-mask actor-pause))
        (format #t "actor-pause ")
        )
    (if (= (logand (process-mask metalhead) s5-0) (shl #x8000 16))
        (format #t "metalhead ")
        )
    (if (= (logand (process-mask bot) s5-0) (process-mask bot))
        (format #t "bot ")
        )
    (if (= (logand (process-mask vehicle) s5-0) (process-mask vehicle))
        (format #t "vehicle ")
        )
    (if (= (logand (process-mask enemy) s5-0) (process-mask enemy))
        (format #t "enemy ")
        )
    (if (= (logand (process-mask entity) s5-0) (process-mask entity))
        (format #t "entity ")
        )
    (if (= (logand s5-0 (process-mask heap-shrunk)) (process-mask heap-shrunk))
        (format #t "heap-shrunk ")
        )
    (if (= (logand (process-mask sidekick) s5-0) (process-mask sidekick))
        (format #t "sidekick ")
        )
    (if (= (logand s5-0 (process-mask going)) (process-mask going))
        (format #t "going ")
        )
    (if (= (logand s5-0 (process-mask execute)) (process-mask execute))
        (format #t "execute ")
        )
    (if (= (logand (process-mask civilian) s5-0) (process-mask civilian))
        (format #t "civilian ")
        )
    (if (= (logand (process-mask death) s5-0) (process-mask death))
        (format #t "death ")
        )
    (if (= (logand (process-mask guard) s5-0) (process-mask guard))
        (format #t "guard ")
        )
    (if (= (logand s5-0 (process-mask no-kill)) (process-mask no-kill))
        (format #t "no-kill ")
        )
    (if (= (logand (process-mask kg-robot) s5-0) (process-mask kg-robot))
        (format #t "kg-robot ")
        )
    (if (= (logand (process-mask platform) s5-0) (process-mask platform))
        (format #t "platform ")
        )
    (if (= (logand s5-0 (process-mask freeze)) (process-mask freeze))
        (format #t "freeze ")
        )
    (if (= (logand s5-0 (process-mask sleep)) (process-mask sleep))
        (format #t "sleep ")
        )
    (if (= (logand s5-0 (process-mask progress)) (process-mask progress))
        (format #t "progress ")
        )
    (if (= (logand s5-0 (process-mask menu)) (process-mask menu))
        (format #t "menu ")
        )
    (if (= (logand (process-mask camera) s5-0) (process-mask camera))
        (format #t "camera ")
        )
    (if (= (logand (process-mask ambient) s5-0) (process-mask ambient))
        (format #t "ambient ")
        )
    (if (= (logand s5-0 (process-mask dark-effect)) (process-mask dark-effect))
        (format #t "dark-effect ")
        )
    (if (= (logand (process-mask crate) s5-0) (process-mask crate))
        (format #t "crate ")
        )
    (if (= (logand s5-0 (process-mask kernel-run)) (process-mask kernel-run))
        (format #t "kernel-run ")
        )
    (if (= (logand s5-0 (process-mask movie)) (process-mask movie))
        (format #t "movie ")
        )
    (if (= (logand s5-0 (process-mask pause)) (process-mask pause))
        (format #t "pause ")
        )
    )
  (format #t ")~%")
  (format #t "~1Tclock: ~A~%" (-> this clock))
  (format #t "~1Tparent: #x~X~%" (-> this parent))
  (format #t "~1Tbrother: #x~X~%" (-> this brother))
  (format #t "~1Tchild: #x~X~%" (-> this child))
  (format #t "~1Tppointer: #x~X~%" (-> this ppointer))
  (format #t "~1Tself: ~A~%" (-> this self))
  (format #t "~1Tpool: ~A~%" (-> this pool))
  (format #t "~1Tstatus: ~A~%" (-> this status))
  (format #t "~1Tpid: ~D~%" (-> this pid))
  (format #t "~1Tmain-thread: ~A~%" (-> this main-thread))
  (format #t "~1Ttop-thread: ~A~%" (-> this top-thread))
  (format #t "~1Tentity: ~A~%" (-> this entity))
  (format #t "~1Tlevel: ~A~%" (-> this level))
  (format #t "~1Tstate: ~A~%" (-> this state))
  (format #t "~1Tprev-state: ~A~%" (-> this prev-state))
  (format #t "~1Tnext-state: ~A~%" (-> this next-state))
  (format #t "~1Tstate-stack: ~A~%" (-> this state-stack))
  (format #t "~1Ttrans-hook: ~A~%" (-> this trans-hook))
  (format #t "~1Tpost-hook: ~A~%" (-> this post-hook))
  (format #t "~1Tevent-hook: ~A~%" (-> this event-hook))
  (format #t "~1Tallocated-length: ~D~%" (-> this allocated-length))
  (format #t "~1Theap-base: #x~X~%" (-> this heap-base))
  (format #t "~1Theap-top: #x~X~%" (-> this heap-top))
  (format #t "~1Theap-cur: #x~X~%" (-> this heap-cur))
  (format #t "~1Tstack-frame-top: ~A~%" (-> this stack-frame-top))
  (format #t "~1Theap: #<kheap @ #x~X>~%" (&-> this heap-base))
  (format #t "~1Tconnection-list: ~`connectable`P~%" (-> this connection-list))
  (format #t "~1Tstack[0] @ #x~X~%" (-> this stack))
  (label cfg-68)
  this
  )

;; failed to figure out what this is:
(defstate idle (lprecurc-loader)
  :virtual #t
  :event (behavior ((proc process) (argc int) (message symbol) (block event-message-block))
    (case message
      (('deactivate)
       (go-virtual die)
       )
      )
    )
  :enter (behavior ()
    (set-setting! 'borrow '((precurc 0 lprecurc copy)) 0.0 0)
    (apply-settings *setting-control*)
    )
  :exit (behavior ()
    (remove-setting! 'borrow)
    (apply-settings *setting-control*)
    )
  :code sleep-code
  )

;; failed to figure out what this is:
(defstate die (lprecurc-loader)
  :virtual #t
  :code (behavior ()
    '()
    )
  )

;; definition for function lprecurc-loader-init-by-other
(defbehavior lprecurc-loader-init-by-other lprecurc-loader ((arg0 level))
  (set! (-> self level) arg0)
  (go-virtual idle)
  )

;; definition for function precura-login
;; WARN: Return type mismatch int vs none.
(defun precura-login ((arg0 level))
  (set! *nav-network* (new 'loading-level 'nav-network))
  (alloc-nav-network-for-level! *nav-network* 64 10)
  0
  (none)
  )

;; definition for function precura-activate
(defun precura-activate ((arg0 level))
  (persist-with-delay
    *setting-control*
    'precur-activate
    (the-as time-frame (the-as uint #xb2d05e00))
    'sky-type
    'star-field
    0.0
    0
    )
  (process-spawn lprecurc-loader arg0 :name "lprecurc-loader" :to *entity-pool*)
  (if (and (nonzero? *nav-network*) *nav-network*)
      (init-by-other! *nav-network* arg0 *precura-adjacency*)
      )
  (none)
  )

;; definition for function precura-deactivate
(defun precura-deactivate ((arg0 level))
  (persist-with-delay *setting-control* 'precur-activate 0 'sky-type #f 0.0 0)
  (none)
  )

;; definition for function precura-logout
;; WARN: Return type mismatch int vs none.
(defun precura-logout ((arg0 level))
  (set! *nav-network* (the-as nav-network 0))
  0
  (none)
  )




