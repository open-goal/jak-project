;;-*-Lisp-*-
(in-package goal)

;; definition of type collide-history
(deftype collide-history (structure)
  ((intersect      vector                :inline :offset-assert   0)
   (trans          vector                :inline :offset-assert  16)
   (transv         vector                :inline :offset-assert  32)
   (transv-out     vector                :inline :offset-assert  48)
   (local-normal   vector                :inline :offset-assert  64)
   (surface-normal vector                :inline :offset-assert  80)
   (time           time-frame                    :offset-assert  96)
   (status         cshape-moving-flags           :offset-assert 104)
   (pat            pat-surface                   :offset-assert 112)
   (reaction-flag  cshape-reaction-flags         :offset-assert 116)
   )
  :method-count-assert 10
  :size-assert         #x78
  :flag-assert         #xa00000078
  (:methods
    (update! (_type_ collide-shape-moving vector vector vector) _type_ 9)
    )
  )

;; definition for method 3 of type collide-history
(defmethod inspect collide-history ((obj collide-history))
  (format #t "[~8x] ~A~%" obj 'collide-history)
  (format #t "~Tintersect: ~`vector`P~%" (-> obj intersect))
  (format #t "~Ttrans: ~`vector`P~%" (-> obj trans))
  (format #t "~Ttransv: ~`vector`P~%" (-> obj transv))
  (format #t "~Ttransv-out: ~`vector`P~%" (-> obj transv-out))
  (format #t "~Tlocal-normal: ~`vector`P~%" (-> obj local-normal))
  (format #t "~Tsurface-normal: ~`vector`P~%" (-> obj surface-normal))
  (format #t "~Ttime: ~D~%" (-> obj time))
  (format #t "~Tstatus: ~D~%" (-> obj status))
  (format #t "~Tpat: ~D~%" (-> obj pat))
  (format #t "~Treaction-flag: ~D~%" (-> obj reaction-flag))
  obj
  )

;; definition of type control-info
(deftype control-info (collide-shape-moving)
  ((ltransv                   vector                    :inline     :offset        448)
   (trans-targ                vector                    :inline     :offset        464)
   (normal-targ               vector                    :inline     :offset        480)
   (quat-targ                 quaternion                :inline     :offset        496)
   (quat-base                 quaternion                :inline     :offset        512)
   (quat-mod                  float                                 :offset        528)
   (speed-mod                 float                                 :offset        532)
   (thrust-length             float                                 :offset        536)
   (last-transv               vector                    :inline     :offset        544)
   (racer-cushion-targ        vector                    :inline     :offset        560)
   (racer-cushion             vector                    :inline     :offset        576)
   (collide-offset            vector                    :inline     :offset        592)
   (unknown-vector14          vector                    :inline     :offset        608)
   (unknown-vector15          vector                    :inline     :offset        624)
   (unknown-vector16          vector                    :inline     :offset        640)
   (cur-dynam                 dynamics                              :offset        656)
   (cur-surf                  surface                               :offset        660)
   (new-surf                  surface                               :offset        664)
   (cpad                      cpad-info                             :offset        668)
   (turn-vec-deg              float                                 :offset        672)
   (last-turn-vec-deg         float                                 :offset        676)
   (turn-vec-len              float                                 :offset        680)
   (last-turn-vec-len         float                                 :offset        684)
   (unknown-vector20          vector                    :inline     :offset        688)
   (unknown-vector21          vector                    :inline     :offset        704)
   (unknown-vector22          vector                    :inline     :offset        720)
   (unknown-vector23          vector                    :inline     :offset        736)
   (unknown-vector-array00    vector                    7 :inline   :offset        752)
   (stick-vec                 vector                    :inline     :offset        880)
   (last-stick-vec            vector                    :inline     :offset        896)
   (pad-stick-speed           float                                 :offset        912)
   (last-pad-stick-speed      float                                 :offset        916)
   (pad-read-time             time-frame                            :offset        920)
   (unknown-matrix00          matrix                    :inline     :offset        928)
   (unknown-matrix01          matrix                    :inline     :offset        992)
   (unknown-matrix02          matrix                    :inline     :offset        1056)
   (unknown-qword00           uint128                               :offset        1136)
   (swim-y-offset             float                                 :offset        1140)
   (force-push-transv         vector                    :inline     :offset        1152)
   (force-push-speed          float                                 :offset        1172)
   (force-push-speed-mod      float                                 :offset        1176)
   (tongues-pulling           int32                                 :offset        1180)
   (tongue-pull-force         float                                 :offset        1168)
   (gravity-normal            vector                    :inline     :offset        1184)
   (last-gravity-normal       vector                    :inline     :offset        1200)
   (last-air-trans            vector                    :inline     :offset        1216)
   (ground-normal             vector                    :inline     :offset        1232)
   (last-known-safe-ground    vector                    :inline     :offset        1248)
   (ground-prim-sphere        vector                    :inline     :offset        1264)
   (ground-time               time-frame                            :offset        1280)
   (last-ground-time          time-frame                            :offset        1288)
   (ground-slope              float                                 :offset        1300)
   (tween-input               float                                 :offset        1304)
   (tween-output              float                                 :offset        1308)
   (surface-slope-x           float                                 :offset        1312)
   (surface-slope-z           float                                 :offset        1316)
   (moving-surf-touch-time    time-frame                            :offset        1320)
   (low-coverage-touch-time   time-frame                            :offset        1328)
   (low-coverage-time         time-frame                            :offset        1336)
   (unknown-float-coverage-0  float                                 :offset        1344)
   (unknown-float-coverage-1  float                                 :offset        1348)
   (unknown-float-coverage-2  float                                 :offset        1352)
   (unknown-u32-coverage-0    uint32                                :offset        1356)
   (unknown-vector-coverage-0 vector                    :inline     :offset        1376)
   (unknown-vector-coverage-1 vector                    :inline     :offset        1392)
   (unknown-vector-coverage-2 vector                    :inline     :offset        1440)
   (unknown-vector-coverage-3 vector                    :inline     :offset        1472)
   (unknown-vector60          vector                    :inline     :offset        1456)
   (btransv                   vector                    :inline     :offset        1504)
   (unknown-float70           float                                 :offset        1520)
   (unknown-float71           float                                 :offset        1524)
   (wall-intersect            vector                    :inline     :offset        1536)
   (wall-normal               vector                    :inline     :offset        1552)
   (best-cshape-intersect     vector                    :inline     :offset        1568)
   (best-cshape-normal        vector                    :inline     :offset        1584)
   (best-cshape-handle        handle                                :offset        1600)
   (body-spheres              collide-shape-prim-sphere 3           :offset        1608)
   (unknown-sphere00          collide-shape-prim-sphere             :offset        1632)
   (unknown-sphere01          collide-shape-prim-sphere             :offset        1636)
   (unknown-sphere02          collide-shape-prim-sphere             :offset        1640)
   (wheel-amount              int32                                 :offset        1656)
   (wheel-exit-time           time-frame                            :offset        1664)
   (hands-used-time           time-frame                            :offset        1672)
   (hands-fail-time           time-frame                            :offset        1680)
   (feet-used-time            time-frame                            :offset        1688)
   (feet-fail-time            time-frame                            :offset        1696)
   (slide-time                time-frame                            :offset        1704)
   (stuck-time                time-frame                            :offset        1712)
   (bend                      float                                 :offset        1724)
   (bend-target               float                                 :offset        1728)
   (bend-speed                float                                 :offset        1732)
   (unknown-vector80          vector                    :inline     :offset        1744)
   (unknown-cspace00          cspace                    :inline     :offset        1760)
   (unknown-vector90          vector                    :inline     :offset        1776)
   (unknown-vector91          vector                    :inline     :offset        1792)
   (unknown-vector92          vector                    :inline     :offset        1824)
   (unknown-cspace10          cspace                    :inline     :offset        1808)
   (unknown-symbol00          symbol                                :offset        1840)
   (unknown-float90           float                                 :offset        1844)
   (unknown-float91           float                                 :offset        1848)
   (unknown-vector-array10    vector                    16 :inline  :offset        1856)
   (unknown-float100          float                                 :offset        2112)
   (unknown-int10             int32                                 :offset        2116)
   (unknown-float110          float                                 :offset        2120)
   (unknown-vector100         vector                    :inline     :offset        2128)
   (unknown-vector101         vector                    :inline     :offset        2144)
   (edge-time                 time-frame                            :offset        2160)
   (edge-grab-time            time-frame                            :offset        2168)
   (pole                      handle                                :offset        2176)
   (temp-flop-end-checks      uint32                                :offset        2184)
   (temp-spool                spool-anim                            :offset        2184)
   (temp-jump-height-min      float                                 :offset        2184)
   (temp-death-gravity        float                                 :offset        2184)
   (temp-mode                 symbol                                :offset        2184)
   (temp-yellow-time          uint32                                :offset        2188)
   (temp-jump-height-max      float                                 :offset        2188)
   (temp-target-speed         float                                 :offset        2188)
   (temp-pole-close-enough    symbol                                :offset        2188)
   (temp-touched-enemy        uint32                                :offset        2192)
   (temp-high-jump-mode       symbol                                :offset        2192)
   (jump-frame-interp         float                                 :offset        2196)
   (unknown-float123          float                                 :offset        2200)
   (unknown-float124          float                                 :offset        2204)
   (jump-trans                vector                    :inline     :offset        2224)
   (jump-trans-targ           vector                    :inline     :offset        2240)
   (racer-get-on-base         quaternion                :inline     :offset        2256)
   (racer-get-on-targ         quaternion                :inline     :offset        2272)
   (smush                     smush-control             :inline     :offset        2288)
   (last-ground-trans         vector                    :inline     :offset        2320)
   (cur-air-trans             vector                    :inline     :offset        2336)
   (danger-mode               symbol                                :offset        2384)
   (current-attack-id         int64                                 :offset        2392)
   (eco-pill-bonus            int64                                 :offset        2400)
   (launch-event-block        event-message-block       :inline     :offset        2416)
   (collide-history-index     int16                                 :offset        2488)
   (collide-history-length    int16                                 :offset        2490)
   (collide-history           collide-history           128 :inline :offset-assert 2496)
   (unknown-float140          float                                 :offset        18944)
   (wall-fric-time            time-frame                            :offset        18952)
   (unknown-int40             int32                                 :offset        18880)
   (invulnerable-time         time-frame                            :offset        18888)
   (invulnerable-duration     time-frame                            :offset        18896)
   (swim-angle                float                                 :offset        18904)
   (swim-bob-targ             float                                 :offset        18908)
   (yellow-blast-time         time-frame                            :offset        18912)
   (unknown-vector120         vector                    :inline     :offset        18928)
   (unknown-vector121         vector                    :inline     :offset        18960)
   (wall-pat                  pat-surface                           :offset        18976)
   (sound-ice                 sound-id                              :offset        18980)
   (unknown-float141          float                                 :offset        18984)
   (sounds                    sound-id                  4           :offset        18988)
   (sound-launch              sound-id                              :offset        18988)
   )
  :method-count-assert 65
  :size-assert         #x4a3c
  :flag-assert         #x4100004a3c
  )

;; definition for method 9 of type collide-history
;; Used lq/sq
(defmethod update! collide-history ((obj collide-history) (cshape collide-shape-moving) (xs vector) (transv vector) (transv-out vector))
  (set! (-> obj intersect quad) (-> xs quad))
  (set! (-> obj transv quad) (-> transv quad))
  (set! (-> obj transv-out quad) (-> transv-out quad))
  (set! (-> obj trans quad) (-> cshape trans quad))
  (set! (-> obj local-normal quad) (-> cshape local-normal quad))
  (set! (-> obj surface-normal quad) (-> cshape surface-normal quad))
  (set! (-> obj time) (-> *display* base-frame-counter))
  (set! (-> obj status) (-> cshape status))
  (set! (-> obj reaction-flag) (-> cshape reaction-flag))
  (set! (-> obj pat) (-> cshape cur-pat))
  obj
  )
